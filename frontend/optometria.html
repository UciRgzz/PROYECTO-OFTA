<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Optometría</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f5ff; padding: 20px; }
    .container { max-width: 1400px; margin: auto; }
    header { text-align: center; margin-bottom: 25px; padding: 15px; background: linear-gradient(135deg,#2c3e50 0%,#3498db 100%); color: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    header h1 { margin: 0; font-size: 2rem; }

    .card { background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 30px; overflow: hidden; }
    .card-header { background: #2c3e50; color: #fff; padding: 15px 20px; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }

    .custom-header {
        background: #2c3e50; /* mismo color que Buscar / Nueva Evaluación */
      }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; font-size: 0.9rem; }
    th { background: #f8f9fa; color: #2c3e50; font-weight: 600; }
    tr:nth-child(odd) { background: #f9f9f9; }
    tr:hover { background-color: #eef6ff; }

    .btn-primary { background: #3498db; border: none; }
    .btn-primary:hover { background: #2980b9; }
    .btn-success { background: #27ae60; border: none; }
    .btn-success:hover { background: #219653; }
    .btn-secondary { background: #95a5a6; border: none; }
    .btn-secondary:hover { background: #7f8c8d; }
    .btn-danger { background: #e74c3c; border: none; }
    .btn-danger:hover { background: #c0392b; }

    .form-control, .form-select { border-radius: 6px; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-eye"></i> Gestión de Optometría</h1>
    </header>

    <!-- Buscador -->
    <div class="card">
      <div class="card-header"><i class="fas fa-search"></i> Buscar / Nueva Evaluación</div>
      <div class="card-body d-flex justify-content-between align-items-center">
        <input type="text" id="buscarOpto" class="form-control w-50" placeholder="Buscar por expediente o nombre">
        <button id="btnNuevo" class="btn btn-primary"><i class="fas fa-plus"></i> Nueva Evaluación</button>
      </div>
    </div>

    <!-- Formulario -->
    <div id="formularioOpto" style="display:none;"></div>

    <!-- Tabla -->
    <div id="tablaOpto"></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  async function cargarOptometrias() {
    const res = await fetch("/api/optometria");
    const data = await res.json();
    let html = `
      <div class="card">
        <div class="card-header"><i class="fas fa-list"></i> Registros de Optometría</div>
        <div class="card-body table-responsive">
          <table class="table table-bordered text-center align-middle">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Expediente</th>
                <th>Nombre</th>
                <th>OD Esfera</th>
                <th>OD Cilindro</th>
                <th>OD Eje</th>
                <th>OD AVcC</th>
                <th>OD Adición</th>
                <th>OD AVcC2</th>
                <th>OI Esfera</th>
                <th>OI Cilindro</th>
                <th>OI Eje</th>
                <th>OI AVcC</th>
                <th>OI Adición</th>
                <th>OI AVcC2</th>
                <th>BMP</th>
                <th>BMP OD</th>
                <th>BMP OI</th>
                <th>F.O</th>
                <th>F.O OD</th>
                <th>F.O OI</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
    `;
    data.forEach(o => {
      html += `
        <tr>
          <td>${o.id}</td>
          <td>${o.expediente_id}</td>
          <td>${o.nombre}</td>
          <td>${o.esfera_od || ""}</td>
          <td>${o.cilindro_od || ""}</td>
          <td>${o.eje_od || ""}</td>
          <td>${o.avcc_od || ""}</td>
          <td>${o.adicion_od || ""}</td>
          <td>${o.avcc2_od || ""}</td>
          <td>${o.esfera_oi || ""}</td>
          <td>${o.cilindro_oi || ""}</td>
          <td>${o.eje_oi || ""}</td>
          <td>${o.avcc_oi || ""}</td>
          <td>${o.adicion_oi || ""}</td>
          <td>${o.avcc2_oi || ""}</td>
          <td>${o.bmp || ""}</td>
          <td>${o.bmp_od || ""}</td>
          <td>${o.bmp_oi || ""}</td>
          <td>${o.fo || ""}</td>
          <td>${o.fo_od || ""}</td>
          <td>${o.fo_oi || ""}</td>
          <td>${new Date(o.fecha).toLocaleString()}</td>
          <td><button class="btn btn-danger btn-sm" onclick="borrarOpto(${o.id})"><i class="fas fa-trash"></i></button></td>
        </tr>
      `;
    });
    html += `</tbody></table></div></div>`;
    document.getElementById("tablaOpto").innerHTML = html;
  }

  document.getElementById("btnNuevo").addEventListener("click", () => {
    document.getElementById("formularioOpto").style.display = "block";
    document.getElementById("tablaOpto").style.display = "none";
    
    document.getElementById("formularioOpto").innerHTML = `
  <div class="card shadow">
    <div class="card-header custom-header text-white"><i class="fas fa-plus-circle"></i> Nueva Evaluación</div>
    <div class="card-body">
      <form id="formOptometria">
        <div class="mb-3">
          <label class="form-label">Número de Expediente</label>
          <input type="number" name="expediente_id" class="form-control" required>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered text-center align-middle">
            <thead class="table-light">
              <tr>
                <th rowspan="2">SUBJETIVA</th>
                <th>Esferas</th>
                <th>Cilindros</th>
                <th>Eje</th>
                <th>AV cC</th>
                <th>Adición</th>
                <th>AV cC2</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>OD</strong></td>
                <td><input type="text" name="esfera_od" class="form-control"></td>
                <td><input type="text" name="cilindro_od" class="form-control"></td>
                <td><input type="text" name="eje_od" class="form-control"></td>
                <td><input type="text" name="avcc_od" class="form-control"></td>
                <td><input type="text" name="adicion_od" class="form-control"></td>
                <td><input type="text" name="avcc2_od" class="form-control"></td>
              </tr>
              <tr>
                <td><strong>OI</strong></td>
                <td><input type="text" name="esfera_oi" class="form-control"></td>
                <td><input type="text" name="cilindro_oi" class="form-control"></td>
                <td><input type="text" name="eje_oi" class="form-control"></td>
                <td><input type="text" name="avcc_oi" class="form-control"></td>
                <td><input type="text" name="adicion_oi" class="form-control"></td>
                <td><input type="text" name="avcc2_oi" class="form-control"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="row mt-4">
          <div class="col-md-2"><label class="form-label">BMP</label><input type="text" name="bmp" class="form-control"></div>
          <div class="col-md-2"><label class="form-label">BMP OD</label><input type="text" name="bmp_od" class="form-control"></div>
          <div class="col-md-2"><label class="form-label">BMP OI</label><input type="text" name="bmp_oi" class="form-control"></div>
          <div class="col-md-2"><label class="form-label">F.O</label><input type="text" name="fo" class="form-control"></div>
          <div class="col-md-2"><label class="form-label">F.O OD</label><input type="text" name="fo_od" class="form-control"></div>
          <div class="col-md-2"><label class="form-label">F.O OI</label><input type="text" name="fo_oi" class="form-control"></div>
        </div>
        <div class="mt-4 text-end">
          <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Guardar</button>
          <button type="button" class="btn btn-secondary" onclick="cancelarFormulario()"><i class="fas fa-times"></i> Cancelar</button>
        </div>
      </form>
    </div>
  </div>
`;

    document.getElementById("formOptometria").addEventListener("submit", guardarOpto);
  });

  function cancelarFormulario() {
    document.getElementById("formularioOpto").style.display = "none";
    document.getElementById("tablaOpto").style.display = "block";
  }

  async function guardarOpto(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    const res = await fetch("/api/optometria", {
      method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data)
    });
    const json = await res.json();

    if (res.ok) {
      Swal.fire({ icon: 'success', title: 'Guardado', text: json.mensaje || 'Evaluación registrada' });
    } else {
      Swal.fire({ icon: 'error', title: 'Error', text: json.error || 'No se pudo guardar' });
    }

    cancelarFormulario();
    cargarOptometrias();
  }

  async function borrarOpto(id) {
    const confirmacion = await Swal.fire({
      icon: 'warning',
      title: '¿Eliminar este registro?',
      showCancelButton: true,
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    });

    if (!confirmacion.isConfirmed) return;

    const res = await fetch(`/api/optometria/${id}`, { method: "DELETE" });
    const json = await res.json();

    if (res.ok) {
      Swal.fire({ icon: 'success', title: 'Eliminado', text: json.mensaje || 'Registro eliminado' });
    } else {
      Swal.fire({ icon: 'error', title: 'Error', text: json.error || 'No se pudo eliminar' });
    }

    cargarOptometrias();
  }

  document.getElementById("buscarOpto").addEventListener("input", (e) => {
    const f = e.target.value.toLowerCase();
    document.querySelectorAll("#tablaOpto tbody tr").forEach(row => {
      const expediente = row.cells[1]?.innerText.toLowerCase();
      const nombre = row.cells[2]?.innerText.toLowerCase();
      row.style.display = (expediente.includes(f) || nombre.includes(f)) ? "" : "none";
    });
  });

  cargarOptometrias();
</script>

</body>
</html>
