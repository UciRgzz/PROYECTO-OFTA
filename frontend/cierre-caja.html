<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cierre de Caja</title>

<!-- Favicon (logo empresa)-->
<link rel="icon" type="image/png" href="/uploads/logo-oftavision2.png">

<!-- Bootstrap y FontAwesome -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Librería Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: #f0f5ff;
    padding: 20px;
  }

  .card {
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    overflow: hidden;
    margin-bottom: 25px;
  }

  .card-header {
    font-weight: 600;
    font-size: 1.2rem;
    padding: 15px 20px;
  }

  .card-header.bg-primary {
    background: linear-gradient(135deg, #2c3e50, #3498db);
  }

  .card-header.bg-dark {
    background: linear-gradient(135deg, #212121, #424242);
  }

  .card-header.bg-secondary {
    background: linear-gradient(135deg, #455a64, #90a4ae);
  }

  .table {
    border-radius: 8px;
    overflow: hidden;
  }

  .table thead {
    background: #2c3e50;
    color: white;
  }

  .table tbody tr:nth-child(odd) {
    background-color: #f9f9f9;
  }

  .table tbody tr:hover {
    background-color: #eef6ff;
    transition: background 0.2s;
  }

  .btn {
    font-weight: 600;
    border-radius: 6px;
  }

  .btn-success {
    background: #27ae60;
    border: none;
  }

  .btn-success:hover {
    background: #1e8449;
  }

  .btn-primary {
    background: #2980b9;
    border: none;
  }

  .btn-primary:hover {
    background: #21618c;
  }
</style>
</head>
<body>
<div class="container">
    <!-- Encabezado -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0"><i class="fas fa-cash-register me-2"></i> Cierre de Caja</h3>
        </div>
        <div class="card-body">
            <div class="row g-3 align-items-end">
               <!-- Rango de Fechas -->
                <div class="col-md-4">
                  <label for="filtroRango" class="form-label">Filtrar por fecha:</label>
                  <input type="text" id="filtroRango" class="form-control" placeholder="Selecciona un rango" readonly>
                </div>

                <div class="col-md-2">
                    <button class="btn btn-success w-100" onclick="cargarCierre()">
                        <i class="fas fa-chart-bar me-1"></i> Generar
                    </button>
                </div>

                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="exportarExcel()">
                        <i class="fas fa-file-excel me-1"></i> Exportar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen -->
    <div class="card shadow mb-4">
        <div class="card-header bg-dark text-white">
            <h4 class="mb-0"><i class="fas fa-list me-2"></i> Resumen</h4>
        </div>
        <div class="card-body">
           <table id="tablaResumen" class="table table-bordered table-hover text-center align-middle">
                <thead>
                  <tr>
                    <th>Forma de Cobro</th>
                    <th>Consulta</th>
                    <th>Cirugía</th>
                    <th>Estudios</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="tbodyResumen">
                  <tr><td colspan="5">Sin datos</td></tr>
                </tbody>
              </table>

        </div>
    </div>

    <!-- Listado de Pacientes -->
    <div class="card shadow">
        <div class="card-header bg-secondary text-white">
            <h4 class="mb-0"><i class="fas fa-users me-2"></i> Listado de Pacientes</h4>
        </div>
        <div class="card-body">
            <table id="tablaPacientesWrap" class="table table-striped table-bordered text-center align-middle">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Folio</th>
                        <th>Paciente</th>
                        <th>Procedimiento</th>
                        <th>Status</th>
                        <th>Pago</th>
                        <th>Total Folio</th>
                        <th>Saldo</th>
                    </tr>
                </thead>
                <tbody id="tablaPacientes"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Daterangepicker CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

<!-- jQuery (requerido por daterangepicker) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Moment.js + Daterangepicker JS -->
<script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

<!-- ExcelJS -->
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver"></script>


<script>
$(document).ready(() => {
  const hoy = moment().format("YYYY-MM-DD");

  $('#filtroRango').daterangepicker({
    autoUpdateInput: false,
    locale: {
      format: 'DD/MM/YYYY',
      applyLabel: "Aplicar",
      cancelLabel: "Cancelar",
      customRangeLabel: "Rango personalizado",
      daysOfWeek: ["Do","Lu","Ma","Mi","Ju","Vi","Sa"],
      monthNames: [
        "Enero","Febrero","Marzo","Abril","Mayo","Junio",
        "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
      ]
    },
    startDate: moment(),
    endDate: moment(),
    ranges: {
      'Hoy': [moment(), moment()],
      'Ayer': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
      'Últimos 7 Días': [moment().subtract(6, 'days'), moment()],
      'Últimos 30 Días': [moment().subtract(29, 'days'), moment()],
      'Este Mes': [moment().startOf('month'), moment().endOf('month')],
      'Mes Pasado': [
        moment().subtract(1, 'month').startOf('month'),
        moment().subtract(1, 'month').endOf('month')
      ]
    }
  });

  $('#filtroRango').on('apply.daterangepicker', function(ev, picker) {
    $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
    this.dataset.desde = picker.startDate.format("YYYY-MM-DD");
    this.dataset.hasta = picker.endDate.format("YYYY-MM-DD");
    cargarCierre();
  });

  // Inicializar valores por defecto (hoy), pero NO ejecutar aún
  $('#filtroRango').data('desde', hoy);
  $('#filtroRango').data('hasta', hoy);
  $('#filtroRango').val(moment().format('DD/MM/YYYY') + " - " + moment().format('DD/MM/YYYY'));
});


// Formateador global para todo el sistema y Excel (estilo español: 1.234,56)
const formato = new Intl.NumberFormat('en-US', {
  style: 'decimal',
  minimumFractionDigits: 2,
  maximumFractionDigits: 2
});


// función de cierre de caja corregida
async function cargarCierre() {
    const rango = document.getElementById("filtroRango").dataset;
    const desde = rango.desde;
    const hasta = rango.hasta;

    try {
        Swal.fire({
            title: 'Generando cierre...',
            text: 'Por favor espera',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // limpiar tablas antes de recargar
        document.getElementById("tbodyResumen").innerHTML = "<tr><td colspan='5'>Sin datos</td></tr>";
        document.getElementById("tablaPacientes").innerHTML = "";

        // ====== RESUMEN ======
        const resResumen = await fetch(`/api/cierre-caja?desde=${desde}&hasta=${hasta}`);
        const datosResumen = await resResumen.json();

        if (Array.isArray(datosResumen) && datosResumen.length > 0) {
            const procedimientos = [...new Set(datosResumen.map(d => d.procedimiento))];
            const pagos = {};
            datosResumen.forEach(d => {
                if (!pagos[d.pago]) pagos[d.pago] = {};
                if (!pagos[d.pago][d.procedimiento]) pagos[d.pago][d.procedimiento] = 0;
                pagos[d.pago][d.procedimiento] += parseFloat(d.total);
            });

            let thead = `<tr><th>Forma de Cobro</th>`;
            procedimientos.forEach(p => { thead += `<th>${p}</th>`; });
            thead += `<th>Total</th></tr>`;
            document.querySelector("#tablaResumen thead").innerHTML = thead;

            let tbody = "";
            const totalesColumnas = {};
            Object.keys(pagos).forEach(pago => {
                let totalFila = 0;
                let fila = `<tr><td>${pago}</td>`;
                procedimientos.forEach(proc => {
                    const val = pagos[pago][proc] || 0;
                    totalFila += val;
                    totalesColumnas[proc] = (totalesColumnas[proc] || 0) + val;  
                    fila += `<td>$${formato.format(val)}</td>`;
                });
                fila += `<td class="fw-bold">$${formato.format(totalFila)}</td></tr>`;
                tbody += fila;
            });

            let filaTotal = `<tr class="table-dark"><td><b>Total</b></td>`;
            let totalGeneral = 0;
            procedimientos.forEach(proc => {
                const val = totalesColumnas[proc] || 0;
                totalGeneral += val;
                filaTotal += `<td><b>$${formato.format(val)}</b></td>`;
            });
            filaTotal += `<td><b>$${formato.format(totalGeneral)}</b></td></tr>`;
            tbody += filaTotal;

            document.getElementById("tbodyResumen").innerHTML = tbody;
        }

        // ====== PACIENTES ======
        const resPacientes = await fetch(`/api/listado-pacientes?desde=${desde}&hasta=${hasta}`);
        const pacientes = await resPacientes.json();

        if (Array.isArray(pacientes) && pacientes.length > 0) {
            document.getElementById("tablaPacientes").innerHTML = pacientes.map(p => `
                <tr>
                    <td>${p.fecha}</td>
                    <td>${p.folio}</td>
                    <td>${p.nombre}</td>
                    <td>${p.procedimiento}</td>
                    <td>${p.status}</td>
                    <td>${p.pago}</td>
                    <td><span class="badge bg-primary">$${formato.format(p.total)}</span></td>
                    <td><span class="badge bg-warning text-dark">$${formato.format(p.saldo)}</span></td>
                </tr>
            `).join('');
        } else {
            document.getElementById("tablaPacientes").innerHTML = "<tr><td colspan='8'>Sin datos</td></tr>";
        }

        Swal.close();
    } catch (error) {
        console.error("Error cargando cierre de caja:", error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Hubo un problema al cargar los datos del cierre.',
            confirmButtonColor: '#d33'
        });
    }
}


// funcion de exportar excel
// exportar en una sola hoja (Resumen + Pacientes juntos)
async function exportarExcel() {
    const rangoTexto = document.getElementById("filtroRango").value || "sin_rango";

    const wb = new ExcelJS.Workbook();
    const ws = wb.addWorksheet("Cierre de Caja");

    let rowIndex = 1;

    // ====== RESUMEN ======
    ws.addRow(["Resumen"]);
    ws.getRow(rowIndex).font = { bold: true, size: 14 };
    rowIndex++;

    const tablaResumen = document.querySelector("#tablaResumen");
    const filasResumen = [...tablaResumen.rows].map(r => [...r.cells].map(c => c.innerText));

    filasResumen.forEach((row, idx) => {
        const excelRow = ws.addRow(row);
        excelRow.eachCell(cell => {
            cell.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };
            if (idx === 0) {
                cell.font = { bold: true, color: { argb:"FFFFFFFF" } };
                cell.fill = { type:"pattern", pattern:"solid", fgColor:{ argb:"2C3E50"} };
                cell.alignment = { horizontal:"center", vertical:"middle" };
            } else if (row[0] === "Total") {
                cell.font = { bold: true, color: { argb:"FFFFFFFF" } };
                cell.fill = { type:"pattern", pattern:"solid", fgColor:{ argb:"000000"} };
            } else {
                cell.alignment = { horizontal:"center" };
            }
            // formato numérico
            if (!isNaN(cell.value) && idx > 0) {
                cell.numFmt = '#,##0.00';
            }

        });
        rowIndex++;
    });

    rowIndex += 2; // dejar 2 filas en blanco

    // ====== PACIENTES ======
    ws.addRow(["Listado de Pacientes"]);
    ws.getRow(rowIndex).font = { bold: true, size: 14 };
    rowIndex++;

    const tablaPacientes = document.querySelector("#tablaPacientesWrap");
    const filasPacientes = [...tablaPacientes.rows].map(r => [...r.cells].map(c => c.innerText));

    filasPacientes.forEach((row, idx) => {
        const excelRow = ws.addRow(row);
        excelRow.eachCell(cell => {
            cell.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };
            if (idx === 0) {
                cell.font = { bold: true, color: { argb:"FFFFFFFF" } };
                cell.fill = { type:"pattern", pattern:"solid", fgColor:{ argb:"455A64"} };
                cell.alignment = { horizontal:"center", vertical:"middle" };
            } else {
                cell.alignment = { horizontal:"center" };
            }
            // formato numérico
            if (!isNaN(cell.value) && idx > 0) {
                cell.numFmt = '#,##0.00';
            }

        });
        rowIndex++;
    });

    // ====== AJUSTAR ANCHO ======
    ws.columns.forEach(col => {
        let maxLen = 0;
        col.eachCell({ includeEmpty: true }, c => {
            const len = c.value ? c.value.toString().length : 0;
            if (len > maxLen) maxLen = len;
        });
        col.width = maxLen + 2;
    });

    // ====== GUARDAR ======
    const buffer = await wb.xlsx.writeBuffer();
    saveAs(new Blob([buffer]), `cierre_${rangoTexto.replace(/\//g,"-")}.xlsx`);

    Swal.fire({
        icon: 'success',
        title: 'Exportación completada',
        text: `El archivo cierre_${rangoTexto}.xlsx se descargó con Resumen y Pacientes en una sola hoja.`,
        confirmButtonColor: '#27ae60'
    });
}

</script>
</body>
</html>
