<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cierre de Caja</title>

<!-- Bootstrap y FontAwesome -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- LibrerÃ­a Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: #f0f5ff;
    padding: 20px;
  }

  .card {
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    overflow: hidden;
    margin-bottom: 25px;
  }

  .card-header {
    font-weight: 600;
    font-size: 1.2rem;
    padding: 15px 20px;
  }

  .card-header.bg-primary {
    background: linear-gradient(135deg, #2c3e50, #3498db);
  }

  .card-header.bg-dark {
    background: linear-gradient(135deg, #212121, #424242);
  }

  .card-header.bg-secondary {
    background: linear-gradient(135deg, #455a64, #90a4ae);
  }

  .table {
    border-radius: 8px;
    overflow: hidden;
  }

  .table thead {
    background: #2c3e50;
    color: white;
  }

  .table tbody tr:nth-child(odd) {
    background-color: #f9f9f9;
  }

  .table tbody tr:hover {
    background-color: #eef6ff;
    transition: background 0.2s;
  }

  .btn {
    font-weight: 600;
    border-radius: 6px;
  }

  .btn-success {
    background: #27ae60;
    border: none;
  }

  .btn-success:hover {
    background: #1e8449;
  }

  .btn-primary {
    background: #2980b9;
    border: none;
  }

  .btn-primary:hover {
    background: #21618c;
  }
</style>
</head>
<body>
<div class="container">
    <!-- Encabezado -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0"><i class="fas fa-cash-register me-2"></i> Cierre de Caja</h3>
        </div>
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="fechaCierre" class="form-label">Seleccionar Fecha:</label>
                    <input type="date" id="fechaCierre" class="form-control">
                </div>

                <div class="col-md-2">
                    <button class="btn btn-success w-100" onclick="cargarCierre()">
                        <i class="fas fa-chart-bar me-1"></i> Generar
                    </button>
                </div>

                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="exportarExcel()">
                        <i class="fas fa-file-excel me-1"></i> Exportar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen -->
    <div class="card shadow mb-4">
        <div class="card-header bg-dark text-white">
            <h4 class="mb-0"><i class="fas fa-list me-2"></i> Resumen</h4>
        </div>
        <div class="card-body">
           <table id="tablaResumen" class="table table-bordered table-hover text-center align-middle">
                <thead>
                  <tr>
                    <th>Forma de Cobro</th>
                    <th>Consulta</th>
                    <th>CirugÃ­a</th>
                    <th>Estudios</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="tbodyResumen">
                  <tr><td colspan="5">Sin datos</td></tr>
                </tbody>
              </table>

        </div>
    </div>

    <!-- Listado de Pacientes -->
    <div class="card shadow">
        <div class="card-header bg-secondary text-white">
            <h4 class="mb-0"><i class="fas fa-users me-2"></i> Listado de Pacientes</h4>
        </div>
        <div class="card-body">
            <table id="tablaPacientesWrap" class="table table-striped table-bordered text-center align-middle">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Folio</th>
                        <th>Paciente</th>
                        <th>Procedimiento</th>
                        <th>Status</th>
                        <th>Pago</th>
                        <th>Total Folio</th>
                        <th>Saldo</th>
                    </tr>
                </thead>
                <tbody id="tablaPacientes"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
async function cargarCierre() {
    const fecha = document.getElementById("fechaCierre").value;

    if (!fecha) {
        Swal.fire({
            icon: 'warning',
            title: 'Fecha requerida',
            text: 'Debes seleccionar una fecha para generar el reporte.',
            confirmButtonColor: '#3085d6'
        });
        return;
    }

    try {
        // ðŸ”¹ Mostrar loading
        Swal.fire({
            title: 'Generando cierre...',
            text: 'Por favor espera',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Resumen de cierre
        const resResumen = await fetch(`/api/cierre-caja?fecha=${fecha}`, {
          credentials: 'include'
        });
        const datosResumen = await resResumen.json();

        // ðŸ”¹ Cerrar loading
        Swal.close();

        if (!Array.isArray(datosResumen) || datosResumen.length === 0) {
            document.getElementById("tbodyResumen").innerHTML = "<tr><td colspan='5'>Sin datos</td></tr>";
            Swal.fire({
                icon: 'info',
                title: 'Sin datos',
                text: 'No se encontraron registros para la fecha seleccionada.',
                confirmButtonColor: '#3085d6'
            });
            return;
        }

        // Procedimientos Ãºnicos
        const procedimientos = [...new Set(datosResumen.map(d => d.procedimiento))];

        // Agrupar pagos por procedimiento
        const pagos = {};
        datosResumen.forEach(d => {
            if (!pagos[d.pago]) pagos[d.pago] = {};
            if (!pagos[d.pago][d.procedimiento]) pagos[d.pago][d.procedimiento] = 0;
            pagos[d.pago][d.procedimiento] += parseFloat(d.total);
        });

        // Encabezado dinÃ¡mico
        let thead = `<tr><th>Forma de Cobro</th>`;
        procedimientos.forEach(p => { thead += `<th>${p}</th>`; });
        thead += `<th>Total</th></tr>`;
        document.querySelector("#tablaResumen thead").innerHTML = thead;

        // Filas con totales por forma de pago
        let tbody = "";
        const totalesColumnas = {};
        Object.keys(pagos).forEach(pago => {
            let totalFila = 0;
            let fila = `<tr><td>${pago}</td>`;
            procedimientos.forEach(proc => {
                const val = pagos[pago][proc] || 0;
                totalFila += val;
                totalesColumnas[proc] = (totalesColumnas[proc] || 0) + val;
                fila += `<td>$${val.toFixed(2)}</td>`;
            });
            fila += `<td class="fw-bold">$${totalFila.toFixed(2)}</td></tr>`;
            tbody += fila;
        });

        // Fila de totales generales
        let filaTotal = `<tr class="table-dark"><td><b>Total</b></td>`;
        let totalGeneral = 0;
        procedimientos.forEach(proc => {
            const val = totalesColumnas[proc] || 0;
            totalGeneral += val;
            filaTotal += `<td><b>$${val.toFixed(2)}</b></td>`;
        });
        filaTotal += `<td><b>$${totalGeneral.toFixed(2)}</b></td></tr>`;
        tbody += filaTotal;

        // Actualizar cuerpo de la tabla
        document.getElementById("tbodyResumen").innerHTML = tbody;

        // Listado de pacientes
        const resPacientes = await fetch(`/api/listado-pacientes?fecha=${fecha}`, {
        credentials: 'include'
        });
        const pacientes = await resPacientes.json();

        document.getElementById("tablaPacientes").innerHTML = pacientes.map(p => `
            <tr>
                <td>${p.fecha}</td>
                <td>${p.folio}</td>
                <td>${p.nombre}</td>
                <td>${p.procedimiento}</td>
                <td>${p.status}</td>
                <td>${p.pago}</td>
                <td><span class="badge bg-primary">$${parseFloat(p.total).toFixed(2)}</span></td>
                <td><span class="badge bg-warning text-dark">$${parseFloat(p.saldo).toFixed(2)}</span></td>
            </tr>
        `).join('');
    } catch (error) {
        console.error("Error cargando cierre de caja:", error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Hubo un problema al cargar los datos del cierre.',
            confirmButtonColor: '#d33'
        });
    }
}

function exportarExcel() {
    const fecha = document.getElementById("fechaCierre").value || "sin_fecha";

    // Tablas completas
    const tablaResumen = document.getElementById("tablaResumen");
    const tablaPacientes = document.getElementById("tablaPacientesWrap");

    // Crear libro Excel
    const wb = XLSX.utils.book_new();
    const wsResumen = XLSX.utils.table_to_sheet(tablaResumen);
    const wsPacientes = XLSX.utils.table_to_sheet(tablaPacientes);

    XLSX.utils.book_append_sheet(wb, wsResumen, "Resumen");
    XLSX.utils.book_append_sheet(wb, wsPacientes, "Pacientes");

    // Descargar
    XLSX.writeFile(wb, `cierre_${fecha}.xlsx`);

    // ðŸ”¹ Aviso con SweetAlert2
    Swal.fire({
        icon: 'success',
        title: 'ExportaciÃ³n completada',
        text: `El archivo cierre_${fecha}.xlsx se descargÃ³ correctamente.`,
        confirmButtonColor: '#27ae60'
    });
}
</script>
</body>
</html>
