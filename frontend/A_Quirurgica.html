<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda Quirúrgica</title>
  <link rel="icon" type="image/png" href="/uploads/logo-oftavision2.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f0f5ff 0%, #e3f2fd 100%);
      padding: 20px;
      color: #333;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      border-radius: 10px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .description {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      margin-bottom: 30px;
      overflow: hidden;
      border: none;
    }
    
    .card-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, #3d5061 100%);
      color: white;
      padding: 18px 25px;
      font-size: 1.3rem;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    
    .card-header i {
      margin-right: 12px;
      font-size: 1.5rem;
    }
    
    .card-body {
      padding: 25px;
    }
    
    .btn {
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      border-radius: 8px;
      padding: 14px 25px;
      font-size: 1.1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--secondary-color) 0%, #2c80b9 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
    }
    
    .btn-primary i {
      margin-right: 8px;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--accent-color) 0%, #c0392b 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(231, 76, 60, 0.4);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(243, 156, 18, 0.3);
    }
    
    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(243, 156, 18, 0.4);
    }
    
    .btn-info {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(23, 162, 184, 0.3);
    }
    
    .btn-info:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(23, 162, 184, 0.4);
    }
    
    .btn-sm {
      padding: 8px 15px;
      font-size: 0.9rem;
    }
    
.table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
}

.table th,
.table td {
  font-size: 0.85rem;  /* texto más compacto */
  padding: 8px;        /* menos espacio */
  text-align: center;
}

/* Ajustes de ancho por columna */
.table th:nth-child(1), .table td:nth-child(1) { width: 5%; }   /* Expediente */
.table th:nth-child(2), .table td:nth-child(2) { width: 6%; }   /* Edad */
.table th:nth-child(3), .table td:nth-child(3) { width: 15%; }  /* Nombre */
.table th:nth-child(4), .table td:nth-child(4) { width: 12%; }  /* Procedimiento */
.table th:nth-child(5), .table td:nth-child(5) { width: 9%; }   /* Total Orden */
.table th:nth-child(6), .table td:nth-child(6) { width: 9%; }   /* Pagos */
.table th:nth-child(7), .table td:nth-child(7) { width: 9%; }   /* Diferencia */
.table th:nth-child(8), .table td:nth-child(8) { width: 8%; }   /* Status */
.table th:nth-child(9), .table td:nth-child(9) { width: 10%; }  /* Tipo de Lente */
.table th:nth-child(10), .table td:nth-child(10) { width: 10%; }/* Agendado */
.table th:nth-child(11), .table td:nth-child(11) { width: 12%; }/* Acciones */

    
    .table tr:last-child td {
      border-bottom: none;
    }
    
    .table tr:nth-child(odd) {
      background: #f9f9f9;
    }
    
    .table tr:hover {
      background-color: #eef6ff;
    }
    
    .success-alert {
      display: none;
      padding: 15px;
      background: #d4edda;
      color: #155724;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #c3e6cb;
    }
    
    .footer {
      text-align: center;
      margin-top: 40px;
      color: #6c757d;
      font-size: 0.9rem;
    }
    
    .calendar-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
      padding: 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .current-month {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary-color);
    }
    
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
    }
    
    .day-header {
      text-align: center;
      padding: 12px;
      background: linear-gradient(135deg, var(--primary-color) 0%, #3d5061 100%);
      color: white;
      border-radius: 8px;
      font-weight: 600;
    }
    
    .calendar-day {
      background: white;
      border-radius: 8px;
      min-height: 120px;
      padding: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: all 0.3s;
    }
    
    .calendar-day:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .day-number {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--primary-color);
    }
    
    /* Colores por tipo de procedimiento */
    .proc-catarata { 
      background: #f5cbfd; 
      border-left: 4px solid #e46bf6; 
    }
    
    .proc-consulta { 
      background: #c9e7fd; 
      border-left: 4px solid #2196f3; 
    }
    
    .proc-lente { 
      background: #f7f9d2; 
      border-left: 4px solid #fbf866; 
    }
    
    .insumo-item {
      padding: 6px;
      margin-bottom: 6px;
      border-radius: 5px;
      font-size: 0.85rem;
    }
    
    .insumo-name {
      font-weight: 600;
    }
    
    .insumo-info {
      font-size: 0.8rem;
      color: #555;
    }
    
    .badge {
      font-size: 0.8rem;
      padding: 5px 10px;
      border-radius: 20px;
    }
    
    .modal-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, #3d5061 100%);
      color: white;
    }
    
    /* Estilos para el nuevo calendario */
    .calendar-container {
      display: flex;
      max-width: 100%;
      margin: 0 auto;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .mini-calendar {
      width: 300px;
      background: linear-gradient(to bottom, #1e3c72, #2a5298);
      color: white;
      padding: 25px;
      display: flex;
      flex-direction: column;
    }
    
    .mini-calendar h2 {
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
    }
    
    .mini-calendar .month-year {
      font-size: 18px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .mini-calendar .days-of-week {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-bottom: 10px;
      text-align: center;
      font-size: 14px;
    }
    
    .mini-calendar .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    
    .mini-calendar .day {
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 5px;
      font-weight: 500;
      position: relative;
      cursor: pointer;
    }
    
    .mini-calendar .current-day {
      background-color: #ff6b6b;
      color: white;
    }
    
    .mini-calendar .other-month {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .mini-calendar .event-indicator {
      width: 6px;
      height: 6px;
      background-color: #ffd700;
      border-radius: 50%;
      position: absolute;
      bottom: 3px;
    }
    
    .main-calendar {
      flex: 1;
      padding: 25px;
    }
    
    .main-calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }
    
    .main-calendar-header h1 {
      font-size: 28px;
      color: #1e3c72;
      font-weight: 700;
    }
    
    .month-navigation {
      display: flex;
      gap: 15px;
    }
    
    .month-navigation button {
      background-color: #1e3c72;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.3s;
    }
    
    .month-navigation button:hover {
      background-color: #2a5298;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 15px;
    }
    
    .calendar-day-new {
      min-height: 120px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      background-color: #f9f9f9;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .calendar-day-new:hover {
      background-color: #f0f0f0;
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .calendar-day-new.other-month {
      background-color: #f5f5f5;
      color: #aaa;
    }
    
    .calendar-day-new.current-day {
      background-color: #e3f2fd;
      border: 2px solid #1e3c72;
    }
    
    .day-number-new {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 16px;
      color: #1e3c72;
    }
    
    .event {
      background-color: #ffd700;
      padding: 4px 8px;
      border-radius: 4px;
      margin-bottom: 5px;
      font-size: 12px;
      color: #333;
    }
    
    .event.birthday {
      background-color: #ff6b6b;
      color: white;
    }
    
    .event.meeting {
      background-color: #4ecdc4;
      color: white;
    }
    
    .event.work {
      background-color: #45b7d1;
      color: white;
    }
    
    .event.personal {
      background-color: #96ceb4;
      color: white;
    }
    
    .legend {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 25px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }
    
    .legend-color {
      width: 15px;
      height: 15px;
      border-radius: 3px;
    }
    
    @media (max-width: 900px) {
      .calendar-container {
        flex-direction: column;
      }
      
      .mini-calendar {
        width: 100%;
      }
    }
    
    @media (max-width: 768px) {
      h1 {
        font-size: 2rem;
      }
      
      .table-responsive {
        overflow-x: auto;
      }
      
      .card-header {
        font-size: 1.1rem;
        padding: 15px;
      }
      
      .calendar-nav {
        flex-direction: column;
        gap: 15px;
      }
      
      .calendar {
        grid-template-columns: repeat(1, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-calendar-check"></i> Agenda Quirúrgica</h1>
      <p class="description">Gestión de cirugías y procedimientos del sistema Oftavisión.</p>
    </header>

    <div class="success-alert" id="successAlert">
      <i class="fas fa-check-circle"></i> <span id="successMessage">Operación realizada correctamente.</span>
    </div>

<!-- Tabla de órdenes -->
<div class="card">
  <div class="card-header"><i class="fas fa-list"></i> Órdenes de Cirugía</div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead>
          <tr>
            <th>Expediente</th>
            <th>Edad</th>
            <th>Nombre</th>
            <th>Procedimiento</th>
            <th>Total Orden</th>
            <th>Pagos Realizados</th>
            <th>Diferencia</th>
            <th>Status</th>
            <th>Tipo de Lente</th>
            <th>Agendado</th> <!-- 🔹 Nueva columna -->
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaOrdenes"></tbody>
      </table>
    </div>
  </div>
</div>


    <!-- Modal Calendario -->
    <div class="modal fade" id="modalCalendario" tabindex="-1">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-calendar"></i> Calendario de Cirugías</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="calendar-container">
              <div class="mini-calendar">
                <h2>Calendario</h2>
                <div class="month-year" id="miniMonthYear">Abril 2023</div>
                <div class="days-of-week">
                  <div>Lun</div>
                  <div>Mar</div>
                  <div>Mié</div>
                  <div>Jue</div>
                  <div>Vie</div>
                  <div>Sáb</div>
                  <div>Dom</div>
                </div>
                <div class="days" id="mini-calendar-days">
                  <!-- Los días se generarán con JavaScript -->
                </div>
              </div>
              
              <div class="main-calendar">
                <div class="main-calendar-header">
                  <h1 id="mainMonthYear">Abril 2023</h1>
                  <div class="month-navigation">
                    <button id="prev-month">← Mes Anterior</button>
                    <button id="next-month">Mes Siguiente →</button>
                  </div>
                </div>
                
                <div class="calendar-grid" id="calendar-grid">
                  <!-- Los días del calendario principal se generarán con JavaScript -->
                </div>
                
                <div class="legend">
                  <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff6b6b;"></div>
                    <span>Cumpleaños</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color" style="background-color: #4ecdc4;"></div>
                    <span>Reunión</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color" style="background-color: #45b7d1;"></div>
                    <span>Trabajo</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color" style="background-color: #96ceb4;"></div>
                    <span>Personal</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>Sistema de Gestión Oftavisión &copy; 2025</p>
    </div>
  </div>

  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // ====================== VARIABLES GLOBALES ======================
    let fechaCirugia = new Date();
    let ordenSeleccionada = null;
    
    // Variables para el nuevo calendario
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();

    // ====================== TABLA ======================
async function cargarOrdenes(year, month) {
  try {
    const res = await fetch('/api/ordenes');
    let ordenes = await res.json();

    // 🔹 Si hay año/mes, filtramos por ese mes
    if (year !== undefined && month !== undefined) {
      ordenes = ordenes.filter(o => {
        if (!o.fecha_cirugia) return true; // mostrar también las que aún no tienen fecha
        const f = new Date(o.fecha_cirugia);
        return f.getFullYear() === year && f.getMonth() === month;
      });
    }

    document.getElementById("tablaOrdenes").innerHTML = ordenes.map(o => `
      <tr>
        <td>${o.expediente}</td>
        <td>${o.edad}</td>
        <td>${o.nombre}</td>
        <td>${o.procedimiento}</td>
        <td>$${Number(o.total).toLocaleString("es-MX", {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
        <td>$${Number(o.pagos).toLocaleString("es-MX", {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
        <td>$${Number(o.total - o.pagos).toLocaleString("es-MX", {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>

        <td><span class="badge ${o.status === 'Completado' ? 'bg-success' : 'bg-warning'}">${o.status}</span></td>
        <td>
          ${o.tipo_lente 
            ? `<span class="badge bg-info" style="cursor:pointer" onclick="editarLente(${o.id}, '${o.tipo_lente}')">${o.tipo_lente}</span>` 
            : `<button class="btn btn-sm btn-secondary" 
                      onclick="editarLente(${o.id}, '')">
                 <i class="fas fa-plus-circle"></i> Añadir Lente
               </button>`}
        </td>
        <td>
          ${o.fecha_cirugia 
            ? new Date(o.fecha_cirugia).toLocaleDateString("es-MX") 
            : '<span class="text-muted">No asignado</span>'}
        </td>
        <td>
          ${o.fecha_cirugia ? 
            '<span class="text-muted">Asignado</span>' : 
            `<button class="btn btn-sm btn-primary" 
                    onclick="abrirCalendario(${o.id})">
              <i class="fas fa-calendar-plus"></i> Agendar
            </button>`}
          ${o.fecha_cirugia ? `
            <button class="btn btn-sm btn-warning mt-1" 
                    onclick="editarCirugia(${o.id})">
              <i class="fas fa-edit"></i> Reprogramar
            </button>
          ` : ''}
        </td>
      </tr>
    `).join('');
  } catch (err) {
    console.error("Error cargando órdenes:", err);
    mostrarError("Error", "No se pudieron cargar las órdenes");
  }
}

    // ====================== CALENDARIO ======================
    document.addEventListener("DOMContentLoaded", () => {
      renderCalendarCirugias(); // carga inicial
      initNewCalendar(); // inicializar el nuevo calendario
    });

    function getColorClass(proc) {
      const texto = proc.toLowerCase();

      if (texto.includes("catarata")) return "proc-catarata";
      if (texto.includes("consulta")) return "proc-consulta";
      if (texto.includes("lente")) return "proc-lente";

      return "";
    }

    async function renderCalendarCirugias() {
      const calendario = document.getElementById("calendarioCirugias");
      const mesActual = document.getElementById("mesCirugia");

      const year = fechaCirugia.getFullYear();
      const month = fechaCirugia.getMonth();

      mesActual.textContent = fechaCirugia.toLocaleString("es-ES", { month: "long", year: "numeric" });

      const primerDia = new Date(year, month, 1).getDay() || 7;
      const diasEnMes = new Date(year, month + 1, 0).getDate();

      let cirugias = [];
      try {
        const res = await fetch("/api/cirugias");
        cirugias = await res.json();
      } catch (err) { 
        console.error(err); 
      }

      const filtradas = cirugias.filter(c => {
        const f = new Date(c.fecha);
        return f.getFullYear() === year && f.getMonth() === month;
      });

      if (calendario) {
        calendario.innerHTML = "";

        ["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"].forEach(d => {
          calendario.innerHTML += `<div class="day-header">${d}</div>`;
        });

        for (let i = 1; i < primerDia; i++) {
          calendario.innerHTML += `<div class="empty-day"></div>`;
        }

        for (let d = 1; d <= diasEnMes; d++) {
          const fechaDia = new Date(year, month, d).toISOString().split("T")[0];
          const programadas = filtradas.filter(c => c.fecha.startsWith(fechaDia));

          let contenido = `<div class="calendar-day" onclick="asignarFecha('${fechaDia}')">
                         <div class="day-number">${d}</div>`;
          if (programadas.length > 0) {
            programadas.forEach(c => {
              contenido += `
                <div class="insumo-item ${getColorClass(c.procedimiento)}">
                  <div class="insumo-name">${c.nombre}</div>
                  <div class="insumo-info">Proc: ${c.procedimiento}</div>
                  <div class="insumo-info">Dr: ${c.medico}</div>
                  ${c.tipo_lente ? `<div class="insumo-info">Lente: ${c.tipo_lente}</div>` : ""}
                  <button class="btn btn-sm btn-danger mt-1" onclick="event.stopPropagation(); eliminarCirugia(${c.id})">
                    <i class="fas fa-trash"></i> Eliminar
                  </button>

                </div>`;
            });
          }
          contenido += "</div>";
          calendario.innerHTML += contenido;
        }
      }

      // 🔹 Refrescar la tabla también
      cargarOrdenes(year, month);
    }

    function cambiarMesCirugia(offset) {
      fechaCirugia.setMonth(fechaCirugia.getMonth() + offset);
      renderCalendarCirugias();
    }

    // ==================== NUEVO CALENDARIO ====================
function initNewCalendar() {
  const monthNames = [
    "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
    "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
  ];

  const miniCalendarDays = document.getElementById('mini-calendar-days');
  const calendarGrid = document.getElementById('calendar-grid');
  const prevMonthBtn = document.getElementById('prev-month');
  const nextMonthBtn = document.getElementById('next-month');
  const mainCalendarHeader = document.getElementById('mainMonthYear');
  const miniCalendarMonthYear = document.getElementById('miniMonthYear');

  async function renderNewCalendar() {
    mainCalendarHeader.textContent = `${monthNames[currentMonth]} ${currentYear}`;
    miniCalendarMonthYear.textContent = `${monthNames[currentMonth]} ${currentYear}`;

    miniCalendarDays.innerHTML = '';
    calendarGrid.innerHTML = '';

    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const daysInMonth = lastDay.getDate();

    let firstDayIndex = firstDay.getDay();
    firstDayIndex = firstDayIndex === 0 ? 6 : firstDayIndex - 1;
    const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();

    // 🔹 traer cirugías desde API
    let cirugias = [];
    try {
      const res = await fetch("/api/cirugias");
      cirugias = await res.json();
    } catch (err) {
      console.error("Error cargando cirugías:", err);
    }

    // Mini calendario
    for (let i = firstDayIndex; i > 0; i--) {
      const dayElement = document.createElement('div');
      dayElement.className = 'day other-month';
      dayElement.textContent = prevMonthLastDay - i + 1;
      miniCalendarDays.appendChild(dayElement);
    }
    for (let i = 1; i <= daysInMonth; i++) {
      const dayElement = document.createElement('div');
      dayElement.className = 'day';
      if (currentDate.getDate() === i && currentDate.getMonth() === currentMonth && currentDate.getFullYear() === currentYear) {
        dayElement.classList.add('current-day');
      }
      dayElement.textContent = i;
      miniCalendarDays.appendChild(dayElement);
    }
    const totalCells = 42;
    const remainingCells = totalCells - (firstDayIndex + daysInMonth);
    for (let i = 1; i <= remainingCells; i++) {
      const dayElement = document.createElement('div');
      dayElement.className = 'day other-month';
      dayElement.textContent = i;
      miniCalendarDays.appendChild(dayElement);
    }

    // Encabezados
    const dayNames = ["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"];
    for (let i = 0; i < 7; i++) {
      const dayHeader = document.createElement('div');
      dayHeader.className = 'calendar-day-new';
      dayHeader.style.fontWeight = 'bold';
      dayHeader.style.backgroundColor = '#e0e0e0';
      dayHeader.textContent = dayNames[i];
      calendarGrid.appendChild(dayHeader);
    }

    // Días principales
    for (let i = firstDayIndex; i > 0; i--) {
      const dayElement = document.createElement('div');
      dayElement.className = 'calendar-day-new other-month';
      dayElement.innerHTML = `<div class="day-number-new">${prevMonthLastDay - i + 1}</div>`;
      calendarGrid.appendChild(dayElement);
    }
    for (let i = 1; i <= daysInMonth; i++) {
      const fechaDia = new Date(currentYear, currentMonth, i).toISOString().split("T")[0];
      const dayElement = document.createElement('div');
      dayElement.className = 'calendar-day-new';
      if (currentDate.getDate() === i && currentDate.getMonth() === currentMonth && currentDate.getFullYear() === currentYear) {
        dayElement.classList.add('current-day');
      }
      dayElement.innerHTML = `<div class="day-number-new">${i}</div>`;
      dayElement.onclick = () => asignarFecha(fechaDia);

      const cirugiasDia = cirugias.filter(c => c.fecha && c.fecha.startsWith(fechaDia));
      cirugiasDia.forEach(c => {
        const eventElement = document.createElement('div');
        eventElement.className = 'event';
        eventElement.textContent = `${c.nombre} - ${c.procedimiento}`;
        dayElement.appendChild(eventElement);
      });

      calendarGrid.appendChild(dayElement);
    }
    const totalMainCells = 42 - 7;
    const remainingMainCells = totalMainCells - (firstDayIndex + daysInMonth);
    for (let i = 1; i <= remainingMainCells; i++) {
      const dayElement = document.createElement('div');
      dayElement.className = 'calendar-day-new other-month';
      dayElement.innerHTML = `<div class="day-number-new">${i}</div>`;
      calendarGrid.appendChild(dayElement);
    }
  }

  prevMonthBtn.addEventListener('click', async function() {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    await renderNewCalendar();
  });

  nextMonthBtn.addEventListener('click', async function() {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    await renderNewCalendar();
  });

  renderNewCalendar();
}

    // ==================== AGENDAR CIRUGÍA ====================
    function agendarCirugia(idOrden) {
      Swal.fire({
        title: 'Asignar fecha de cirugía',
        input: 'date',
        showCancelButton: true,
        confirmButtonText: 'Asignar',
        cancelButtonText: 'Cancelar'
      }).then(async (result) => {
        if (result.isConfirmed) {
          const fecha = result.value;
          try {
            await fetch(`/api/ordenes/${idOrden}/agendar`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ fecha_cirugia: fecha })
            });
            mostrarExito("Cirugía agendada", "La cirugía ha sido agendada correctamente");
            renderCalendarCirugias();
          } catch (err) {
            console.error("Error al agendar:", err);
            mostrarError("Error", "No se pudo agendar la cirugía");
          }
        }
      });
    }

    function editarCirugia(idOrden) {
      ordenSeleccionada = idOrden;
      const modal = new bootstrap.Modal(document.getElementById("modalCalendario"));
      modal.show();
    }

    // ==================== EDITAR TIPO DE LENTE ====================
    function editarLente(idOrden, tipoActual) {
      Swal.fire({
        title: tipoActual ? 'Editar Tipo de Lente' : 'Añadir Tipo de Lente',
        input: 'text',
        inputValue: tipoActual || '',
        inputPlaceholder: 'Ejemplo: Lente Intraocular',
        showCancelButton: true,
        confirmButtonText: 'Guardar',
        cancelButtonText: 'Cancelar',
        preConfirm: (valor) => {
          if (!valor.trim()) {
            Swal.showValidationMessage('Debes ingresar un tipo de lente');
          }
          return valor;
        }
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await fetch(`/api/ordenes/${idOrden}/lente`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ tipo_lente: result.value })
            });
            mostrarExito("Tipo de lente actualizado", "El tipo de lente fue actualizado correctamente");
            renderCalendarCirugias();
          } catch (err) {
            console.error("Error al actualizar tipo de lente:", err);
            mostrarError("Error", "No se pudo actualizar el tipo de lente");
          }
        }
      });
    }

    function abrirCalendario(idOrden) {
      ordenSeleccionada = idOrden;
      const modal = new bootstrap.Modal(document.getElementById("modalCalendario"));
      modal.show();
    }

    // ==================== ASIGNAR FECHA DESDE EL CALENDARIO ====================
    async function asignarFecha(fecha) {
      if (!ordenSeleccionada) return;

      try {
        await fetch(`/api/ordenes/${ordenSeleccionada}/agendar`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fecha_cirugia: fecha })
        });
        mostrarExito("Cirugía asignada", `Fecha: ${fecha}`);

        ordenSeleccionada = null;
        renderCalendarCirugias();

        // Cierra el modal después de asignar
        const modal = bootstrap.Modal.getInstance(document.getElementById("modalCalendario"));
        modal.hide();
      } catch (err) {
        console.error("Error al asignar cirugía:", err);
        mostrarError("Error", "No se pudo asignar la cirugía");
      }
    }

    // ==================== ELIMINAR CIRUGÍA ====================
    function eliminarCirugia(idOrden) {
      Swal.fire({
        title: '¿Eliminar cirugía?',
        text: "Esta acción no se puede deshacer.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await fetch(`/api/ordenes/${idOrden}/agendar`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ fecha_cirugia: null })
            });
            mostrarExito("Cirugía eliminada", "La cirugía ha sido eliminada del calendario");
            renderCalendarCirugias();
          } catch (err) {
            console.error("Error al eliminar cirugía:", err);
            mostrarError("Error", "No se pudo eliminar la cirugía");
          }
        }
      });
    }

    // ==================== FUNCIONES DE NOTIFICACIÓN ====================
    function mostrarExito(titulo, mensaje) {
      document.getElementById('successMessage').textContent = mensaje;
      document.getElementById('successAlert').style.display = 'block';
      
      setTimeout(() => {
        document.getElementById('successAlert').style.display = 'none';
      }, 5000);
      
      Swal.fire({
        icon: 'success',
        title: titulo,
        text: mensaje,
        timer: 3000,
        showConfirmButton: false
      });
    }

    function mostrarError(titulo, mensaje) {
      Swal.fire({
        icon: 'error',
        title: titulo,
        text: mensaje
      });
    }
  </script>
</body>
</html>