<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Expedientes</title>
    <link rel="stylesheet" href="styles.css">

    <!-- FontAwesome para √≠conos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; }
        .container { padding: 20px; max-width: 1200px; margin: auto; }

        /* Encabezado estilo optometr√≠a */
        header {
            text-align: center;
            margin-bottom: 25px;
            padding: 15px;
            background: linear-gradient(135deg,#2c3e50 0%,#3498db 100%);
            color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        header h1 { margin: 0; font-size: 2rem; }

        .top-bar { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .search-section { display: flex; gap: 5px; }
        .search-section input { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background: #eee; }
        button { padding: 6px 12px; cursor: pointer; border: none; border-radius: 6px; transition: 0.3s; font-weight: 500; }

        /* üé® Botones con paleta profesional */
        .btn-guardar { background: #2e7d32; color: white; }
        .btn-guardar:hover { background: #1b5e20; }

        .btn-editar { background: #1976d2; color: white; }
        .btn-editar:hover { background: #0d47a1; }

        .btn-cancelar { background: #6c757d; color: white; }
        .btn-cancelar:hover { background: #495057; }

        .btn-medico { background: #009688; color: white; }
        .btn-medico:hover { background: #00695c; }

        .btn-opto { background: #6a1b9a; color: white; }
        .btn-opto:hover { background: #4a148c; }

        #expedienteForm {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        input, select {
            width: 100%;
            padding: 6px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* Modal */
        #modalMedico {
            display:none;
            position:fixed;
            top:5%;
            left:50%;
            transform:translateX(-50%);
            background:white;
            padding:20px;
            border:1px solid #ccc;
            border-radius:8px;
            width:80%;
            max-height:90%;
            overflow-y:auto;
            z-index:2000;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-folder"></i> Gesti√≥n de Expedientes</h1>
        </header>

        <!-- Barra b√∫squeda -->
        <div class="top-bar">
            <div class="search-section">
                <input type="text" id="buscarInput" placeholder="Buscar por n√∫mero de expediente o nombre...">
                <button onclick="buscarExpediente()">Buscar</button>
            </div>
            <button onclick="nuevoExpediente()">Nuevo Expediente</button>
        </div>

        <!-- Formulario Expediente -->
        <form id="expedienteForm" onsubmit="guardarExpediente(event)" style="display:none;">
            <label>N√∫mero de Expediente:</label>
            <input type="text" id="numero_expediente" readonly placeholder="Se generar√° autom√°ticamente">

            <label>Nombre Completo:</label>
            <input type="text" id="nombre" required>

            <label>Fecha de Nacimiento:</label>
            <input type="date" id="fecha_nacimiento" required onchange="calcularEdad()">

            <label>Edad:</label>
            <input type="number" id="edad" readonly>

            <label>Padecimientos:</label>
            <select id="padecimientos" required>
                <option value="">Seleccione...</option>
                <option value="DIABETES">DIABETES</option>
                <option value="HIPERTENSO">HIPERTENSO</option>
                <option value="NINGUNO">NINGUNO</option>
            </select>

            <label>Colonia:</label>
            <input type="text" id="colonia">

            <label>Ciudad:</label>
            <input type="text" id="ciudad">

            <label>Tel√©fono 1:</label>
            <input type="text" id="telefono1">

            <label>Tel√©fono 2:</label>
            <input type="text" id="telefono2">

            <button type="submit" class="btn-guardar">Guardar</button>
            <button type="button" class="btn-cancelar" onclick="cancelarFormulario()">Cancelar</button>
        </form>

        <!-- Tabla Expedientes -->
        <table>
            <thead>
                <tr>
                    <th>N√∫mero</th>
                    <th>Nombre</th>
                    <th>Edad</th>
                    <th>Padecimiento</th>
                    <th>Colonia</th>
                    <th>Ciudad</th>
                    <th>Tel. 1</th>
                    <th>Tel. 2</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="listaExpedientes"></tbody>
        </table>
    </div>

    <!-- Modal -->
    <div id="modalMedico">
        <h3 id="modalTitulo"></h3>
        <div id="modalContenido"></div>
        <button onclick="cerrarModal()" class="btn-cancelar mt-2">Cerrar</button>
    </div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
async function cargarExpedientes() {
    const res = await fetch('/api/expedientes');
    const data = await res.json();
    const tbody = document.getElementById('listaExpedientes');
    tbody.innerHTML = '';

    data.forEach(exp => {
        tbody.innerHTML += `
            <tr>
                <td>${exp.numero_expediente}</td>
                <td>${exp.nombre_completo}</td>
                <td>${exp.edad}</td>
                <td>${exp.padecimientos}</td>
                <td>${exp.colonia}</td>
                <td>${exp.ciudad}</td>
                <td>${exp.telefono1}</td>
                <td>${exp.telefono2 || ''}</td>
                <td>
                    <button class="btn-editar" onclick="editarExpediente(${exp.numero_expediente})">Editar</button>
                    <button class="btn-medico" onclick="verMedico(${exp.numero_expediente}, '${exp.nombre_completo}')">M√©dico</button>
                    <button class="btn-opto" onclick="verOptometria(${exp.numero_expediente}, '${exp.nombre_completo}')">Optometr√≠a</button>
                </td>
            </tr>
        `;
    });
}

function nuevoExpediente() {
    document.getElementById('expedienteForm').reset();
    document.getElementById('numero_expediente').value = '';
    document.getElementById('expedienteForm').style.display = 'block';
}

function cancelarFormulario() {
    document.getElementById('expedienteForm').style.display = 'none';
}

function calcularEdad() {
    const fecha = document.getElementById('fecha_nacimiento').value;
    if (fecha) {
        const nacimiento = new Date(fecha);
        const hoy = new Date();
        let edad = hoy.getFullYear() - nacimiento.getFullYear();
        const mes = hoy.getMonth() - nacimiento.getMonth();
        if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
            edad--;
        }
        document.getElementById('edad').value = edad;
    }
}

async function guardarExpediente(e) {
    e.preventDefault();
    const expediente = {
        nombre_completo: document.getElementById('nombre').value,
        fecha_nacimiento: document.getElementById('fecha_nacimiento').value,
        edad: document.getElementById('edad').value,
        padecimientos: document.getElementById('padecimientos').value,
        colonia: document.getElementById('colonia').value,
        ciudad: document.getElementById('ciudad').value,
        telefono1: document.getElementById('telefono1').value,
        telefono2: document.getElementById('telefono2').value
    };

    const res = await fetch('/api/expedientes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(expediente)
    });

    const data = await res.json();

    if (res.ok) {
        Swal.fire({
            icon: 'success',
            title: 'Expediente creado',
            text: `N√∫mero: ${data.expediente.numero_expediente}`,
            confirmButtonColor: '#3085d6'
        });
    } else {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.error || 'No se pudo crear el expediente',
            confirmButtonColor: '#d33'
        });
    }

    cargarExpedientes();
    cancelarFormulario();
}

async function editarExpediente(id) {
    const res = await fetch(`/api/expedientes/${id}`);
    const data = await res.json();

    document.getElementById('numero_expediente').value = data.numero_expediente;
    document.getElementById('nombre').value = data.nombre_completo;
    document.getElementById('fecha_nacimiento').value = data.fecha_nacimiento.split('T')[0];
    document.getElementById('edad').value = data.edad;
    document.getElementById('padecimientos').value = data.padecimientos;
    document.getElementById('colonia').value = data.colonia;
    document.getElementById('ciudad').value = data.ciudad;
    document.getElementById('telefono1').value = data.telefono1;
    document.getElementById('telefono2').value = data.telefono2;

    document.getElementById('expedienteForm').style.display = 'block';
}

async function buscarExpediente() {
    const folio = document.getElementById('buscarInput').value.trim();
    if (!folio) return cargarExpedientes();

    const res = await fetch(`/api/expedientes/${folio}`);
    if (res.ok) {
        const data = await res.json();
        document.getElementById('listaExpedientes').innerHTML = `
            <tr>
                <td>${data.numero_expediente}</td>
                <td>${data.nombre_completo}</td>
                <td>${data.edad}</td>
                <td>${data.padecimientos}</td>
                <td>${data.colonia}</td>
                <td>${data.ciudad}</td>
                <td>${data.telefono1}</td>
                <td>${data.telefono2 || ''}</td>
                <td>
                    <button class="btn-editar" onclick="editarExpediente(${data.numero_expediente})">Editar</button>
                    <button class="btn-medico" onclick="verMedico(${data.numero_expediente}, '${data.nombre_completo}')">M√©dico</button>
                    <button class="btn-opto" onclick="verOptometria(${data.numero_expediente}, '${data.nombre_completo}')">Optometr√≠a</button>
                </td>
            </tr>
        `;
    } else {
        Swal.fire({
            icon: 'warning',
            title: 'No encontrado',
            text: 'No existe un expediente con ese folio'
        });
        document.getElementById('listaExpedientes').innerHTML = `<tr><td colspan="9">No encontrado</td></tr>`;
    }
}

// === VER ORDENES M√âDICAS ===
async function verMedico(expedienteId, nombre) {
    const res = await fetch(`/api/expedientes/${expedienteId}/ordenes`);
    const data = await res.json();

    if (!data.length) {
        Swal.fire({
            icon: 'info',
            title: 'Sin √≥rdenes',
            text: 'No hay √≥rdenes m√©dicas registradas para este expediente.'
        });
        return;
    }

    let contenido = "";
    data.forEach((orden, idx) => {
        contenido += `
        <h4 class="mt-3">Orden #${orden.numero_orden} ${idx === 0 ? '(M√°s reciente)' : ''}</h4>
        <table class="table table-bordered">
            <tr><th>M√©dico</th><td>${orden.medico}</td></tr>
            <tr><th>Diagn√≥stico</th><td>${orden.diagnostico}</td></tr>
            <tr><th>Lado</th><td>${orden.lado}</td></tr>
            <tr><th>Procedimiento</th><td>${orden.procedimiento}</td></tr>
            <tr><th>Precio</th><td>$${orden.precio || ''}</td></tr>
            <tr><th>Estatus</th><td>${orden.estatus}</td></tr>
            <tr><th>Fecha</th><td>${new Date(orden.fecha).toLocaleString()}</td></tr>
        </table>
        <hr/>
        `;
    });

    Swal.fire({
        title: `√ìrdenes de ${nombre} (Expediente ${expedienteId})`,
        html: contenido,
        width: '60%',
        confirmButtonText: 'Cerrar'
    });
}

// === VER OPTOMETR√çA ===
async function verOptometria(expedienteId, nombre) {
    const res = await fetch(`/api/expedientes/${expedienteId}/optometria`);
    const data = await res.json();

    if (!data.length) {
        Swal.fire({
            icon: 'info',
            title: 'Sin registros',
            text: 'No hay evaluaciones de optometr√≠a registradas para este expediente.'
        });
        return;
    }

    let contenido = "";
    data.forEach((opto, idx) => {
        contenido += `
        <h4 class="mt-3">Evaluaci√≥n #${opto.id} ${idx === 0 ? '(M√°s reciente)' : ''}</h4>
        <table class="table table-bordered">
            <tr><th>OD Esfera</th><td>${opto.esfera_od || ''}</td></tr>
            <tr><th>OD Cilindro</th><td>${opto.cilindro_od || ''}</td></tr>
            <tr><th>OD Eje</th><td>${opto.eje_od || ''}</td></tr>
            <tr><th>OD AVcC</th><td>${opto.avcc_od || ''}</td></tr>
            <tr><th>OI Esfera</th><td>${opto.esfera_oi || ''}</td></tr>
            <tr><th>OI Cilindro</th><td>${opto.cilindro_oi || ''}</td></tr>
            <tr><th>OI Eje</th><td>${opto.eje_oi || ''}</td></tr>
            <tr><th>OI AVcC</th><td>${opto.avcc_oi || ''}</td></tr>
            <tr><th>BMP</th><td>${opto.bmp || ''}</td></tr>
            <tr><th>F.O</th><td>${opto.fo || ''}</td></tr>
            <tr><th>Fecha</th><td>${new Date(opto.fecha).toLocaleString()}</td></tr>
        </table>
        <hr/>
        `;
    });

    Swal.fire({
        title: `Optometr√≠a de ${nombre} (Expediente ${expedienteId})`,
        html: contenido,
        width: '60%',
        confirmButtonText: 'Cerrar'
    });
}

function cerrarModal() {
    document.getElementById("modalMedico").style.display = "none";
}

cargarExpedientes();
</script>
