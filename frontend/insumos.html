<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Insumos M√©dicos</title>
  <!-- Favicon (logo empresa)-->
  <link rel="icon" type="image/png" href="/uploads/logo-oftavision2.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f5ff; padding: 20px; color: #333; }
    .container { max-width: 1200px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 30px; padding: 15px; background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h1 { font-size: 2.2rem; margin-bottom: 10px; }
    .description { font-size: 1.1rem; opacity: 0.9; }

    .card { background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 30px; overflow: hidden; }
    .card-header { background: #2c3e50; color: white; padding: 15px 20px; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; justify-content: space-between; }
    .card-header i { margin-right: 10px; }
    .card-body { padding: 20px; }
    .form-group { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
    input, button { padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
    input[type="date"], input[type="text"], input[type="number"] { flex: 1; min-width: 160px; }

    .btn { cursor: pointer; font-weight: 600; transition: all 0.3s ease; border: none; }
    .btn-add { background: #27ae60; color: white; }
    .btn-add:hover { background: #219653; }
    .btn-upload { background: #2980b9; color: white; display: flex; align-items: center; }
    .btn-upload:hover { background: #2573a7; }
    .btn-delete { background: #e74c3c; color: white; padding: 6px 12px; font-size: 0.9rem; border-radius: 5px; }
    .btn-delete:hover { background: #c0392b; }

    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
    th { background-color: #f8f9fa; font-weight: 600; color: #2c3e50; }

    .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; padding: 15px; background: white; border-radius: 10px; }
    .current-month { font-size: 1.5rem; font-weight: 600; color: #2c3e50; }
    .nav-btn { background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
    .day-header { text-align: center; padding: 8px; background: #2c3e50; color: white; border-radius: 6px; }
    .calendar-day { background: white; border-radius: 8px; min-height: 140px; padding: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .day-number { font-weight: 600; margin-bottom: 8px; color: #2c3e50; font-size: 1.1rem; }
    
    /* NUEVOS ESTILOS PARA LAS ETIQUETAS */
    .nota-editable {
      background: #d1ecf1;
      border: 2px dashed #3498db;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 5px;
      min-height: 40px;
      font-size: 0.85rem;
      color: #0c5460;
      cursor: text;
      transition: all 0.2s;
    }
    
    .nota-editable:hover {
      background: #bee5eb;
      border-color: #2980b9;
    }
    
    .nota-editable:focus {
      outline: none;
      background: #ffffff;
      border-color: #3498db;
      border-style: solid;
    }
    
    .nota-editable[contenteditable="true"]:empty:before {
      content: "Click para agregar nota...";
      color: #6c757d;
      font-style: italic;
    }
    
    .total-dia {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      padding: 10px;
      border-radius: 5px;
      color: white;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
    }
    
    .total-dia .label {
      font-size: 0.75rem;
      opacity: 0.9;
      display: block;
      margin-bottom: 3px;
    }
    
    .total-dia .monto {
      font-size: 1.1rem;
      font-weight: 700;
    }

/* === Colores por rol === */

/* Admin (azul) */
.total-dia.admin {
  background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
  box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
}
.nota-editable.admin {
  background: #d1ecf1;
  border: 2px dashed #3498db;
  color: #0c5460;
}

/* Usuario (verde) */
.total-dia.usuario {
  background: linear-gradient(135deg, #1b5e20 0%, #43a047 100%);
  box-shadow: 0 2px 8px rgba(67, 160, 71, 0.3);
}
.nota-editable.usuario {
  background: #d4edda;
  border: 2px dashed #28a745;
  color: #155724;
}



  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Sistema de Gesti√≥n de Insumos M√©dicos</h1>
      <p class="description">Agenda de medicamentos programados</p>
    </header>

    <!-- Registro -->
    <div class="card">
      <div class="card-header"><i class="fas fa-pills"></i> Pedido de Insumos M√©dicos</div>
      <div class="card-body">
        <form id="agendaForm">
          <div class="form-group">
            <input type="date" id="fechaInsumo" required>
            <input type="text" id="folio" placeholder="Folio" required>
            <input type="text" id="concepto" placeholder="Concepto" required>
            <input type="number" id="monto" placeholder="Monto" step="0.01" required>
            <button type="submit" class="btn btn-add"><i class="fas fa-plus"></i> Agregar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Lista -->
    <div class="card">
      <div class="card-header">
        <span><i class="fas fa-list-alt"></i> Lista de Insumos Pedidos</span>
        <form id="uploadForm" enctype="multipart/form-data">
          <input type="file" id="excelFile" name="excelFile" accept=".xls,.xlsx" style="display:none;">
          <button type="button" class="btn btn-upload" onclick="document.getElementById('excelFile').click()">
            <i class="fas fa-upload"></i> Subir Excel
          </button>
        </form>
      </div>
      <div class="card-body">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Folio</th>
              <th>Concepto</th>
              <th>Monto</th>
              <th>Archivo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaInsumos"></tbody>
        </table>
      </div>
    </div>

    <!-- Calendario -->
    <div class="card">
      <div class="card-header"><i class="far fa-calendar-alt"></i> Agenda de Medicamentos</div>
      <div class="card-body">
        <div class="calendar-nav">
          <button class="nav-btn" onclick="cambiarMes(-1)"><i class="fas fa-chevron-left"></i> Mes anterior</button>
          <div class="current-month" id="mesActual"></div>
          <button class="nav-btn" onclick="cambiarMes(1)">Mes siguiente <i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="calendar" id="calendario"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>

// === Cambiar mes del calendario ===
function cambiarMes(delta) {
  fechaActual.setMonth(fechaActual.getMonth() + delta);
  renderCalendar();
  cargarInsumos();
}

    let fechaActual = new Date();
    // Almacenar notas en localStorage
    let notas = JSON.parse(localStorage.getItem('notasCalendario') || '{}');
    // Variable para saber si el usuario es admin
    let esAdmin = false;

    document.addEventListener("DOMContentLoaded", async () => {
      await verificarRolUsuario(); // Esperar a verificar el rol primero
      renderCalendar();
    });

    // Verificar si el usuario es administrador
    async function verificarRolUsuario() {
      try {
        const res = await fetch("/api/user/role");
        const data = await res.json();
        esAdmin = data.isAdmin || false;
        console.log("‚úÖ Rol verificado - Es Admin:", esAdmin);
        console.log("üìä Datos del usuario:", data);
      } catch (err) {
        console.error("‚ùå Error verificando rol:", err);
        esAdmin = false;
      }
      
      // Recargar la tabla despu√©s de verificar el rol
      await cargarInsumos();
    }

    // Registrar insumo 
document.getElementById("agendaForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const datos = {
    fecha: document.getElementById("fechaInsumo").value,
    folio: document.getElementById("folio").value,
    concepto: document.getElementById("concepto").value,
    monto: document.getElementById("monto").value
  };
  try {
    const res = await fetch("/api/insumos", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(datos)
    });
    const data = await res.json();
    if (res.ok) {
      Swal.fire({
        icon: 'success',
        title: '¬°√âxito!',
        text: data.mensaje || "Insumo agregado",
        timer: 2000,
        timerProgressBar: true,
        showConfirmButton: false
      });
      cargarInsumos();
      renderCalendar();
      e.target.reset();
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: data.error || "No se pudo guardar el insumo",
        confirmButtonColor: '#e74c3c'
      });
    }
  } catch (err) { 
    console.error(err); 
    Swal.fire({
      icon: 'error',
      title: 'Error inesperado',
      text: 'Ocurri√≥ un problema al guardar el insumo',
      confirmButtonColor: '#e74c3c'
    });
  }
});

// Subir Excel
document.getElementById("uploadForm").addEventListener("change", async (e) => {
  e.preventDefault();
  const formData = new FormData(document.getElementById("uploadForm"));
  try {
    const res = await fetch("/api/insumos/upload", { method: "POST", body: formData });
    const data = await res.json();

    if (res.ok) {
      Swal.fire({
        icon: 'success',
        title: '¬°√âxito!',
        text: data.mensaje || "Archivo subido correctamente",
        timer: 2500,
        timerProgressBar: true,
        showConfirmButton: false
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: data.error || "No se pudo subir el archivo",
        confirmButtonColor: '#e74c3c'
      });
    }

    cargarInsumos();
    renderCalendar();
  } catch (err) {
    console.error(err);
    Swal.fire({
      icon: 'error',
      title: 'Error inesperado',
      text: 'Ocurri√≥ un problema al subir el archivo',
      confirmButtonColor: '#e74c3c'
    });
  }
});

    // Listar insumos del mes actual
async function cargarInsumos() {
  const tabla = document.getElementById("tablaInsumos");
  try {
    const res = await fetch("/api/insumos");
    const insumos = await res.json();

    const year = fechaActual.getFullYear();
    const month = fechaActual.getMonth();

    const filtrados = insumos.filter(i => {
      let f = i.fecha;
      if (typeof f === "string" && f.includes("T")) f = f.split("T")[0];
      const [yy, mm] = f.split("-").map(n => parseInt(n));
      return yy === year && (mm - 1) === month;
    });

    tabla.innerHTML = "";
    if (filtrados.length === 0) {
      tabla.innerHTML = `<tr><td colspan="6" class="text-muted">No hay insumos en este mes</td></tr>`;
      return;
    }

    filtrados.forEach(i => {
      const botonEliminar = esAdmin 
        ? `<button class="btn btn-delete" onclick="eliminarInsumo(${i.id})"><i class="fas fa-trash"></i></button>`
        : '-';
      
      tabla.innerHTML += `
        <tr>
          <td>${i.fecha.split("T")[0].split("-").reverse().join("/")}</td>
          <td>${i.folio}</td>
          <td>${i.concepto}</td>
          <td>$${parseFloat(i.monto).toLocaleString("es-MX", { minimumFractionDigits: 2 })}</td>
          <td>${i.archivo ? `<a href="/uploads/${encodeURIComponent(i.archivo)}" download><i class="fas fa-download"></i> Descargar</a>` : "-"}</td>
          <td>${botonEliminar}</td>
        </tr>`;
    });
  } catch (err) {
    console.error(err);
  }
}

    // Eliminar insumo 
async function eliminarInsumo(id) {
  Swal.fire({
    title: '¬øEst√°s seguro?',
    text: "No podr√°s revertir esta acci√≥n",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#e74c3c',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'S√≠, eliminar',
    cancelButtonText: 'Cancelar'
  }).then(async (result) => {
    if (result.isConfirmed) {
      try {
        const res = await fetch(`/api/insumos/${id}`, { method: "DELETE" });
        const data = await res.json();
        if (res.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Eliminado',
            text: data.mensaje || "Insumo eliminado correctamente",
            timer: 1300,
            timerProgressBar: true,
            showConfirmButton: false
          });
          cargarInsumos();
          renderCalendar();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.error || "No se pudo eliminar el insumo",
            confirmButtonColor: '#e74c3c'
          });
        }
      } catch (err) { 
        console.error(err); 
        Swal.fire({
          icon: 'error',
          title: 'Error inesperado',
          text: 'Ocurri√≥ un problema al eliminar el insumo',
          confirmButtonColor: '#e74c3c'
        });
      }
    }
  });
}

// Funci√≥n para guardar nota
function guardarNota(fecha, texto) {
  notas[fecha] = texto;
  localStorage.setItem('notasCalendario', JSON.stringify(notas));
}

// ==================== CALENDARIO CON COLORES POR ROL ====================
async function renderCalendar() {
  const calendario = document.getElementById("calendario");
  const mesActual = document.getElementById("mesActual");

  const year = fechaActual.getFullYear();
  const month = fechaActual.getMonth();

  mesActual.textContent = fechaActual.toLocaleString("es-ES", {
    month: "long",
    year: "numeric",
  });

  const primerDia = new Date(year, month, 1).getDay() || 7;
  const diasEnMes = new Date(year, month + 1, 0).getDate();

  // Traer insumos desde el backend
  let insumos = [];
  try {
    const res = await fetch("/api/insumos");
    insumos = await res.json();
  } catch (err) {
    console.error(err);
  }

  // Filtrar los insumos del mes actual
  const filtrados = insumos.filter((i) => {
    let f = i.fecha;
    if (typeof f === "string" && f.includes("T")) f = f.split("T")[0];
    const [yy, mm] = f.split("-").map((n) => parseInt(n));
    return yy === year && mm - 1 === month;
  });

  calendario.innerHTML = "";

  // Encabezados de los d√≠as
  ["Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b", "Dom"].forEach((d) => {
    calendario.innerHTML += `<div class="day-header">${d}</div>`;
  });

  // D√≠as vac√≠os antes del inicio del mes
  for (let i = 1; i < primerDia; i++) {
    calendario.innerHTML += `<div class="empty-day"></div>`;
  }

  // D√≠as del mes
  for (let d = 1; d <= diasEnMes; d++) {
    const fechaDia = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;

    const meds = filtrados.filter((i) => {
      let f = i.fecha;
      if (typeof f === "string" && f.includes("T")) f = f.split("T")[0];
      return f === fechaDia;
    });

    const totalDia = meds.reduce((sum, m) => sum + parseFloat(m.monto || 0), 0);
    const notaGuardada = notas[fechaDia] || "";

    let contenido = `<div class="calendar-day"><div class="day-number">${d}</div>`;

    // Solo mostrar etiquetas si hay insumos
    if (totalDia > 0) {
      // üîπ Asignar color seg√∫n rol
      const rolClass = esAdmin ? "admin" : "usuario";

      contenido += `
        <div class="nota-editable ${rolClass}"
             contenteditable="true"
             data-fecha="${fechaDia}"
             onblur="guardarNota('${fechaDia}', this.innerText)">
          ${notaGuardada}
        </div>
        <div class="total-dia ${rolClass}">
          <span class="label">Total del d√≠a</span>
          <span class="monto">$${totalDia.toLocaleString("es-MX", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          })}</span>
        </div>`;
    }

    contenido += "</div>";
    calendario.innerHTML += contenido;
  }
}

  </script>
</body>
</html>