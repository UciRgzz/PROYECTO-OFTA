<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agenda Quir√∫rgica</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body { background: #f5f8ff; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .card { border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 25px; }
    .card-header { background: #2c3e50; color: white; font-weight: bold; display: flex; align-items: center; }
    table th { background: #f0f2f5; }
    table td, table th { text-align: center; }

    .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; padding: 15px; background: white; border-radius: 10px; }
    .current-month { font-size: 1.5rem; font-weight: 600; color: #2c3e50; }
    .nav-btn { background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
    .day-header { text-align: center; padding: 8px; background: #2c3e50; color: white; border-radius: 6px; }
    .calendar-day { background: white; border-radius: 8px; min-height: 120px; padding: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .day-number { font-weight: 600; margin-bottom: 5px; color: #2c3e50; }

    /* Colores por tipo de procedimiento */
      .proc-catarata { background: #fff3e0; border-left: 4px solid #e46bf6; }   /* Cirug√≠a de Catarata - naranja */
      .proc-consulta { background: #e3f2fd; border-left: 4px solid #2196f3; }   /* Consulta Oftalmol√≥gica - azul */
      .proc-lente    { background: #e8f5e9; border-left: 4px solid #fbf866; }   /* Lente Intraocular - verde */


    .insumo-item { padding: 6px; margin-bottom: 6px; border-radius: 5px; font-size: 0.85rem; }
    .insumo-name { font-weight: 600; }
    .insumo-info { font-size: 0.8rem; color: #555; }
  </style>
</head>
<body>
  <div class="container">
    <header class="mb-4">
      <h1 class="text-center"><i class="fas fa-calendar-check"></i> Agenda Quir√∫rgica</h1>
    </header>

    <!-- Tabla de √≥rdenes -->
    <div class="card">
      <div class="card-header"><i class="fas fa-list me-2"></i> √ìrdenes de Cirug√≠a</div>
      <div class="card-body">
        <table class="table table-bordered table-striped align-middle">
          <thead>
            <tr>
              <th>Expediente</th>
              <th>Edad</th>
              <th>Nombre</th>
              <th>Procedimiento</th>
              <th>Total Orden</th>
              <th>Pagos Realizados</th>
              <th>Diferencia</th>
              <th>Status</th>
              <th>Tipo de Lente</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaOrdenes"></tbody>
        </table>
      </div>
    </div>

    <!-- Modal Calendario -->
<div class="modal fade" id="modalCalendario" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title"><i class="fas fa-calendar"></i> Calendario de Cirug√≠as</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="calendar-nav mb-3">
          <button class="nav-btn" onclick="cambiarMesCirugia(-1)">
            <i class="fas fa-chevron-left"></i> Mes anterior
          </button>
          <div class="current-month" id="mesCirugia"></div>
          <button class="nav-btn" onclick="cambiarMesCirugia(1)">
            Mes siguiente <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div class="calendar" id="calendarioCirugias"></div>
      </div>
    </div>
  </div>
</div>


  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/js/all.min.js"></script>

<script>
    
// ====================== TABLA ======================
async function cargarOrdenes(year, month) {
  try {
    const res = await fetch('/api/ordenes');
    let ordenes = await res.json();

    // üîπ Si hay a√±o/mes, filtramos por ese mes
    if (year !== undefined && month !== undefined) {
      ordenes = ordenes.filter(o => {
        if (!o.fecha_cirugia) return true; // mostrar tambi√©n las que a√∫n no tienen fecha
        const f = new Date(o.fecha_cirugia);
        return f.getFullYear() === year && f.getMonth() === month;
      });
    }

    document.getElementById("tablaOrdenes").innerHTML = ordenes.map(o => `
      <tr>
        <td>${o.expediente}</td>
        <td>${o.edad}</td>
        <td>${o.nombre}</td>
        <td>${o.procedimiento}</td>
        <td>$${o.total}</td>
        <td>$${o.pagos}</td>
        <td>$${o.total - o.pagos}</td>
        <td>${o.status}</td>
        <td>
          ${o.tipo_lente 
            ? `<span class="badge bg-info text-dark" style="cursor:pointer" onclick="editarLente(${o.id}, '${o.tipo_lente}')">${o.tipo_lente}</span>` 
            : `<button class="btn btn-sm btn-secondary" 
                      onclick="editarLente(${o.id}, '')">
                 <i class="fas fa-plus-circle"></i> A√±adir Lente
               </button>`}
        </td>
        <td>
          ${o.fecha_cirugia ? 
            '<span class="text-muted">Asignado</span>' : 
            `<button class="btn btn-sm btn-primary" 
                    onclick="abrirCalendario(${o.id})">
              <i class="fas fa-calendar-plus"></i> Agendar
            </button>
            `}
          ${o.fecha_cirugia ? `
            <button class="btn btn-sm btn-warning mt-1" 
                    onclick="editarCirugia(${o.id})">
              <i class="fas fa-edit"></i> Reprogramar
            </button>
          ` : ''}
        </td>
      </tr>
    `).join('');
  } catch (err) {
    console.error("Error cargando √≥rdenes:", err);
  }
}

// ====================== CALENDARIO ======================
let fechaCirugia = new Date();

document.addEventListener("DOMContentLoaded", () => {
  renderCalendarCirugias(); // carga inicial
});

function getColorClass(proc) {
  const texto = proc.toLowerCase();

  if (texto.includes("catarata")) return "proc-catarata";   // Cirug√≠a de Catarata
  if (texto.includes("consulta")) return "proc-consulta";   // Consulta Oftalmol√≥gica
  if (texto.includes("lente"))    return "proc-lente";      // Lente Intraocular

  return ""; // si llega otro tipo
}


async function renderCalendarCirugias() {
  const calendario = document.getElementById("calendarioCirugias");
  const mesActual = document.getElementById("mesCirugia");

  const year = fechaCirugia.getFullYear();
  const month = fechaCirugia.getMonth();

  mesActual.textContent = fechaCirugia.toLocaleString("es-ES", { month: "long", year: "numeric" });

  const primerDia = new Date(year, month, 1).getDay() || 7;
  const diasEnMes = new Date(year, month + 1, 0).getDate();

  let cirugias = [];
  try {
    const res = await fetch("/api/cirugias");
    cirugias = await res.json();
  } catch (err) { console.error(err); }

  const filtradas = cirugias.filter(c => {
    const f = new Date(c.fecha);
    return f.getFullYear() === year && f.getMonth() === month;
  });

  calendario.innerHTML = "";

  ["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"].forEach(d => {
    calendario.innerHTML += `<div class="day-header">${d}</div>`;
  });

  for (let i = 1; i < primerDia; i++) {
    calendario.innerHTML += `<div class="empty-day"></div>`;
  }

  for (let d = 1; d <= diasEnMes; d++) {
    const fechaDia = new Date(year, month, d).toISOString().split("T")[0];
    const programadas = filtradas.filter(c => c.fecha.startsWith(fechaDia));

    let contenido = `<div class="calendar-day" onclick="asignarFecha('${fechaDia}')">
                   <div class="day-number">${d}</div>`;
    if (programadas.length > 0) {
      programadas.forEach(c => {
        contenido += `
          <div class="insumo-item ${getColorClass(c.procedimiento)}">
            <div class="insumo-name">${c.nombre}</div>
            <div class="insumo-info">Proc: ${c.procedimiento}</div>
            <div class="insumo-info">Dr: ${c.medico}</div>
            ${c.tipo_lente ? `<div class="insumo-info">Lente: ${c.tipo_lente}</div>` : ""}
            <button class="btn btn-sm btn-danger mt-1" onclick="eliminarCirugia(${c.id})">
              <i class="fas fa-trash"></i> Eliminar
            </button>
          </div>`;
      });
    }
    contenido += "</div>";
    calendario.innerHTML += contenido;
  }

  // üîπ Refrescar la tabla tambi√©n
  cargarOrdenes(year, month);
}

function cambiarMesCirugia(offset) {
  fechaCirugia.setMonth(fechaCirugia.getMonth() + offset);
  renderCalendarCirugias();
}

// ==================== AGENDAR CIRUG√çA (con selector de fecha) ====================
function agendarCirugia(idOrden) {
  Swal.fire({
    title: 'Asignar fecha de cirug√≠a',
    input: 'date',
    showCancelButton: true,
    confirmButtonText: 'Asignar',
    cancelButtonText: 'Cancelar'
  }).then(async (result) => {
    if (result.isConfirmed) {
      const fecha = result.value;
      try {
        await fetch(`/api/ordenes/${idOrden}/agendar`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fecha_cirugia: fecha })
        });
        Swal.fire('‚úÖ Cirug√≠a agendada');
        renderCalendarCirugias();
      } catch (err) {
        console.error("Error al agendar:", err);
      }
    }
  });
}

function editarCirugia(idOrden) {
  ordenSeleccionada = idOrden; // guardamos la orden que se va a reprogramar
  const modal = new bootstrap.Modal(document.getElementById("modalCalendario"));
  modal.show();
}


// ==================== EDITAR TIPO DE LENTE ====================
function editarLente(idOrden, tipoActual) {
  Swal.fire({
    title: tipoActual ? 'Editar Tipo de Lente' : 'A√±adir Tipo de Lente',
    input: 'text',
    inputValue: tipoActual || '',
    inputPlaceholder: 'Ejemplo: Lente Intraocular',
    showCancelButton: true,
    confirmButtonText: 'Guardar',
    cancelButtonText: 'Cancelar',
    preConfirm: (valor) => {
      if (!valor.trim()) {
        Swal.showValidationMessage('Debes ingresar un tipo de lente');
      }
      return valor;
    }
  }).then(async (result) => {
    if (result.isConfirmed) {
      try {
        await fetch(`/api/ordenes/${idOrden}/lente`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ tipo_lente: result.value })
        });
        Swal.fire('‚úÖ Guardado', 'El tipo de lente fue actualizado correctamente.', 'success');
        renderCalendarCirugias(); // refresca tabla y calendario
      } catch (err) {
        console.error("Error al actualizar tipo de lente:", err);
        Swal.fire('‚ùå Error', 'No se pudo actualizar el tipo de lente.', 'error');
      }
    }
  });
}

let ordenSeleccionada = null;

function abrirCalendario(idOrden) {
  ordenSeleccionada = idOrden;
  const modal = new bootstrap.Modal(document.getElementById("modalCalendario"));
  modal.show();
}
renderCalendarCirugias(); // carga inicial del calendario

// ==================== ASIGNAR FECHA DESDE EL CALENDARIO ====================
async function asignarFecha(fecha) {
  if (!ordenSeleccionada) return;

  try {
    await fetch(`/api/ordenes/${ordenSeleccionada}/agendar`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ fecha_cirugia: fecha })
    });
    Swal.fire("‚úÖ Cirug√≠a asignada", `Fecha: ${fecha}`, "success");

    ordenSeleccionada = null; // limpiar selecci√≥n
    renderCalendarCirugias();

    // Cierra el modal despu√©s de asignar
    const modal = bootstrap.Modal.getInstance(document.getElementById("modalCalendario"));
    modal.hide();
  } catch (err) {
    console.error("Error al asignar cirug√≠a:", err);
    Swal.fire("‚ùå Error", "No se pudo asignar la cirug√≠a", "error");
  }
}



// ==================== ELIMINAR CIRUG√çA (con confirmaci√≥n) ====================
function eliminarCirugia(idOrden) {
  Swal.fire({
    title: '¬øEliminar cirug√≠a?',
    text: "Esta acci√≥n no se puede deshacer.",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'S√≠, eliminar',
    cancelButtonText: 'Cancelar'
  }).then(async (result) => {
    if (result.isConfirmed) {
      try {
        await fetch(`/api/ordenes/${idOrden}/agendar`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fecha_cirugia: null }) // quitamos la fecha
        });
        Swal.fire('üóëÔ∏è Eliminada', 'Cirug√≠a eliminada del calendario.', 'success');
        renderCalendarCirugias(); 
      } catch (err) {
        console.error("Error al eliminar cirug√≠a:", err);
        Swal.fire('‚ùå Error', 'No se pudo eliminar la cirug√≠a.', 'error');
      }
    }
  });
}

</script>


</body>
</html>
