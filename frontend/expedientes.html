<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Expedientes</title>
    <link rel="icon" type="image/png" href="/uploads/logo-oftavision2.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root {
  --primary-color: #2c3e50;
  --secondary-color: #3498db;
  --accent-color: #e74c3c;
  --success-color: #27ae60;
  --light-color: #f8f9fa;
  --dark-color: #343a40;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #f0f5ff 0%, #e3f2fd 100%);
  padding: 20px;
  color: #333;
  min-height: 100vh;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
}

header {
  text-align: center;
  margin-bottom: 20px;
  padding: 8px 15px;
  background: linear-gradient(135deg, #1e3a52 0%, #2c5f7f 100%);
  color: white;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

h1 {
  font-size: 1.6rem;
  margin-bottom: 2px;
  font-weight: 700;
}

.card {
  background: white;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  margin-bottom: 20px;
  overflow: hidden;
  border: none;
}

.card-header {
  background: linear-gradient(135deg, var(--primary-color) 0%, #3d5061 100%);
  color: white;
  padding: 12px 18px;
  font-size: 1.1rem;
  font-weight: 600;
  display: flex;
  align-items: center;
}

.card-header i {
  margin-right: 10px;
  font-size: 1.2rem;
}

.card-body {
  padding: 18px;
}

.form-group {
  margin-bottom: 18px;
}

label {
  font-weight: 600;
  margin-bottom: 6px;
  color: var(--primary-color);
  font-size: 0.9rem;
}

input, select {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 0.9rem;
  width: 100%;
  transition: all 0.3s;
}

input:focus, select:focus {
  border-color: var(--secondary-color);
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
  outline: none;
}

.btn {
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  font-size: 0.9rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn-primary {
  background: linear-gradient(135deg, var(--secondary-color) 0%, #2c80b9 100%);
  color: white;
  box-shadow: 0 3px 8px rgba(52, 152, 219, 0.3);
}
.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
}

.btn-success {
  background: linear-gradient(135deg, var(--success-color) 0%, #219653 100%);
  color: white;
  box-shadow: 0 3px 8px rgba(39, 174, 96, 0.3);
}
.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
}

.btn-danger {
  background: linear-gradient(135deg, var(--accent-color) 0%, #c0392b 100%);
  color: white;
  box-shadow: 0 3px 8px rgba(231, 76, 60, 0.3);
}
.btn-danger:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
}

.btn-warning {
  background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
  color: white;
  box-shadow: 0 3px 8px rgba(243, 156, 18, 0.3);
}
.btn-warning:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(243, 156, 18, 0.4);
}

.table {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
  background: white;
  border-radius: 6px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}
.table th {
  background: linear-gradient(135deg, var(--primary-color) 0%, #3d5061 100%);
  color: white;
  padding: 10px;
  text-align: center;
  font-weight: 600;
  font-size: 0.85rem;
}
.table td {
  padding: 8px;
  border-bottom: 1px solid #eee;
  text-align: center;
  font-size: 0.8rem;
  vertical-align: middle;
}
.table tr:last-child td {
  border-bottom: none;
}
.table tr:nth-child(odd) {
  background: #f9f9f9;
}
.table tr:hover {
  background-color: #eef6ff;
}

.table .btn {
  width: 28px !important;
  height: 28px !important;
  padding: 0 !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  border-radius: 5px !important;
}
.table .btn i {
  margin: 0 !important;
  font-size: 13px !important;
}
.table .d-flex.gap-1 {
  justify-content: center;
  gap: 4px !important;
}

.badge {
  padding: 4px 8px;
  border-radius: 5px;
  font-size: 0.75rem;
  font-weight: 600;
}
.badge.bg-info {
  background: linear-gradient(135deg, var(--secondary-color) 0%, #2c80b9 100%) !important;
}
.badge.bg-success {
  background: linear-gradient(135deg, var(--success-color) 0%, #219653 100%) !important;
}
.badge.bg-warning {
  background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%) !important;
  color: white !important;
}
.badge.bg-danger {
  background: linear-gradient(135deg, var(--accent-color) 0%, #c0392b 100%) !important;
}

.search-section {
  display: flex;
  gap: 8px;
  align-items: center;
  position: relative;
  flex: 1;
  max-width: 600px;
}
.search-section input {
  padding: 8px 12px 8px 38px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 0.9rem;
  width: 100%;
  transition: all 0.3s;
}
.search-section input:focus {
  border-color: var(--secondary-color);
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
  outline: none;
}
.search-section i.fa-search {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #999;
  font-size: 1rem;
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 18px;
  padding: 12px 15px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
}

#expedienteForm {
  background: white;
  padding: 18px;
  border-radius: 8px;
  margin-bottom: 18px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
}

.footer {
  text-align: center;
  margin-top: 30px;
  color: #6c757d;
  font-size: 0.85rem;
}

.swal2-html-container table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  background: #fdfdfd;
  border-radius: 6px;
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
}

.swal2-html-container th {
  background: linear-gradient(135deg, #4a637d 0%, #32475b 100%);
  color: #fff;
  padding: 8px;
  text-align: left;
  font-weight: 600;
  font-size: 0.85rem;
}

.swal2-html-container td {
  background: #fafafa;
  color: #333;
  padding: 8px;
  border-bottom: 1px solid #e5e5e5;
  font-size: 0.8rem;
}

.swal2-html-container tr:nth-child(even) td {
  background: #f2f7fb;
}

.swal2-html-container tr:last-child td {
  border-bottom: none;
}

.swal2-html-container hr {
  border: none;
  border-top: 2px solid #dce3eb;
  margin: 18px 0;
}

@media (max-width: 768px) {
  h1 {
    font-size: 1.4rem;
  }
  .table-responsive {
    overflow-x: auto;
  }
  .card-header {
    font-size: 1rem;
    padding: 10px 12px;
  }
  .btn {
    width: 100%;
    margin-bottom: 8px;
  }
  .top-bar {
    flex-direction: column;
    gap: 12px;
  }
  .search-section {
    width: 100%;
  }
  .search-section input {
    width: 100%;
  }
  .form-row {
    grid-template-columns: 1fr;
  }
}
</style>


</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-folder"></i> Gesti√≥n de Expedientes</h1>
        </header>

        <div class="top-bar">
            <div class="search-section">
                <i class="fas fa-search"></i>
                <input type="text" id="buscarInput" placeholder="Buscar por n√∫mero de expediente o nombre...">
            </div>
            <button class="btn btn-success" onclick="nuevoExpediente()">
                <i class="fas fa-plus"></i> Nuevo Expediente
            </button>
        </div>

        <div class="card" id="expedienteForm" style="display:none;">
            <div class="card-header">
                <i class="fas fa-file-medical"></i> Formulario de Expediente
            </div>
            <div class="card-body">
                <form onsubmit="guardarExpediente(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>N√∫mero de Expediente:</label>
                            <input type="text" id="numero_expediente" readonly placeholder="Se generar√° autom√°ticamente">
                        </div>
                        
                        <div class="form-group">
                            <label>Nombre Completo:</label>
                            <input type="text" id="nombre" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Fecha de Nacimiento:</label>
                            <input type="date" id="fecha_nacimiento" required onchange="calcularEdad()">
                        </div>
                        
                        <div class="form-group">
                            <label>Edad:</label>
                            <input type="number" id="edad" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label>Padecimientos:</label>
                            <select id="padecimientos" required>
                                <option value="">Seleccione...</option>
                                <option value="DIABETES">DIABETES</option>
                                <option value="HIPERTENSO">HIPERTENSO</option>
                                <option value="NINGUNO">NINGUNO</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Colonia:</label>
                            <input type="text" id="colonia">
                        </div>
                        
                        <div class="form-group">
                            <label>Ciudad:</label>
                            <input type="text" id="ciudad">
                        </div>
                        
                        <div class="form-group">
                            <label>Tel√©fono 1:</label>
                            <input type="text" id="telefono1">
                        </div>
                        
                        <div class="form-group">
                            <label>Tel√©fono 2:</label>
                            <input type="text" id="telefono2">
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                        <button type="button" class="btn btn-danger" onclick="cancelarFormulario()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card" id="tablaExpedientes">
            <div class="card-header">
                <i class="fas fa-list"></i> Lista de Expedientes
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>N√∫mero</th>
                                <th>Nombre</th>
                                <th>Edad</th>
                                <th>Padecimiento</th>
                                <th>Colonia</th>
                                <th>Ciudad</th>
                                <th>Tel. 1</th>
                                <th>Tel. 2</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="listaExpedientes"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Sistema de Gesti√≥n Oftavisi√≥n ¬© 2025</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Obtener rol del usuario desde el servidor
window.usuarioRol = "usuario"; // valor por defecto (sin let)

async function obtenerRolUsuario() {
  try {
    const res = await fetch('/api/check-session', { credentials: 'include' });
    if (res.ok) {
      const data = await res.json();
      window.usuarioRol = data.usuario?.rol || "usuario";
      console.log(" ROL DETECTADO:", window.usuarioRol);
    }
  } catch (err) {
    console.error("Error obteniendo rol:", err);
    window.usuarioRol = "usuario";
  }
}

// Llamar esta funci√≥n antes de cargar expedientes
document.addEventListener('DOMContentLoaded', async function() {
    await obtenerRolUsuario(); 
    cargarExpedientes();
    
    const inputBuscar = document.getElementById('buscarInput');
    
    if (inputBuscar) {
        // ‚úÖ B√öSQUEDA AUTOM√ÅTICA mientras escribe
        inputBuscar.addEventListener('input', function(e) {
            const valor = e.target.value.trim();
            if (valor === '') {
                cargarExpedientes();
            } else {
                buscarExpediente();
            }
        });
    }
});
console.log("ROL DETECTADO:", window.usuarioRol);

// Funci√≥n para cargar expedientes
async function cargarExpedientes() {
    try {
        const res = await fetch('/api/expedientes', { credentials: 'include' });
        const data = await res.json();
        const tbody = document.getElementById('listaExpedientes');
        tbody.innerHTML = '';

        data.forEach(exp => {
            const nombreEscapado = exp.nombre_completo.replace(/'/g, "\\'");
            
            tbody.innerHTML += `
                <tr>
                    <td>${exp.numero_expediente}</td>
                    <td>${exp.nombre_completo}</td>
                    <td>${exp.edad}</td>
                    <td><span class="badge bg-info">${exp.padecimientos}</span></td>
                    <td>${exp.colonia}</td>
                    <td>${exp.ciudad}</td>
                    <td>${exp.telefono1}</td>
                    <td>${exp.telefono2 || ''}</td>
                    <td>
                        <div class="d-flex justify-content-center gap-1 flex-nowrap">
                            <button class="btn btn-primary btn-sm" title="Editar" 
                                    onclick="editarExpediente(${exp.numero_expediente}, '${exp.departamento}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" title="M√©dico" 
                                    onclick="verMedico(${exp.numero_expediente}, '${nombreEscapado}')">
                                <i class="fas fa-stethoscope"></i>
                            </button>
                            <button class="btn btn-info btn-sm" title="Optometr√≠a" 
                                    onclick="verOptometria(${exp.numero_expediente}, '${nombreEscapado}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${window.usuarioRol === "admin"
                                ? `<button class="btn btn-danger btn-sm" title="Eliminar" 
                                        onclick="eliminarExpediente(${exp.numero_expediente}, '${exp.departamento}')">
                                    <i class="fas fa-trash"></i>
                                   </button>`
                                : ""}
                        </div>
                    </td>
                </tr>
            `;
        });
    } catch (err) {
        console.error("‚ùå Error al cargar expedientes:", err);
    }
}

// Funci√≥n para nuevo expediente
async function nuevoExpediente() {
    const form = document.querySelector('#expedienteForm form');
    if (form) form.reset();
    
    const inputNumero = document.getElementById('numero_expediente');
    inputNumero.value = ''; // ‚Üê VAC√çO = CREACI√ìN
    delete inputNumero.dataset.departamento;
    
    // Obtener el siguiente n√∫mero para mostrarlo en el placeholder
    try {
        const res = await fetch('/api/expedientes', { credentials: 'include' });
        const data = await res.json();
        
        let maxId = 0;
        data.forEach(exp => {
            if (exp.numero_expediente > maxId) {
                maxId = exp.numero_expediente;
            }
        });
        
        const siguienteNumero = maxId + 1;
        inputNumero.placeholder = `Se generar√° el n√∫mero ${siguienteNumero}`;
    } catch (err) {
        console.error("Error obteniendo siguiente ID:", err);
        inputNumero.placeholder = 'Se generar√° autom√°ticamente';
    }
    
    document.getElementById('expedienteForm').style.display = 'block';
    document.getElementById('tablaExpedientes').style.display = 'none';
    
    setTimeout(() => {
        document.getElementById('expedienteForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
}

// Funci√≥n para cancelar el formulario
function cancelarFormulario() {
    document.getElementById('expedienteForm').style.display = 'none';
    document.getElementById('tablaExpedientes').style.display = 'block';
}

// Funci√≥n para calcular edad autom√°ticamente
function calcularEdad() {
    const fecha = document.getElementById('fecha_nacimiento').value;
    if (fecha) {
        const nacimiento = new Date(fecha);
        const hoy = new Date();
        let edad = hoy.getFullYear() - nacimiento.getFullYear();
        const mes = hoy.getMonth() - nacimiento.getMonth();
        if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) edad--;
        document.getElementById('edad').value = edad;
    }
}

// Funci√≥n para editar expediente
async function editarExpediente(numero, departamento) {
    try {
        console.log(" Editando expediente:", numero, "Departamento:", departamento);
        
        const res = await fetch(`/api/expedientes/${numero}?departamento=${encodeURIComponent(departamento)}`, {
            method: 'GET',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
        });

        console.log("üì° Respuesta del servidor:", res.status);

        if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            Swal.fire({ 
                icon: 'error', 
                title: 'Error', 
                text: errorData.error || 'No se pudo cargar el expediente' 
            });
            return;
        }

        const data = await res.json();
        console.log(" Datos recibidos:", data);

        const inputNumero = document.getElementById('numero_expediente');
        inputNumero.value = data.numero_expediente || '';
        inputNumero.placeholder = ''; // ‚Üê Limpiar placeholder al editar
        inputNumero.dataset.departamento = data.departamento;
        
        document.getElementById('nombre').value = data.nombre_completo || '';
        
        if (data.fecha_nacimiento) {
            const fecha = data.fecha_nacimiento.split('T')[0];
            document.getElementById('fecha_nacimiento').value = fecha;
        }
        
        document.getElementById('edad').value = data.edad || '';
        document.getElementById('padecimientos').value = data.padecimientos || '';
        document.getElementById('colonia').value = data.colonia || '';
        document.getElementById('ciudad').value = data.ciudad || '';
        document.getElementById('telefono1').value = data.telefono1 || '';
        document.getElementById('telefono2').value = data.telefono2 || '';

        document.getElementById('expedienteForm').style.display = 'block';
        document.getElementById('tablaExpedientes').style.display = 'none';

        setTimeout(() => {
            document.getElementById('expedienteForm').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }, 100);

    } catch (err) {
        console.error("‚ùå Error al cargar expediente:", err);
        Swal.fire({ 
            icon: 'error', 
            title: 'Error', 
            text: 'Error de conexi√≥n al cargar el expediente' 
        });
    }
}

// Funci√≥n para guardar expediente (crear o actualizar)
async function guardarExpediente(e) {
    e.preventDefault();
    
    const inputNumero = document.getElementById('numero_expediente');
    const numero = inputNumero.value.trim();
    const departamento = inputNumero.dataset.departamento;
    
    const expediente = {
        nombre_completo: document.getElementById('nombre').value,
        fecha_nacimiento: document.getElementById('fecha_nacimiento').value,
        edad: parseInt(document.getElementById('edad').value),
        padecimientos: document.getElementById('padecimientos').value,
        colonia: document.getElementById('colonia').value,
        ciudad: document.getElementById('ciudad').value,
        telefono1: document.getElementById('telefono1').value,
        telefono2: document.getElementById('telefono2').value
    };
    
    // Solo incluir departamento si estamos editando
    if (numero && departamento) {
        expediente.departamento = departamento;
    }

    const url = numero ? `/api/expedientes/${numero}` : '/api/expedientes';
    const method = numero ? 'PUT' : 'POST';

    console.log(` ${method} a ${url}`, expediente);

    try {
        const res = await fetch(url, {
            method: method,
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(expediente)
        });

        const data = await res.json();

        if (res.ok) {
            await Swal.fire({
                icon: 'success',
                title: numero ? ' Expediente actualizado' : ' Expediente creado',
                text: numero ? `N√∫mero: ${numero}` : `N√∫mero: ${data.expediente?.numero_expediente}`,
                timer: 2000,
                showConfirmButton: false
            });
            
            await cargarExpedientes();
            cancelarFormulario();
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.error || 'No se pudo guardar el expediente'
            });
        }
    } catch (err) {
        console.error("‚ùå Error guardando:", err);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error de conexi√≥n'
        });
    }
}

// Funci√≥n para buscar expediente (AUTOM√ÅTICA)
async function buscarExpediente() {
    const busqueda = document.getElementById('buscarInput').value.trim();
    
    if (!busqueda) {
        return cargarExpedientes();
    }

    try {
        const res = await fetch(`/api/expedientes/buscar?q=${encodeURIComponent(busqueda)}`, {
            credentials: 'include'
        });
        
        if (!res.ok) {
            document.getElementById('listaExpedientes').innerHTML = 
                `<tr><td colspan="9">No se encontraron resultados</td></tr>`;
            return;
        }

        const data = await res.json();
        const tbody = document.getElementById('listaExpedientes');
        tbody.innerHTML = '';

        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9">No se encontraron expedientes</td></tr>`;
            return;
        }

        data.forEach(exp => {
            const nombreEscapado = exp.nombre_completo.replace(/'/g, "\\'");
            
            tbody.innerHTML += `
                <tr>
                    <td>${exp.numero_expediente}</td>
                    <td>${exp.nombre_completo}</td>
                    <td>${exp.edad}</td>
                    <td><span class="badge bg-info">${exp.padecimientos}</span></td>
                    <td>${exp.colonia}</td>
                    <td>${exp.ciudad}</td>
                    <td>${exp.telefono1}</td>
                    <td>${exp.telefono2 || ''}</td>
                    <td>
                        <div class="d-flex gap-1 justify-content-center">
                            <button class="btn btn-primary btn-sm" title="Editar" 
                                    onclick="editarExpediente(${exp.numero_expediente}, '${exp.departamento}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" title="M√©dico" 
                                    onclick="verMedico(${exp.numero_expediente}, '${nombreEscapado}')">
                                <i class="fas fa-stethoscope"></i>
                            </button>
                            <button class="btn btn-info btn-sm" title="Optometr√≠a" 
                                    onclick="verOptometria(${exp.numero_expediente}, '${nombreEscapado}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${window.usuarioRol === "admin" 
                                ? `<button class="btn btn-danger btn-sm" title="Eliminar" 
                                        onclick="eliminarExpediente(${exp.numero_expediente}, '${exp.departamento}')">
                                    <i class="fas fa-trash"></i>
                                   </button>` 
                                : ""}
                        </div>
                    </td>
                </tr>
            `;
        });

    } catch (err) {
        console.error("Error en b√∫squeda:", err);
        document.getElementById('listaExpedientes').innerHTML = 
            `<tr><td colspan="9">Error al realizar la b√∫squeda</td></tr>`;
    }
}


// Funci√≥n para ver √≥rdenes m√©dicas
async function verMedico(expedienteId, nombre) {
  try {
    const res = await fetch(`/api/expedientes/${expedienteId}/ordenes`, { credentials: 'include' });
    const data = await res.json();

    if (!data.length) {
      Swal.fire({
        icon: 'info',
        title: 'Sin √≥rdenes',
        text: 'No hay √≥rdenes m√©dicas registradas para este expediente.'
      });
      return;
    }

    let contenido = "";
    data.forEach((orden, idx) => {
      // Formatear fecha correctamente (sin desfase UTC)
      const fechaOrden = orden.fecha_orden || orden.fecha_cirugia || orden.fecha_agendada || orden.fecha;
      let fechaFormateada = 'No asignada';
      if (fechaOrden) {
        const [year, month, day] = fechaOrden.split('T')[0].split('-');
        fechaFormateada = `${day}/${month}/${year}`;
      }

      // Formatear hora correctamente
      let horaFormateada = 'N/A';
      if (orden.hora_tp) {
        const [hora, minuto] = orden.hora_tp.split(':');
        const horaNum = parseInt(hora);
        const periodo = horaNum >= 12 ? 'p.m.' : 'a.m.';
        const hora12 = horaNum % 12 || 12;
        horaFormateada = `${hora12.toString().padStart(2, '0')}:${minuto} ${periodo}`;
      }

      contenido += `
        <h4 class="mt-3">Orden #${orden.numero_orden || idx + 1} ${idx === 0 ? '(M√°s reciente)' : ''}</h4>
        <table class="table table-bordered">
          <tr><th>M√©dico</th><td>${orden.medico || 'N/A'}</td></tr>
          <tr><th>Diagn√≥stico</th><td>${orden.diagnostico || 'N/A'}</td></tr>
          <tr><th>Lado</th><td>${orden.lado || 'N/A'}</td></tr>
          <tr><th>Procedimiento</th><td>${orden.procedimiento || 'N/A'}</td></tr>
          <tr><th>Precio</th><td>$${orden.precio || '0.00'}</td></tr>
          <tr><th>Estatus</th><td>${orden.estatus || 'Pendiente'}</td></tr>
          <tr><th>Fecha</th><td>${fechaFormateada}</td></tr>
          ${orden.anexos ? `<tr><th>Anexos</th><td>${orden.anexos}</td></tr>` : ''}
          ${orden.conjuntiva ? `<tr><th>Conjuntiva</th><td>${orden.conjuntiva}</td></tr>` : ''}
          ${orden.cornea ? `<tr><th>C√≥rnea</th><td>${orden.cornea}</td></tr>` : ''}
          ${orden.camara_anterior ? `<tr><th>C√°mara Anterior</th><td>${orden.camara_anterior}</td></tr>` : ''}
          ${orden.cristalino ? `<tr><th>Cristalino</th><td>${orden.cristalino}</td></tr>` : ''}
          ${orden.retina ? `<tr><th>Retina</th><td>${orden.retina}</td></tr>` : ''}
          ${orden.macula ? `<tr><th>M√°cula</th><td>${orden.macula}</td></tr>` : ''}
          ${orden.nervio_optico ? `<tr><th>Nervio √ìptico</th><td>${orden.nervio_optico}</td></tr>` : ''}
          ${orden.ciclopejia ? `<tr><th>Cicloplejia</th><td>${orden.ciclopejia}</td></tr>` : ''}
          ${orden.hora_tp ? `<tr><th>Hora T.P.</th><td>${horaFormateada}</td></tr>` : ''}
          ${orden.problemas ? `<tr><th>Problemas</th><td>${orden.problemas}</td></tr>` : ''}
          ${orden.plan ? `<tr><th>Plan</th><td>${orden.plan}</td></tr>` : ''}
        </table>
        <hr/>
      `;
    });

    Swal.fire({
      title: `√ìrdenes de ${nombre} (Expediente ${expedienteId})`,
      html: contenido,
      width: '70%',
      confirmButtonText: 'Cerrar'
    });
  } catch (error) {
    console.error("Error al cargar √≥rdenes m√©dicas:", error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudieron cargar las √≥rdenes m√©dicas.'
    });
  }
}

// Funci√≥n para ver evaluaciones de optometr√≠a
async function verOptometria(expedienteId, nombre) {
    const res = await fetch(`/api/expedientes/${expedienteId}/optometria`, { credentials: 'include' });
    const data = await res.json();

    if (!data.length) {
        Swal.fire({
            icon: 'info',
            title: 'Sin registros',
            text: 'No hay evaluaciones de optometr√≠a registradas para este expediente.'
        });
        return;
    }

    let contenido = "";
    data.forEach((opto, idx) => {
        let fechaFormateada = 'No registrada';
        if (opto.fecha) {
            const fecha = opto.fecha.split('T')[0];
            const [a√±o, mes, dia] = fecha.split('-');
            fechaFormateada = `${dia}/${mes}/${a√±o}`;
        }
        
        contenido += `
        <h4 class="mt-3">Evaluaci√≥n #${opto.id} ${idx === 0 ? '(M√°s reciente)' : ''}</h4>
        <table class="table table-bordered">
            <tr><th colspan="2" class="table-secondary text-center">Ojo Derecho (OD)</th></tr>
            <tr><th>Esfera</th><td>${opto.esfera_od || 'N/A'}</td></tr>
            <tr><th>Cilindro</th><td>${opto.cilindro_od || 'N/A'}</td></tr>
            <tr><th>Eje</th><td>${opto.eje_od || 'N/A'}</td></tr>
            <tr><th>AVcC</th><td>${opto.avcc_od || 'N/A'}</td></tr>
            <tr><th>Adici√≥n</th><td>${opto.adicion_od || 'N/A'}</td></tr>
            <tr><th>AVcC2</th><td>${opto.avcc2_od || 'N/A'}</td></tr>
            <tr><th>AV Lejos</th><td>${opto.av_lejos_od1 || 'N/A'} - ${opto.av_lejos_od2 || 'N/A'} - ${opto.av_lejos_od3 || 'N/A'}</td></tr>
            <tr><th>AV Cerca</th><td>${opto.av_cerca_od1 || 'N/A'} - ${opto.av_cerca_od2 || 'N/A'}</td></tr>
            <tr><th>AV Con Lentes</th><td>${opto.av_lentes_od1 || 'N/A'} - ${opto.av_lentes_od2 || 'N/A'}</td></tr>

            <tr><th colspan="2" class="table-secondary text-center">Ojo Izquierdo (OI)</th></tr>
            <tr><th>Esfera</th><td>${opto.esfera_oi || 'N/A'}</td></tr>
            <tr><th>Cilindro</th><td>${opto.cilindro_oi || 'N/A'}</td></tr>
            <tr><th>Eje</th><td>${opto.eje_oi || 'N/A'}</td></tr>
            <tr><th>AVcC</th><td>${opto.avcc_oi || 'N/A'}</td></tr>
            <tr><th>Adici√≥n</th><td>${opto.adicion_oi || 'N/A'}</td></tr>
            <tr><th>AVcC2</th><td>${opto.avcc2_oi || 'N/A'}</td></tr>
            <tr><th>AV Lejos</th><td>${opto.av_lejos_oi1 || 'N/A'} - ${opto.av_lejos_oi2 || 'N/A'} - ${opto.av_lejos_oi3 || 'N/A'}</td></tr>
            <tr><th>AV Cerca</th><td>${opto.av_cerca_oi1 || 'N/A'} - ${opto.av_cerca_oi2 || 'N/A'}</td></tr>
            <tr><th>AV Con Lentes</th><td>${opto.av_lentes_oi1 || 'N/A'} - ${opto.av_lentes_oi2 || 'N/A'}</td></tr>

            <tr><th colspan="2" class="table-secondary text-center">Otros</th></tr>
            <tr><th>BMP</th><td>${opto.bmp || 'N/A'}</td></tr>
            <tr><th>BMP OD</th><td>${opto.bmp_od || 'N/A'}</td></tr>
            <tr><th>BMP OI</th><td>${opto.bmp_oi || 'N/A'}</td></tr>
            <tr><th>F.O</th><td>${opto.fo || 'N/A'}</td></tr>
            <tr><th>F.O OD</th><td>${opto.fo_od || 'N/A'}</td></tr>
            <tr><th>F.O OI</th><td>${opto.fo_oi || 'N/A'}</td></tr>
            <tr><th>Cicloplejia</th><td>${opto.cicloplejia || 'N/A'}</td></tr>
            <tr><th>Hora T.P.</th><td>${opto.hora_tp || 'N/A'}</td></tr>
            <tr><th>Fecha</th><td>${fechaFormateada}</td></tr>
        </table>
        <hr/>
        `;
    });

    Swal.fire({
        title: `Optometr√≠a de ${nombre} (Expediente ${expedienteId})`,
        html: contenido,
        width: '80%',
        confirmButtonText: 'Cerrar'
    });
}

// Funci√≥n para eliminar expediente
async function eliminarExpediente(numero, departamento) {
    const confirmacion = await Swal.fire({
        title: '¬øEst√°s seguro?',
        text: "Esto eliminar√° el expediente permanentemente",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
    });

    if (confirmacion.isConfirmed) {
        const res = await fetch(`/api/expedientes/${numero}`, { 
            method: 'DELETE',
            credentials: 'include'
        });
        const data = await res.json();

        if (res.ok) {
            Swal.fire('Eliminado', data.mensaje, 'success');
            cargarExpedientes();
        } else {
            Swal.fire('Error', data.error || 'No se pudo eliminar', 'error');
        }
    }
}
</script>

</body>
</html>