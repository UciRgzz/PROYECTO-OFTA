<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda Quirúrgica</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f0f5ff 0%, #e3f2fd 100%);
      padding: 20px;
      color: #333;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      border-radius: 10px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .description {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      margin-bottom: 30px;
      overflow: hidden;
      border: none;
    }
    
    .card-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, #3d5061 100%);
      color: white;
      padding: 18px 25px;
      font-size: 1.3rem;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    
    .card-header i {
      margin-right: 12px;
      font-size: 1.5rem;
    }
    
    .card-body {
      padding: 25px;
    }
    
    .btn {
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      border-radius: 8px;
      padding: 14px 25px;
      font-size: 1.1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--secondary-color) 0%, #2c80b9 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
    }
    
    .btn-primary i {
      margin-right: 8px;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--accent-color) 0%, #c0392b 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(231, 76, 60, 0.4);
    }
    
    .btn-sm {
      padding: 8px 15px;
      font-size: 0.9rem;
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(149, 165, 166, 0.3);
    }
    
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(149, 165, 166, 0.4);
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    }
    
    .table th {
      background: linear-gradient(135deg, var(--primary-color) 0%, #3d5061 100%);
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: 600;
    }
    
    .table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }
    
    .table tr:last-child td {
      border-bottom: none;
    }
    
    .table tr:nth-child(odd) {
      background: #f9f9f9;
    }
    
    .table tr:hover {
      background-color: #eef6ff;
    }
    
    .calendar-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
      padding: 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .current-month {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary-color);
    }
    
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
    }
    
    .day-header {
      text-align: center;
      padding: 12px;
      background: linear-gradient(135deg, var(--primary-color) 0%, #3d5061 100%);
      color: white;
      border-radius: 8px;
      font-weight: 600;
    }
    
    .calendar-day {
      background: white;
      border-radius: 8px;
      min-height: 120px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    
    .day-number {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--primary-color);
    }
    
    /* Colores por tipo de procedimiento */
    .proc-lente { 
      background: #e8f5e9; 
      border-left: 4px solid #4caf50; 
    }
    
    .proc-catarata { 
      background: #fff3e0; 
      border-left: 4px solid #ff9800; 
    }
    
    .proc-consulta { 
      background: #e3f2fd; 
      border-left: 4px solid #2196f3; 
    }
    
    .insumo-item {
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-size: 0.85rem;
    }
    
    .insumo-name {
      font-weight: 600;
    }
    
    .insumo-info {
      font-size: 0.8rem;
      color: #555;
    }
    
    .badge {
      padding: 6px 10px;
      border-radius: 20px;
      font-weight: 600;
    }
    
    .footer {
      text-align: center;
      margin-top: 40px;
      color: #6c757d;
      font-size: 0.9rem;
    }
    
    @media (max-width: 768px) {
      h1 {
        font-size: 2rem;
      }
      
      .table-responsive {
        overflow-x: auto;
      }
      
      .calendar {
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
      }
      
      .calendar-day {
        min-height: 100px;
        padding: 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-calendar-check"></i> Agenda Quirúrgica</h1>
      <p class="description">Gestiona las cirugías programadas en el sistema Oftavisión.</p>
    </header>

    <!-- Tabla de órdenes -->
    <div class="card">
      <div class="card-header"><i class="fas fa-list me-2"></i> Órdenes de Cirugía</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-striped align-middle">
            <thead>
              <tr>
                <th>Expediente</th>
                <th>Edad</th>
                <th>Nombre</th>
                <th>Procedimiento</th>
                <th>Total Orden</th>
                <th>Pagos Realizados</th>
                <th>Diferencia</th>
                <th>Status</th>
                <th>Tipo de Lente</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tablaOrdenes"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Calendario -->
    <div class="card">
      <div class="card-header"><i class="fas fa-calendar me-2"></i> Calendario de Cirugías</div>
      <div class="card-body">
        <div class="calendar-nav">
          <button class="btn btn-primary" onclick="cambiarMesCirugia(-1)">
            <i class="fas fa-chevron-left"></i> Mes anterior
          </button>
          <div class="current-month" id="mesCirugia"></div>
          <button class="btn btn-primary" onclick="cambiarMesCirugia(1)">
            Mes siguiente <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div class="calendar" id="calendarioCirugias"></div>
      </div>
    </div>
    
    <div class="footer">
      <p>Sistema de Gestión Oftavisión &copy; 2025</p>
    </div>
  </div>

  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    
// ====================== TABLA ======================
async function cargarOrdenes(year, month) {
  try {
    const res = await fetch('/api/ordenes');
    let ordenes = await res.json();

    // 🔹 Si hay año/mes, filtramos por ese mes
    if (year !== undefined && month !== undefined) {
      ordenes = ordenes.filter(o => {
        if (!o.fecha_cirugia) return true; // mostrar también las que aún no tienen fecha
        const f = new Date(o.fecha_cirugia);
        return f.getFullYear() === year && f.getMonth() === month;
      });
    }

    document.getElementById("tablaOrdenes").innerHTML = ordenes.map(o => `
      <tr>
        <td>${o.expediente}</td>
        <td>${o.edad}</td>
        <td>${o.nombre}</td>
        <td>${o.procedimiento}</td>
        <td>$${o.total}</td>
        <td>$${o.pagos}</td>
        <td>$${o.total - o.pagos}</td>
        <td>${o.status}</td>
        <td>
          ${o.tipo_lente 
            ? `<span class="badge bg-info text-dark" style="cursor:pointer" onclick="editarLente(${o.id}, '${o.tipo_lente}')">${o.tipo_lente}</span>` 
            : `<button class="btn btn-sm btn-secondary" 
                      onclick="editarLente(${o.id}, '')">
                 <i class="fas fa-plus-circle"></i> Añadir Lente
               </button>`}
        </td>
        <td>
          ${o.fecha_cirugia ? 
            '<span class="text-muted">Asignado</span>' : 
            `<button class="btn btn-sm btn-primary" onclick="agendarCirugia(${o.id})">
              <i class="fas fa-calendar-plus"></i> Agendar
            </button>`}
        </td>
      </tr>
    `).join('');
  } catch (err) {
    console.error("Error cargando órdenes:", err);
  }
}

// ====================== CALENDARIO ======================
let fechaCirugia = new Date();

document.addEventListener("DOMContentLoaded", () => {
  renderCalendarCirugias(); // carga inicial
});

function getColorClass(proc) {
  if (proc.toLowerCase().includes("lente")) return "proc-lente";
  if (proc.toLowerCase().includes("catarata")) return "proc-catarata";
  return "proc-consulta";
}

async function renderCalendarCirugias() {
  const calendario = document.getElementById("calendarioCirugias");
  const mesActual = document.getElementById("mesCirugia");

  const year = fechaCirugia.getFullYear();
  const month = fechaCirugia.getMonth();

  mesActual.textContent = fechaCirugia.toLocaleString("es-ES", { month: "long", year: "numeric" });

  const primerDia = new Date(year, month, 1).getDay() || 7;
  const diasEnMes = new Date(year, month + 1, 0).getDate();

  let cirugias = [];
  try {
    const res = await fetch("/api/cirugias");
    cirugias = await res.json();
  } catch (err) { console.error(err); }

  const filtradas = cirugias.filter(c => {
    const f = new Date(c.fecha);
    return f.getFullYear() === year && f.getMonth() === month;
  });

  calendario.innerHTML = "";

  ["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"].forEach(d => {
    calendario.innerHTML += `<div class="day-header">${d}</div>`;
  });

  for (let i = 1; i < primerDia; i++) {
    calendario.innerHTML += `<div class="empty-day"></div>`;
  }

  for (let d = 1; d <= diasEnMes; d++) {
    const fechaDia = new Date(year, month, d).toISOString().split("T")[0];
    const programadas = filtradas.filter(c => c.fecha.startsWith(fechaDia));

    let contenido = `<div class="calendar-day"><div class="day-number">${d}</div>`;
    if (programadas.length > 0) {
      programadas.forEach(c => {
        contenido += `
          <div class="insumo-item ${getColorClass(c.procedimiento)}">
            <div class="insumo-name">${c.nombre}</div>
            <div class="insumo-info">Proc: ${c.procedimiento}</div>
            <div class="insumo-info">Dr: ${c.medico}</div>
            ${c.tipo_lente ? `<div class="insumo-info">Lente: ${c.tipo_lente}</div>` : ""}
            <button class="btn btn-sm btn-danger mt-1" onclick="eliminarCirugia(${c.id})">
              <i class="fas fa-trash"></i> Eliminar
            </button>
          </div>`;
      });
    }
    contenido += "</div>";
    calendario.innerHTML += contenido;
  }

  // 🔹 Refrescar la tabla también
  cargarOrdenes(year, month);
}

function cambiarMesCirugia(offset) {
  fechaCirugia.setMonth(fechaCirugia.getMonth() + offset);
  renderCalendarCirugias();
}

function agendarCirugia(idOrden) {
  Swal.fire({
    title: 'Asignar fecha de cirugía',
    input: 'date',
    showCancelButton: true,
    confirmButtonText: 'Asignar',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#3498db'
  }).then(async (result) => {
    if (result.isConfirmed) {
      const fecha = result.value;
      try {
        await fetch(`/api/ordenes/${idOrden}/agendar`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fecha_cirugia: fecha })
        });
        mostrarExito('Cirugía agendada', 'La cirugía ha sido agendada correctamente');
        renderCalendarCirugias();
      } catch (err) {
        console.error("Error al agendar:", err);
        mostrarError('Error al agendar', 'No se pudo agendar la cirugía');
      }
    }
  });
}

function editarCirugia(idOrden) {
  Swal.fire({
    title: 'Reprogramar cirugía',
    input: 'date',
    showCancelButton: true,
    confirmButtonText: 'Guardar',
    confirmButtonColor: '#3498db'
  }).then(async (result) => {
    if (result.isConfirmed) {
      try {
        await fetch(`/api/ordenes/${idOrden}/agendar`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fecha_cirugia: result.value })
        });
        mostrarExito('Cirugía reprogramada', 'La cirugía ha sido reprogramada correctamente');
        renderCalendarCirugias();
      } catch (err) {
        console.error("Error al editar:", err);
        mostrarError('Error al reprogramar', 'No se pudo reprogramar la cirugía');
      }
    }
  });
}

// ==================== EDITAR TIPO DE LENTE ====================
function editarLente(idOrden, tipoActual) {
  Swal.fire({
    title: tipoActual ? 'Editar Tipo de Lente' : 'Añadir Tipo de Lente',
    input: 'text',
    inputValue: tipoActual || '',
    inputPlaceholder: 'Ejemplo: Lente Intraocular',
    showCancelButton: true,
    confirmButtonText: 'Guardar',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#3498db',
    preConfirm: (valor) => {
      if (!valor.trim()) {
        Swal.showValidationMessage('Debes ingresar un tipo de lente');
      }
      return valor;
    }
  }).then(async (result) => {
    if (result.isConfirmed) {
      try {
        await fetch(`/api/ordenes/${idOrden}/lente`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ tipo_lente: result.value })
        });
        mostrarExito('Tipo de lente guardado', 'El tipo de lente fue actualizado correctamente');
        renderCalendarCirugias(); // refresca tabla y calendario
      } catch (err) {
        console.error("Error al actualizar tipo de lente:", err);
        mostrarError('Error al guardar', 'No se pudo actualizar el tipo de lente');
      }
    }
  });
}

// ==================== ELIMINAR CIRUGÍA (con confirmación) ====================
function eliminarCirugia(idOrden) {
  Swal.fire({
    title: '¿Eliminar cirugía?',
    text: "Esta acción no se puede deshacer.",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#e74c3c',
    cancelButtonColor: '#3498db',
    confirmButtonText: 'Sí, eliminar',
    cancelButtonText: 'Cancelar'
  }).then(async (result) => {
    if (result.isConfirmed) {
      try {
        await fetch(`/api/ordenes/${idOrden}/agendar`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fecha_cirugia: null }) // quitamos la fecha
        });
        mostrarExito('Cirugía eliminada', 'Cirugía eliminada del calendario correctamente');
        renderCalendarCirugias(); 
      } catch (err) {
        console.error("Error al eliminar cirugía:", err);
        mostrarError('Error al eliminar', 'No se pudo eliminar la cirugía');
      }
    }
  });
}

// Mostrar mensaje de éxito
function mostrarExito(titulo, mensaje) {
  Swal.fire({
    icon: 'success',
    title: titulo,
    text: mensaje,
    timer: 3000,
    showConfirmButton: false
  });
}

// Mostrar error
function mostrarError(titulo, mensaje) {
  Swal.fire({
    icon: 'error',
    title: titulo,
    text: mensaje
  });
}

</script>

</body>
</html>