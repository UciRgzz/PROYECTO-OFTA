<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>M√≥dulo M√©dico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">

    <h2 class="mb-4">Pacientes Pendientes de Atender</h2>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Expediente</th>
                <th>Nombre</th>
                <th>Edad</th>
                <th>Padecimiento</th>
                <th>Procedimiento</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="lista-medica"></tbody>
    </table>

    <!-- Modal para crear Orden M√©dica -->
    <div class="modal fade" id="modalOrden" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Orden M√©dica</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-orden">
                        <!-- Campos ocultos -->
                        <input type="hidden" id="expediente_id">
                        <input type="hidden" id="folio_recibo">

                        <div class="mb-3">
                            <label>M√©dico:</label>
                            <input type="text" id="medico" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label>Diagn√≥stico:</label>
                            <textarea id="diagnostico" class="form-control" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label>Lado:</label>
                            <select id="lado" class="form-select" required>
                                <option value="OD">Ojo Derecho</option>
                                <option value="OI">Ojo Izquierdo</option>
                                <option value="AMBOS">Ambos Ojos</option>
                                <option value="NINGUNO">Ninguno</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Procedimiento:</label>
                            <select id="procedimiento_id" class="form-select" required></select>
                        </div>

                        <button type="submit" class="btn btn-success">Guardar Orden</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // ================== Cargar lista de pacientes pendientes ==================
    async function cargarPacientes() {
        const res = await fetch('/api/pendientes-medico');
        const data = await res.json();
        const tbody = document.getElementById('lista-medica');
        tbody.innerHTML = '';

        data.forEach(exp => {
            // üé® Colores seg√∫n procedimiento
            let clase = "";
            if (exp.procedimiento === "Consulta") clase = "table-primary";   // azul
            else if (exp.procedimiento === "Estudio") clase = "table-warning"; // amarillo
            else if (exp.procedimiento === "Cirug√≠a") clase = "table-danger"; // rojo

            tbody.innerHTML += `
                <tr class="${clase}">
                    <td>${exp.expediente_id}</td>
                    <td>${exp.nombre_completo}</td>
                    <td>${exp.edad}</td>
                    <td>${exp.padecimientos}</td>
                    <td><b>${exp.procedimiento}</b></td>
                    <td>
                        <button class="btn btn-primary btn-sm" 
                            onclick="abrirOrden(${exp.expediente_id}, ${exp.recibo_id})">
                            Atender
                        </button>
                    </td>
                </tr>
            `;
        });
    }

  // ================== Cargar procedimientos en el select ==================
async function cargarProcedimientos() {
    const res = await fetch('/api/procedimientos');
    const data = await res.json();
    const select = document.getElementById('procedimiento_id');
    select.innerHTML = '';
    data.forEach(proc => {
        select.innerHTML += `<option value="${proc.id}">${proc.nombre}</option>`; // ‚úÖ solo nombre
    });
}

    // ================== Abrir modal para nueva orden ==================
    function abrirOrden(expediente_id, recibo_id) {
        document.getElementById('expediente_id').value = expediente_id;
        document.getElementById('folio_recibo').value = recibo_id;
        cargarProcedimientos();
        const modal = new bootstrap.Modal(document.getElementById('modalOrden'));
        modal.show();
    }

    // ================== Guardar orden m√©dica ==================
    document.getElementById('form-orden').addEventListener('submit', async e => {
        e.preventDefault();
        const data = {
            expediente_id: document.getElementById('expediente_id').value,
            folio_recibo: document.getElementById('folio_recibo').value,
            medico: document.getElementById('medico').value,
            diagnostico: document.getElementById('diagnostico').value,
            lado: document.getElementById('lado').value,
            procedimiento_id: document.getElementById('procedimiento_id').value
        };

        const res = await fetch('/api/ordenes_medicas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const json = await res.json();
        alert(json.mensaje || json.error);

        if (res.ok) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalOrden'));
            modal.hide();
            cargarPacientes();
        }
    });

    // Inicializar carga de pacientes
    cargarPacientes();
    </script>
</body>
</html>
