<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>OFTASIS - Sistema Integral de Gestión Oftalmológica</title>
  <meta name="description" content="OFTASIS es el sistema del Instituto Oftavisión para la gestión integral de pacientes: citas, expedientes, reportes y control médico.">
  <meta name="keywords" content="Oftasis, Instituto Oftavisión, sistema oftalmológico, gestión clínica, expedientes médicos, citas médicas, optometría, oftalmología">
  <meta name="author" content="Instituto Oftavisión">

  <!-- Open Graph -->
  <meta property="og:title" content="OFTASIS - Sistema Integral de Gestión Oftalmológica">
  <meta property="og:description" content="Administra citas, expedientes, reportes y más con OFTASIS del Instituto Oftavisión.">
  <meta property="og:image" content="https://oftavision.shop/uploads/logo-oftavision.png">
  <meta property="og:url" content="https://oftavision.shop">
  <meta property="og:type" content="website">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="OFTASIS - Sistema Integral de Gestión Oftalmológica">
  <meta name="twitter:description" content="Sistema del Instituto Oftavisión para gestionar citas, expedientes y reportes médicos.">
  <meta name="twitter:image" content="https://oftavision.shop/uploads/logo-oftavision.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/uploads/logo-oftavision2.png"> 
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="icon" href="/logo.ico" type="image/x-icon">

<style>
  body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    min-height: 100vh;
    background: #f0f5ff;
    display: flex;
    flex-direction: column; /* Header arriba, contenido abajo */
  }

  /* Header */
.header {
  background: #fff;
  border-bottom: 1px solid #ddd;
  padding: 10px 20px;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* Usuario */
.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-avatar {
  background: #3498db;
  color: #fff;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  text-transform: uppercase;
  font-size: 14px;
}

#nombreUsuario {
  font-weight: 500;
  color: #2c3e50;
  font-size: 15px;
}

/* Notificaciones */
.notifications i {
  font-size: 26px;
  color: #555;
  transition: color 0.2s;
}
.notifications i:hover {
  color: #3498db;
}


  /* Layout general */
  .layout {
    flex: 1;
    display: flex; /* Sidebar + main */
    min-height: 0; /* Evita overflow raro */
  }

  /* Sidebar */
  .sidebar {
    width: 240px;
    background: linear-gradient(180deg, #1e2a32, #2c3e50);
    color: #fff;
    display: flex;
    flex-direction: column;
  }

  .sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }

  .sidebar h2 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .sidebar a {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 15px;
    color: #fff;
    text-decoration: none;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 6px;
    transition: all 0.2s;
  }

  .sidebar a:hover {
    background: #3498db;
  }

  .sidebar .material-icons {
    font-size: 20px;
  }

  .sidebar .logout {
    padding: 15px 20px;
    border-top: 1px solid rgba(255,255,255,0.2);
  }

  /* Main */
  .main {
    flex: 1;
    padding: 25px;
    background: #f4f6f8;
    overflow-y: auto;
  }

  iframe {
    width: 100%;
    height: 85vh;
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  /* Modal */
  .modal-content {
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }

  .modal-header {
    background: linear-gradient(135deg, #2c3e50, #3498db);
    color: white;
  }

  .small-muted {
    font-size: .9rem;
    color: #6c757d;
  }

  /* Selector sucursal */
  #sucursal-selector .dropdown-menu {
    background-color: #fff;
    color: #000;
  }

  #sucursal-selector .dropdown-item {
    color: #000;
  }

  #sucursal-selector .dropdown-item:hover {
    background-color: #3498db;
    color: #fff;
  }

  /* Botones personalizados */
  .btn-editar { background: #0b335c; color: white; }
  .btn-editar:hover { background: #0f2c57; }

  .btn-medico { background: #0b335c; color: white; }
  .btn-medico:hover { background:  #0f2c57; }

  .btn-opto { background: #0b335c; color: white; }
  .btn-opto:hover { background:  #0f2c57; }

  /* Dropdown notificaciones */
#notif-dropdown {
  display: none;
  position: absolute;
  right: 0;
  top: 40px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 10px;
  width: 300px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 1050;
  overflow: hidden;
}

#notif-dropdown p {
  margin: 0;
  padding: 10px 15px;
  background: #f8f9fa;
  font-size: 14px;
  border-bottom: 1px solid #eee;
}

#notif-dropdown li {
  padding: 10px 15px;
  font-size: 14px;
  transition: background 0.2s;
}

#notif-dropdown li:hover {
  background: #f0f5ff;
}
  
  #notif-dropdown p {
    margin: 0;
    padding: 10px 15px;
    background: #f8f9fa;
    font-size: 14px;
    border-bottom: 1px solid #eee;
  }
  #notif-dropdown li {
    padding: 10px 15px;
    font-size: 14px;
    transition: background 0.2s;
  }
  #notif-dropdown li:hover {
    background: #f0f5ff;
  }
</style>

</head>
<body>
  
  <!-- HEADER SUPERIOR -->
  <div class="header">
    <span id="nombreUsuario" class="me-3 fw-bold text-primary"></span>
    <div class="notifications position-relative">
      <i class="material-icons" id="bell" style="cursor:pointer;">notifications</i>
      <span class="badge bg-danger position-absolute top-0 start-100 translate-middle p-1 rounded-circle" id="notif-count" style="font-size:0.7rem; display:none;">0</span>
      <div class="dropdown-menu dropdown-menu-end shadow" id="notif-dropdown" style="min-width:280px;">
        <p class="px-3 pt-2 fw-bold">Notificaciones</p>
        <ul class="list-unstyled mb-2" id="notif-list"></ul>
      </div>
    </div>
  </div>

  <!-- LAYOUT -->
  <div class="layout">
    
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-content">
        <h2>Menú</h2> 

        <!-- Selector de sucursal (solo admin) -->
        <div id="sucursal-selector" class="dropdown mb-3" style="display:none;">
          <button class="btn btn-light w-100 dropdown-toggle d-flex align-items-center" 
                  type="button" data-bs-toggle="dropdown" aria-expanded="false" 
                  id="sucursalBtn">
            <i class="material-icons me-2">business</i> 
            <span id="sucursalTexto">Sucursal</span>
          </button>
          <ul class="dropdown-menu w-100">
            <li><a class="dropdown-item" href="#" onclick="cambiarSucursal('admin')">Admin</a></li>
            <li><a class="dropdown-item" href="#" onclick="cambiarSucursal('Reynosa')">Reynosa</a></li>
            <li><a class="dropdown-item" href="#" onclick="cambiarSucursal('Yucatan')">Yucatán</a></li>
            <li><a class="dropdown-item" href="#" onclick="cambiarSucursal('Monterrey')">Monterrey</a></li>
          </ul>
        </div>

        <!-- Menú dinámico -->
        <div id="menu-dinamico"></div>

        <!-- Cerrar sesión -->
        <div class="mt-3 border-top pt-2">
          <button class="btn btn-danger w-100 d-flex align-items-center" onclick="cerrarSesion()">
            <i class="material-icons me-2">exit_to_app</i> 
            Cerrar Sesión
          </button>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main" id="main-content">
      <h1>Cargando...</h1>
    </div>
  </div>
</body>
</html>


<!-- MODAL ÓRDENES Y OPTOMETRÍA -->
<div class="modal fade" id="modalOrdenes" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Órdenes del Paciente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="contenedorOrdenes"></div>
      </div>
      <div class="modal-footer">
        <span class="small-muted me-auto">Se muestra primero el registro más reciente.</span>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- BOOTSTRAP SCRIPTS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="styles.css">

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Sesión (Inicio)
fetch('/api/check-session')
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(data => {
    if (data.usuario) {
      // 👇 Guardar el rol globalmente para usarlo en otras páginas
      window.usuarioRol = data.usuario.rol;

      // Construir menú dinámico
      const nombreUsuario = document.getElementById("nombreUsuario");
      if (nombreUsuario) {
        nombreUsuario.textContent = data.usuario.username.toUpperCase();
        nombreUsuario.style.display = "inline-block"; // asegura que se muestre
      }

      // Mostrar selector solo si es admin
      if (data.usuario.rol === "admin") {
        document.getElementById("sucursal-selector").style.display = "block";
      }

      // Mostrar la sucursal actual en el botón
      let sucursalActual;
      if (data.usuario.rol === "admin") {
        sucursalActual = data.usuario.sucursalSeleccionada || "Admin";
      } else {
        sucursalActual = data.usuario.departamento;
      }
      document.getElementById("sucursalTexto").textContent = sucursalActual;

      // Contenido principal por defecto
      document.getElementById('main-content').innerHTML = `
        <div style="text-align:center; margin-top:40px;">
          <h1>Bienvenido</h1>
          <p>Selecciona una opción del menú.</p>
          <div style="margin-top:80px; text-align:left;">
            <img src="/uploads/logo-oftavision.png" 
              alt="Instituto Oftavisión" 
              style="max-width:900px; display:block; margin:0 auto;">
          </div>
        </div>
      `;

      // ✅ Cargar notificaciones siempre que haya sesión activa
      cargarNotificaciones();
    }
  })
  .catch(() => window.location.href = '/login/login.html');

// ---------- Abrir/cerrar notificaciones ----------
document.getElementById("bell").addEventListener("click", (e) => {
  e.stopPropagation();
  const dropdown = document.getElementById("notif-dropdown");
  dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
});

// Cerrar si se hace click afuera
document.addEventListener("click", (e) => {
  const dropdown = document.getElementById("notif-dropdown");
  const bell = document.getElementById("bell");
  if (dropdown && !dropdown.contains(e.target) && e.target !== bell) {
    dropdown.style.display = "none";
  }
});

// ---------- Función cerrar sesión ----------
function cerrarSesion() {
  fetch('/api/logout')
    .then(() => window.location.href = '/login/login.html')
    .catch(err => console.error("Error al cerrar sesión:", err));
}


// Router simple
async function mostrarSeccion(seccion){
  const paginas = {
  expedientes: "/frontend/expedientes.html",
  recibos: "/frontend/recibo.html",
  cierredecaja: "/frontend/cierre-caja.html",
  medico: "/frontend/medico.html",
  ordenes: "/frontend/ordenes.html",
  optometria: "/frontend/optometria.html",
  insumos: "/frontend/insumos.html",
  usuarios: "/frontend/admin/usuarios.html",   // este sí está dentro de admin
  agendaquirurgica: "/frontend/A_Quirurgica.html",
  asignarmodulos: "/frontend/A_modulos.html"
};
  const main = document.getElementById('main-content');

  if(seccion === 'expedientes'){
    main.innerHTML = `
      <h2>Gestión de Expedientes</h2>
      <div class="d-flex justify-content-between mb-3">
        <input type="text" id="buscarExp" class="form-control w-50" placeholder="Buscar por nombre o número">
        <button class="btn btn-primary" id="btnNuevo">Nuevo Expediente</button>
      </div>
      <div id="formulario-expediente" style="display:none;"></div>
      <div id="lista-expedientes"></div>
    `;
    document.getElementById('btnNuevo').addEventListener('click', () => {
      document.getElementById('lista-expedientes').style.display = 'none';
      mostrarFormulario();
    });
    document.getElementById('buscarExp').addEventListener('input', filtrarLista);
    cargarLista();
  }else if(paginas[seccion]){
    main.innerHTML = `<iframe src="${paginas[seccion]}"></iframe>`;
  }else{
    main.innerHTML = `<h2>${seccion}</h2><p>Contenido de ${seccion} aquí...</p>`;
  }
}

// Expedientes
function mostrarFormulario(expediente=null){
  const cont = document.getElementById('formulario-expediente');
  cont.style.display='block';
  cont.innerHTML = `
    <form id="form-expediente">
      <div class="mb-2">
        <label>Número de Expediente:</label>
        <input type="text" id="num_expediente" class="form-control" readonly>
      </div>
      <div class="mb-2"><label>Nombre:</label>
        <input type="text" id="nombre" class="form-control" required></div>
      <div class="mb-2"><label>Fecha de Nacimiento:</label>
        <input type="date" id="fecha_nac" class="form-control" required></div>
      <div class="mb-2"><label>Edad:</label>
        <input type="number" id="edad" class="form-control" readonly></div>
      <div class="mb-2"><label>Padecimiento:</label>
        <select id="padecimiento" class="form-select" required>
          <option value="">Seleccione...</option>
          <option value="DIABETES">DIABETES</option>
          <option value="HIPERTENSO">HIPERTENSO</option>
          <option value="NINGUNO">NINGUNO</option>
        </select>
      </div>
      <div class="mb-2"><label>Colonia:</label>
        <input type="text" id="colonia" class="form-control"></div>
      <div class="mb-2"><label>Ciudad:</label>
        <input type="text" id="ciudad" class="form-control"></div>
      <div class="mb-2"><label>Teléfono 1:</label>
        <input type="text" id="telefono1" class="form-control"></div>
      <div class="mb-2"><label>Teléfono 2:</label>
        <input type="text" id="telefono2" class="form-control"></div>
      <button type="submit" class="btn btn-success">Guardar</button>
      <button type="button" class="btn btn-secondary" onclick="cancelarFormulario()">Cancelar</button>
    </form>
  `;

  fetch('/api/expedientes').then(r=>r.json()).then(arr=>{
    const siguiente = expediente
      ? expediente.numero_expediente
      : (arr.length>0 ? arr[arr.length-1].numero_expediente+1 : 1).toString().padStart(4,'0');
    document.getElementById('num_expediente').value = siguiente;
  });

  if(expediente){
    document.getElementById('form-expediente').dataset.editando = true;
    document.getElementById('nombre').value = expediente.nombre_completo;
    if(expediente.fecha_nacimiento){
      const f = new Date(expediente.fecha_nacimiento);
      const yyyy=f.getFullYear(), mm=String(f.getMonth()+1).padStart(2,'0'), dd=String(f.getDate()).padStart(2,'0');
      document.getElementById('fecha_nac').value = `${yyyy}-${mm}-${dd}`;
    }
    document.getElementById('edad').value = expediente.edad;
    document.getElementById('padecimiento').value = expediente.padecimientos;
    document.getElementById('colonia').value = expediente.colonia;
    document.getElementById('ciudad').value = expediente.ciudad;
    document.getElementById('telefono1').value = expediente.telefono1;
    document.getElementById('telefono2').value = expediente.telefono2;
  }else{
    document.getElementById('form-expediente').dataset.editando = '';
  }

  document.getElementById('fecha_nac').addEventListener('change', ()=>{
    const f = new Date(document.getElementById('fecha_nac').value);
    if(!isNaN(f)){
      const hoy = new Date();
      let edad = hoy.getFullYear()-f.getFullYear();
      const m = hoy.getMonth()-f.getMonth();
      if(m<0 || (m===0 && hoy.getDate()<f.getDate())) edad--;
      document.getElementById('edad').value = edad;
    }
  });

  document.getElementById('form-expediente').addEventListener('submit', guardarExpediente);
}

function cancelarFormulario(){
  document.getElementById('formulario-expediente').style.display='none';
  document.getElementById('lista-expedientes').style.display='block';
}

async function guardarExpediente(e){
  e.preventDefault();
  const id = document.getElementById('num_expediente').value;
  const nombre = document.getElementById('nombre').value;
  const fecha_nacimiento = document.getElementById('fecha_nac').value;

  let metodo='POST', url='/api/expedientes';
  const edicion = !!document.getElementById('form-expediente').dataset.editando;

  if(edicion){
    metodo='PUT'; url=`/api/expedientes/${id}`;
  }else{
    const chk = await fetch(`/api/expedientes/check?nombre=${encodeURIComponent(nombre)}&fecha_nacimiento=${fecha_nacimiento}`);
    const existe = await chk.json();
    if(existe.existe){
      Swal.fire({
        icon: 'warning',
        title: 'Duplicado',
        text: 'El expediente ya existe'
      });
      return;
    }
  }

  const data = {
    nombre_completo:nombre, fecha_nacimiento,
    edad:document.getElementById('edad').value,
    padecimientos:document.getElementById('padecimiento').value,
    colonia:document.getElementById('colonia').value,
    ciudad:document.getElementById('ciudad').value,
    telefono1:document.getElementById('telefono1').value,
    telefono2:document.getElementById('telefono2').value
  };

  const res = await fetch(url,{method:metodo,headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  const json = await res.json();

  if(res.ok){
    Swal.fire({
      icon: 'success',
      title: edicion ? 'Expediente actualizado' : 'Expediente creado',
      text: json.mensaje || `Número: ${json.expediente?.numero_expediente}`
    });
    cancelarFormulario(); 
    cargarLista();
  }else{
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: json.error || 'No se pudo guardar el expediente'
    });
  }
}

function cargarLista(){
  fetch('/api/expedientes').then(r=>r.json()).then(data=>{
    let html = `<table class="table table-bordered align-middle">
      <thead>
        <tr>
          <th>Número</th><th>Nombre</th><th>Edad</th><th>Padecimiento</th>
          <th>Ciudad</th><th>Teléfono 1</th><th>Teléfono 2</th><th>Acciones</th>
        </tr>
      </thead><tbody>`;
    data.forEach(exp=>{
      html += `<tr>
        <td>${exp.numero_expediente}</td>
        <td>${exp.nombre_completo}</td>
        <td>${exp.edad}</td>
        <td>${exp.padecimientos}</td>
        <td>${exp.ciudad}</td>
        <td>${exp.telefono1}</td>
        <td>${exp.telefono2 || ''}</td>
        <td>
          <button class="btn-editar" onclick='editarExpediente(${JSON.stringify(exp)})'>Editar</button>
          <button class="btn-medico" onclick="verOrdenes(${exp.numero_expediente}, '${exp.nombre_completo.replace(/'/g,"\\'")}')">Médico</button>
          <button class="btn-opto" onclick="verOptometria(${exp.numero_expediente}, '${exp.nombre_completo.replace(/'/g,"\\'")}')">Optometría</button>
          ${window.usuarioRol === "admin" 
              ? `<button class="btn btn-danger" onclick="eliminarExpediente(${exp.numero_expediente})">Eliminar</button>` 
              : "" }
        </td>

      </tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById('lista-expedientes').innerHTML = html;
  });
}

function editarExpediente(exp){ document.getElementById('lista-expedientes').style.display='none'; mostrarFormulario(exp); }
function filtrarLista(){
  const f = document.getElementById('buscarExp').value.toLowerCase();
  document.querySelectorAll('#lista-expedientes tbody tr').forEach(row=>{
    row.style.display = row.innerText.toLowerCase().includes(f) ? '' : 'none';
  });
}

// ---------- Modal: Ver todas las órdenes ----------
async function verOrdenes(expedienteId, nombrePaciente=''){
  try{
    const res = await fetch(`/api/expedientes/${expedienteId}/ordenes`);
    const ordenes = await res.json();

    const cont = document.getElementById('contenedorOrdenes');
    const titulo = document.querySelector('#modalOrdenes .modal-title');
    titulo.textContent = `Órdenes de ${nombrePaciente || 'Paciente'} (Expediente ${expedienteId})`;

    if(!Array.isArray(ordenes) || ordenes.length===0){
      cont.innerHTML = `<div class="alert alert-warning mb-0">Este paciente aún no tiene órdenes médicas.</div>`;
    }else{
      let contenido = "";
      ordenes.forEach((orden, idx) => {
        contenido += `
          <h4 class="mt-3">Orden #${orden.numero_orden} ${idx===0 ? '(Más reciente)' : ''}</h4>
          <table class="table table-bordered table-sm">
            <tr><th>Número de Orden</th><td>${orden.numero_orden}</td></tr>
            <tr><th>Médico</th><td>${orden.medico}</td></tr>
            <tr><th>Diagnóstico</th><td>${orden.diagnostico}</td></tr>
            <tr><th>Lado</th><td>${orden.lado}</td></tr>
            <tr><th>Procedimiento</th><td>${orden.procedimiento}</td></tr>
            <tr><th>Precio</th><td>$${parseFloat(orden.precio||0).toFixed(2)}</td></tr>
            <tr><th>Estatus</th><td>${orden.estatus || 'Pendiente'}</td></tr>
            <tr><th>Fecha</th><td>${new Date(orden.fecha).toLocaleString()}</td></tr>
          </table>
          <h5 class="mt-3">Exploración Clínica</h5>
          <table class="table table-striped table-sm">
            <tr><th>Anexos</th><td>${orden.anexos || ''}</td></tr>
            <tr><th>Conjuntiva</th><td>${orden.conjuntiva || ''}</td></tr>
            <tr><th>Córnea</th><td>${orden.cornea || ''}</td></tr>
            <tr><th>Cámara Anterior</th><td>${orden.camara_anterior || ''}</td></tr>
            <tr><th>Cristalino</th><td>${orden.cristalino || ''}</td></tr>
            <tr><th>Retina</th><td>${orden.retina || ''}</td></tr>
            <tr><th>Mácula</th><td>${orden.macula || ''}</td></tr>
            <tr><th>Nervio Óptico</th><td>${orden.nervio_optico || ''}</td></tr>
            <tr><th>Ciclopejía</th><td>${orden.ciclopejia || ''}</td></tr>
            <tr><th>Hora T.P.</th><td>${orden.hora_tp || ''}</td></tr>
            <tr><th>Problemas Identificados</th><td>${orden.problemas || ''}</td></tr>
            <tr><th>Plan</th><td>${orden.plan || ''}</td></tr>
          </table>
          <hr/>
        `;
      });

      cont.innerHTML = contenido;
    }

    const modal = new bootstrap.Modal(document.getElementById('modalOrdenes'));
    modal.show();
  }catch(err){
    console.error('Error al cargar órdenes:', err);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudieron cargar las órdenes de este paciente'
    });
  }
}

// ---------- Modal: Ver evaluaciones de optometría ----------
async function verOptometria(expedienteId, nombrePaciente=''){
  try{
    const res = await fetch(`/api/expedientes/${expedienteId}/optometria`);
    const evaluaciones = await res.json();

    const cont = document.getElementById('contenedorOrdenes');
    const titulo = document.querySelector('#modalOrdenes .modal-title');
    titulo.textContent = `Optometría de ${nombrePaciente || 'Paciente'} (Expediente ${expedienteId})`;

    if(!Array.isArray(evaluaciones) || evaluaciones.length===0){
      cont.innerHTML = `<div class="alert alert-warning mb-0">Este paciente aún no tiene evaluaciones de optometría.</div>`;
    }else{
      let contenido = "";
      evaluaciones.forEach((opto, idx) => {
        contenido += `
          <h4 class="mt-3">Evaluación #${opto.id} ${idx===0 ? '(Más reciente)' : ''}</h4>
          <table class="table table-bordered table-sm">
            <tr><th>OD Esfera</th><td>${opto.esfera_od || ''}</td></tr>
            <tr><th>OD Cilindro</th><td>${opto.cilindro_od || ''}</td></tr>
            <tr><th>OD Eje</th><td>${opto.eje_od || ''}</td></tr>
            <tr><th>OD AVcC</th><td>${opto.avcc_od || ''}</td></tr>
            <tr><th>OD Adición</th><td>${opto.adicion_od || ''}</td></tr>
            <tr><th>OD AVcC2</th><td>${opto.avcc2_od || ''}</td></tr>

            <tr><th>OI Esfera</th><td>${opto.esfera_oi || ''}</td></tr>
            <tr><th>OI Cilindro</th><td>${opto.cilindro_oi || ''}</td></tr>
            <tr><th>OI Eje</th><td>${opto.eje_oi || ''}</td></tr>
            <tr><th>OI AVcC</th><td>${opto.avcc_oi || ''}</td></tr>
            <tr><th>OI Adición</th><td>${opto.adicion_oi || ''}</td></tr>
            <tr><th>OI AVcC2</th><td>${opto.avcc2_oi || ''}</td></tr>

            <tr><th>BMP</th><td>${opto.bmp || ''}</td></tr>
            <tr><th>BMP OD</th><td>${opto.bmp_od || ''}</td></tr>
            <tr><th>BMP OI</th><td>${opto.bmp_oi || ''}</td></tr>

            <tr><th>F.O</th><td>${opto.fo || ''}</td></tr>
            <tr><th>F.O OD</th><td>${opto.fo_od || ''}</td></tr>
            <tr><th>F.O OI</th><td>${opto.fo_oi || ''}</td></tr>

            <tr><th>OD AV Lejos</th>
              <td>${[opto.av_lejos_od1, opto.av_lejos_od2, opto.av_lejos_od3].filter(Boolean).join('<br>')}</td>
            </tr>
            <tr><th>OD AV Cerca</th>
              <td>${[opto.av_cerca_od1, opto.av_cerca_od2].filter(Boolean).join('<br>')}</td>
            </tr>
            <tr><th>OD Con Lentes</th>
              <td>${[opto.av_lentes_od1, opto.av_lentes_od2].filter(Boolean).join('<br>')}</td>
            </tr>

            <tr><th>OI AV Lejos</th>
              <td>${[opto.av_lejos_oi1, opto.av_lejos_oi2, opto.av_lejos_oi3].filter(Boolean).join('<br>')}</td>
            </tr>
            <tr><th>OI AV Cerca</th>
              <td>${[opto.av_cerca_oi1, opto.av_cerca_oi2].filter(Boolean).join('<br>')}</td>
            </tr>
            <tr><th>OI Con Lentes</th>
              <td>${[opto.av_lentes_oi1, opto.av_lentes_oi2].filter(Boolean).join('<br>')}</td>
            </tr>

            <tr><th>Cicloplejia</th><td>${opto.cicloplejia || ''}</td></tr>
            <tr><th>Hora T.P.</th><td>${opto.hora_tp || ''}</td></tr>
            <tr><th>Fecha</th><td>${new Date(opto.fecha).toLocaleString()}</td></tr>
          </table>
          <hr/>
        `;
      });
      cont.innerHTML = contenido;
    }

    const modal = new bootstrap.Modal(document.getElementById('modalOrdenes'));
    modal.show();
  }catch(err){
    console.error('Error al cargar optometría:', err);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudieron cargar las evaluaciones de optometría'
    });
  }
}

// ---------- Función para cambiar sucursal (solo admin) ----------
async function cambiarSucursal(nombreSucursal) {
  try {
    const res = await fetch('/api/set-departamento', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ departamento: nombreSucursal })
    });

    const data = await res.json();

    if (res.ok) {
      // 👇 Actualizar el texto del botón en el menú lateral
      const sucursalTexto = document.getElementById("sucursalTexto");
      if (sucursalTexto) {
        sucursalTexto.textContent = (nombreSucursal === "admin") ? "Admin" : nombreSucursal;
      }

      if (nombreSucursal === "admin") {
        // Si es admin, mostrar dashboard sin recargar
        document.getElementById('main-content').innerHTML = `
          <div style="text-align:center; margin-top:40px;">
            <h1>Bienvenido</h1>
            <p>Selecciona una opción del menú.</p>
            <div style="margin-top:80px;">
              <img src="../uploads/logo-oftavision.png" 
                  alt="Instituto Oftavisión" 
                  style="max-width:900px; display:block; margin:0 auto;">
            </div>
          </div>
        `;
      } else {
        // ✅ Cambiar sucursal al vuelo con logo incluido
        document.getElementById('main-content').innerHTML = `
          <div style="text-align:center; margin-top:40px;">
            <h1>Bienvenido a ${nombreSucursal}</h1>
            <p>Selecciona una opción del menú.</p>
            <div style="margin-top:80px;">
              <img src="../uploads/logo-oftavision.png" 
                  alt="Instituto Oftavisión" 
                  style="max-width:900px; display:block; margin:0 auto;">
            </div>
          </div>
        `;
      }
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: data.error || "Error al cambiar sucursal"
      });
    }
  } catch (err) {
    console.error("Error cambiando sucursal:", err);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'Error en la conexión con el servidor'
    });
  }
}

async function cargarMenu() {
  try {
    const res = await fetch("/api/check-session");
    if (!res.ok) {
      document.getElementById("menu-dinamico").innerHTML = `
        <p>No tienes permisos asignados.</p>
        <a href="/login/login.html" class="btn btn-danger">Iniciar Sesión</a>
      `;
      return;
    }

    const data = await res.json();
    let permisos = [];

    if (data.usuario.rol === "admin") {
      // Admin ve TODOS los módulos
      permisos = [
        "expedientes","recibos","cierredecaja","medico",
        "ordenes","optometria","insumos","usuarios",
        "agendaquirurgica","asignarmodulos"
      ];
    } else {
      // Usuario normal → consultar sus permisos reales
      const permisosRes = await fetch("/api/mis-permisos");
      if (!permisosRes.ok) {
        document.getElementById("menu-dinamico").innerHTML = `
          <p class="text-danger">Error cargando permisos. Contacta al administrador.</p>
        `;
        return;
      }

      const permisosData = await permisosRes.json();
      permisos = Array.isArray(permisosData)
        ? permisosData.filter(p => p.permitido).map(p => p.modulo)
        : [];
    }

    // Construir menú dinámico
    let html = "";

          if (permisos.includes("expedientes")) {
        html += `<a href="#" onclick="mostrarSeccion('expedientes')"><i class="material-icons">folder</i> Expedientes</a>`;
      }
      if (permisos.includes("optometria")) {
        html += `<a href="#" onclick="mostrarSeccion('optometria')"><i class="material-icons">visibility</i> Optometría</a>`;
      }
      if (permisos.includes("recibos")) {
        html += `<a href="#" onclick="mostrarSeccion('recibos')"><i class="material-icons">receipt</i> Recibos</a>`;
      }
      if (permisos.includes("medico")) {
        html += `<a href="#" onclick="mostrarSeccion('medico')"><i class="material-icons">healing</i> Módulo Médico</a>`;
      }
      if (permisos.includes("agendaquirurgica")) {
        html += `<a href="#" onclick="mostrarSeccion('agendaquirurgica')"><i class="material-icons">event</i> Agenda Quirúrgica</a>`;
      }
      if (permisos.includes("ordenes")) {
        html += `<a href="#" onclick="mostrarSeccion('ordenes')"><i class="material-icons">assignment</i> Órdenes</a>`;
      }
      if (permisos.includes("cierredecaja")) {
        html += `<a href="#" onclick="mostrarSeccion('cierredecaja')"><i class="material-icons">attach_money</i> Cierre de Caja</a>`;
      }
      if (permisos.includes("insumos")) {
        html += `<a href="#" onclick="mostrarSeccion('insumos')"><i class="material-icons">inventory</i> Insumos</a>`;
      }
      // 🔹 Separador para gestión de cuentas
      if (permisos.includes("asignarmodulos") || permisos.includes("usuarios")) {
        html += `<hr class="text-white opacity-50">`;
      }
      if (permisos.includes("asignarmodulos")) {
        html += `<a href="#" onclick="mostrarSeccion('asignarmodulos')"><i class="material-icons">settings</i> Asignar Módulos</a>`;
      }
      if (permisos.includes("usuarios")) {
        html += `<a href="#" onclick="mostrarSeccion('usuarios')"><i class="material-icons">group</i> Usuarios</a>`;
      }


    // Insertar el menú o mostrar advertencia si no tiene permisos
    document.getElementById("menu-dinamico").innerHTML =
      html || `<p class="text-warning">No tienes módulos asignados. Contacta al administrador.</p>`;
  } catch (err) {
    console.error("Error cargando menú:", err);
    document.getElementById("menu-dinamico").innerHTML = `
      <p class="text-danger">Error cargando menú. Intenta recargar la página.</p>
    `;
  }
}

cargarMenu();

// ==================== NOTIFICACIONES ====================
async function cargarNotificaciones() {
  try {
    const res = await fetch("/api/notificaciones");
    if (!res.ok) return;
    const notifs = await res.json();

    const notifCount = document.getElementById("notif-count");
    const notifList = document.getElementById("notif-list");

    notifList.innerHTML = "";
    if (notifs.length === 0) {
      notifList.innerHTML = `<li class="px-3 small text-muted">No hay notificaciones</li>`;
      notifCount.style.display = "none";
    } else {
      notifs.slice(-10).reverse().forEach(n => {
        const fecha = new Date(n.fecha).toLocaleString();
        notifList.innerHTML += `
          <li class="px-3 py-2 border-bottom">
            <div class="fw-bold small">${n.mensaje}</div>
            <div class="text-muted small">${fecha}</div>
          </li>
        `;
      });
      notifCount.textContent = notifs.length;
      notifCount.style.display = "inline-block";
    }
  } catch (err) {
    console.error("Error cargando notificaciones:", err);
  }
}


// ---------- Función para eliminar expediente ----------
async function eliminarExpediente(id){
  const confirmacion = await Swal.fire({
    title: '¿Estás seguro?',
    text: 'Esto eliminará el expediente permanentemente',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Sí, eliminar'
  });

  if(confirmacion.isConfirmed){
    const res = await fetch(`/api/expedientes/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if(res.ok){
      Swal.fire('Eliminado', data.mensaje, 'success');
      cargarLista();
    }else{
      Swal.fire('Error', data.error || 'No se pudo eliminar', 'error');
    }
  }
}

</script>