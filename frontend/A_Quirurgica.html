<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda Quirúrgica</title>
  <link rel="icon" type="image/png" href="/uploads/logo-oftavision2.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  :root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --accent-color: #e74c3c;
    --light-color: #f8f9fa;
    --dark-color: #343a40;
  }
  
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f0f5ff 0%, #e3f2fd 100%);
    padding: 20px;
    color: #333;
    min-height: 100vh;
  }
  
  .container { max-width: 1400px; margin: 0 auto; }
  
  header {
    text-align: center;
    margin-bottom: 20px;
    padding: 8px 15px;
    background: linear-gradient(135deg, #1e3a52 0%, #2c5f7f 100%);
    color: white;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  
  h1 { font-size: 1.6rem; margin-bottom: 2px; font-weight: 700; }
  .description { font-size: 0.85rem; opacity: 0.9; }
  
  .card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    margin-bottom: 20px;
    overflow: hidden;
    border: none;
  }
  
  .card-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #3d5061 100%);
    color: white;
    padding: 12px 18px;
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
  }
  .card-header i { margin-right: 10px; font-size: 1.2rem; }
  .card-body { padding: 18px; }
  
  .btn {
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    border-radius: 6px;
    padding: 10px 18px;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, var(--secondary-color) 0%, #2c80b9 100%);
    color: white;
    box-shadow: 0 3px 8px rgba(52, 152, 219, 0.3);
  }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4); }
  .btn-primary i { margin-right: 6px; }
  
  .btn-danger {
    background: linear-gradient(135deg, var(--accent-color) 0%, #c0392b 100%);
    color: white;
    box-shadow: 0 3px 8px rgba(231, 76, 60, 0.3);
  }
  .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4); }
  
  .btn-warning {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    color: white;
    box-shadow: 0 3px 8px rgba(243, 156, 18, 0.3);
  }
  .btn-warning:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(243, 156, 18, 0.4); }
  
  .btn-info {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    color: white;
    box-shadow: 0 3px 8px rgba(23, 162, 184, 0.3);
  }
  .btn-info:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(23, 162, 184, 0.4); }
  
  .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
  
  .table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
    background: white;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  }
  .table th, .table td { font-size: 0.8rem; padding: 6px; text-align: center; }
  .table th:nth-child(1), .table td:nth-child(1) { width: 5%; }
  .table th:nth-child(2), .table td:nth-child(2) { width: 6%; }
  .table th:nth-child(3), .table td:nth-child(3) { width: 15%; }
  .table th:nth-child(4), .table td:nth-child(4) { width: 12%; }
  .table th:nth-child(5), .table td:nth-child(5) { width: 9%; }
  .table th:nth-child(6), .table td:nth-child(6) { width: 9%; }
  .table th:nth-child(7), .table td:nth-child(7) { width: 9%; }
  .table th:nth-child(8), .table td:nth-child(8) { width: 8%; }
  .table th:nth-child(9), .table td:nth-child(9) { width: 10%; }
  .table th:nth-child(10), .table td:nth-child(10) { width: 10%; }
  .table th:nth-child(11), .table td:nth-child(11) { width: 12%; }
  
  .table tr:nth-child(odd) { background: #f9f9f9; }
  .table tr:hover { background-color: #eef6ff; }
  
  .success-alert {
    display: none;
    padding: 12px;
    background: #d4edda;
    color: #155724;
    border-radius: 6px;
    margin-bottom: 15px;
    border: 1px solid #c3e6cb;
  }
  
  .footer { text-align: center; margin-top: 30px; color: #6c757d; font-size: 0.85rem; }
  
  .calendar-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 12px 0;
    padding: 6px 10px;
    background: white;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }
  .calendar-nav .btn { padding: 5px 10px; font-size: 0.8rem; border-radius: 5px; }
  .current-month { font-size: 0.9rem; font-weight: 600; color: var(--primary-color); }
  
  /* === CALENDARIO POR MEDIA HORA === */
  .calendar-hourly {
    display: grid;
    grid-template-columns: 70px repeat(7, 1fr);
    gap: 4px;
    margin-top: 15px;
  }
  
  .hour-label {
    background: var(--primary-color);
    color: white;
    padding: 6px;
    text-align: center;
    font-weight: bold;
    border-radius: 4px;
    font-size: 0.75rem;
  }
  
  .day-header-hourly {
    background: var(--secondary-color);
    color: white;
    padding: 8px;
    text-align: center;
    font-weight: bold;
    border-radius: 4px;
    font-size: 0.8rem;
  }

  /* DÍA AGENDADO RESALTADO */
  .day-header-hourly.dia-agendado {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    box-shadow: 0 3px 8px rgba(39, 174, 96, 0.4);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  
  .hour-slot {
    height: 40px;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 3px;
    background-color: #f9f9f9;
    position: relative;
    overflow: hidden;
    cursor: pointer;
  }
  
  .hour-slot:hover {
    background-color: #eef6ff;
  }

  /* Slots en el día agendado */
  .hour-slot.dia-agendado-slot {
    background-color: #e8f8f5;
    border: 2px solid #27ae60;
  }

  .hour-slot.dia-agendado-slot:hover {
    background-color: #d5f4e6;
    box-shadow: 0 2px 6px rgba(39, 174, 96, 0.3);
  }

  /* Slots NO agendados (deshabilitados) */
  .hour-slot.disabled-slot {
    background-color: #ecf0f1;
    cursor: not-allowed;
    opacity: 0.6;
  }

  .hour-slot.disabled-slot:hover {
    background-color: #ecf0f1;
  }
  
  .hour-slot.booked {
    background-color: #e3f2fd;
    border-left: 3px solid var(--secondary-color);
  }
  
  .surgery-event {
    font-size: 0.6rem;
    padding: 2px;
    border-radius: 3px;
    margin-bottom: 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .proc-catarata { background: #f5cbfd; border-left: 3px solid #e46bf6; }
  .proc-consulta { background: #c9e7fd; border-left: 3px solid #2196f3; }
  .proc-lente { background: #f7f9d2; border-left: 3px solid #fbf866; }
  
  /* === CALENDARIO GRANDE FIJO === */
  .calendar {
    display: grid;
    grid-template-columns: repeat(7, minmax(120px, 1fr));
    grid-template-rows: 32px repeat(6, 110px);
    gap: 6px;
    justify-content: center;
    min-height: calc(32px + 6 * 110px);
  }

  .day-header {
    text-align: center;
    padding: 8px;
    background: linear-gradient(135deg, var(--primary-color) 0%, #3d5061 100%);
    color: white;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.8rem;
    height: 36px;
    line-height: 20px;
  }

  .calendar-day,
  .empty-day {
    height: 135px;
    font-size: 0.8rem;
    padding: 5px;
    overflow-y: auto;
    border-radius: 5px;
    position: relative;
  }

  .day-number {
    position: absolute;
    top: 3px;
    right: 5px;
    font-weight: 600;
    font-size: 0.75rem;
    color: #333;
  }

  .insumo-item {
    margin-top: 16px;
    padding: 4px 5px;
    border-radius: 3px;
    font-size: 0.7rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    word-break: break-word;
  }

  .calendar-day:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
  }

  .main-calendar {
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
    min-height: calc(32px + 6 * 110px);
  }
  
  .insumo-item {
    padding: 3px 5px;
    margin-bottom: 3px;
    border-radius: 3px;
    font-size: 0.65rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .insumo-item .btn-sm { padding: 2px 5px; font-size: 0.6rem; }
  
  .badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 15px; }
  .modal-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #3d5061 100%);
    color: white;
  }
  
  .calendar-container { display: flex; gap: 15px; }
  
  .calendar-legend { margin-top: 12px; font-size: 0.75rem; }
  .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
  .legend-color { width: 14px; height: 14px; margin-right: 5px; border-radius: 3px; }
  
  .week-view {
    display: none;
    margin-top: 15px;
  }
  
  .view-toggle {
    margin-bottom: 12px;
  }

  .no-fecha-warning {
    text-align: center;
    padding: 20px;
    background: #fff3cd;
    border: 2px solid #ffc107;
    border-radius: 6px;
    color: #856404;
    font-size: 1rem;
    font-weight: 600;
  }

  .no-fecha-warning i {
    font-size: 1.8rem;
    display: block;
    margin-bottom: 12px;
  }
  
  @media (max-width: 768px) {
    h1 { font-size: 1.4rem; }
    .table-responsive { overflow-x: auto; }
    .card-header { font-size: 1rem; padding: 10px 12px; }
    .calendar-nav { flex-direction: column; gap: 8px; }
    .calendar { grid-template-columns: repeat(1, 1fr); }
    .calendar-container { flex-direction: column; }
    .calendar-hourly { grid-template-columns: 55px repeat(7, 1fr); }
  }
  
  #modalCalendario .modal-dialog {
    max-width: 95%;
    width: 100%;
  }
</style>

</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-calendar-check"></i> Agenda Quirúrgica</h1>
      <p class="description">Gestión de cirugías y procedimientos del sistema Oftavisión.</p>
    </header>

    <div class="success-alert" id="successAlert">
      <i class="fas fa-check-circle"></i> <span id="successMessage">Operación realizada correctamente.</span>
    </div>

    <div class="card">
      <div class="card-header"><i class="fas fa-list"></i> Órdenes de Cirugía</div>

      <div class="mb-3 px-3">
        <label for="filtroRangoOrdenes" class="form-label fw-bold">Filtrar por fecha:</label>
        <input type="text" id="filtroRangoOrdenes" class="form-control" style="max-width:300px;" placeholder="Selecciona un rango de fechas" readonly>
      </div>

      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered align-middle">
            <thead>
              <tr>
                <th>Expediente</th>
                <th>Fecha</th>
                <th>Edad</th>
                <th>Nombre</th>
                <th>Procedimiento</th>
                <th>Total Orden</th>
                <th>Pagos Realizados</th>
                <th>Diferencia</th>
                <th>Status</th>
                <th>Tipo de Lente</th>
                <th>Agendado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tablaOrdenes"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalCalendario" tabindex="-1">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-calendar"></i> Calendario de Cirugías</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="view-toggle">
              <button class="btn btn-primary" id="toggleViewBtn">
                <i class="fas fa-calendar-week"></i> Cambiar a Vista Semanal
              </button>
            </div>
            
            <div id="monthlyView">
              <div class="calendar-container">
                <div class="calendar-legend">
                  <h6>Leyenda de Procedimientos</h6>
                  <div class="legend-item">
                    <div class="legend-color" style="background-color: #f5cbfd; border-left: 4px solid #e46bf6;"></div>
                    <div class="legend-text">Cirugía de Catarata</div>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color" style="background-color: #c9e7fd; border-left: 4px solid #2196f3;"></div>
                    <div class="legend-text">Consulta</div>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color" style="background-color: #f7f9d2; border-left: 4px solid #fbf866;"></div>
                    <div class="legend-text">Procedimiento de Lente</div>
                  </div>
                </div>

                <div class="main-calendar">
                  <div class="calendar-nav">
                    <button class="btn btn-primary" onclick="cambiarMesCirugia(-1)">
                      <i class="fas fa-chevron-left"></i> Mes anterior
                    </button>
                    <div class="current-month" id="mesCirugia"></div>
                    <button class="btn btn-primary" onclick="cambiarMesCirugia(1)">
                      Mes siguiente <i class="fas fa-chevron-right"></i>
                    </button>
                  </div>
                  <div class="calendar" id="calendarioCirugias"></div>
                </div>
              </div>
            </div>
            
            <div id="weeklyView" class="week-view">
              <div class="calendar-nav">
                <button class="btn btn-primary" onclick="cambiarSemana(-1)">
                  <i class="fas fa-chevron-left"></i> Semana anterior
                </button>
                <div class="current-month" id="semanaActual"></div>
                <button class="btn btn-primary" onclick="cambiarSemana(1)">
                  Semana siguiente <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              <div class="calendar-hourly" id="calendarioHoras"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>Sistema de Gestión Oftavisión &copy; 2025</p>
    </div>
  </div>

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    let fechaCirugia = new Date();
    let fechaMiniCalendario = new Date();
    let ordenSeleccionada = null;
    let fechaSemana = new Date();
    let vistaActual = 'mensual';
    let fechaAgendadaActual = null;
    let todasLasOrdenes = []; // GUARDAR TODAS LAS ÓRDENES PARA BUSCAR LUEGO

    function formatFecha(fecha) {
      if (!fecha) return '<span class="text-muted">No asignado</span>';
      const partes = fecha.split("T")[0].split("-");
      const f = new Date(parseInt(partes[0]), parseInt(partes[1]) - 1, parseInt(partes[2]));
      if (isNaN(f)) return '<span class="text-muted">No asignado</span>';
      return f.toLocaleDateString("es-MX", { day: "2-digit", month: "2-digit", year: "numeric" });
    }

    function convertirHora12(hora) {
      if (!hora) return '';
      let [h, m] = hora.split(':');
      h = parseInt(h);
      const sufijo = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      return `${h}:${m.padStart(2, '0')} ${sufijo}`;
    }

    async function cargarOrdenes(year, month) {
      try {
        const res = await fetch('/api/ordenes');
        let ordenes = await res.json();
        todasLasOrdenes = ordenes; // GUARDAR LAS ÓRDENES

        if (year !== undefined && month !== undefined) {
          ordenes = ordenes.filter(o => {
            if (!o.fecha_agendada) return true;
            const f = new Date(o.fecha_agendada);
            return f.getFullYear() === year && f.getMonth() === month;
          });
        }

        document.getElementById("tablaOrdenes").innerHTML = ordenes.map(o => `
          <tr>
            <td>${o.expediente}</td>
            <td>${formatFecha(o.fecha_creacion)}</td>
            <td>${o.edad}</td>
            <td>${o.nombre}</td>
            <td>${o.procedimiento}</td>
            <td>$${parseFloat(o.total).toLocaleString("es-MX", {minimumFractionDigits: 2})}</td>
            <td>$${parseFloat(o.pagos).toLocaleString("es-MX", {minimumFractionDigits: 2})}</td>
            <td>$${parseFloat(o.diferencia).toLocaleString("es-MX", {minimumFractionDigits: 2})}</td>
            <td>
              <span class="badge ${o.status.toLowerCase() === 'pagado' ? 'bg-success' : 'bg-warning'}">
                ${o.status}
              </span>
            </td>
            <td>
              <span class="lente-btn text-primary fw-bold"
                    style="cursor:pointer;"
                    data-id="${o.id}"
                    data-valor="${o.tipo_lente || ""}">
                ${o.tipo_lente || '<span class="text-muted">Asignar</span>'}
              </span>
            </td>
            <td>
              ${formatFecha(o.fecha_agendada)}
              ${o.hora_cirugia ? `<br><small>${convertirHora12(o.hora_cirugia)}</small>` : ""}
            </td>
            <td>
              ${o.fecha_agendada ? 
                '<span class="text-muted">Asignado</span>' : 
                `<button class="btn btn-sm btn-primary" onclick="abrirCalendario(${o.id})">
                  <i class="fas fa-calendar-plus"></i> Agendar
                </button>`}
              ${o.fecha_agendada ?  `
                <button class="btn btn-sm btn-warning mt-1" onclick="editarCirugia(${o.id})">
                  <i class="fas fa-edit"></i> Reprogramar
                </button>` : ''}
            </td>
          </tr>
        `).join('');

      } catch (err) {
        console.error("Error cargando órdenes:", err);
        mostrarError("Error", "No se pudieron cargar las órdenes");
      }
    }

    async function cargarOrdenesPorRango(desde, hasta) {
      try {
        const res = await fetch(`/api/ordenes?desde=${desde}&hasta=${hasta}`);
        let ordenes = await res.json();
        todasLasOrdenes = ordenes; // GUARDAR LAS ÓRDENES

        const tbody = document.getElementById("tablaOrdenes");

        if (ordenes.length === 0) {
          tbody.innerHTML = `<tr><td colspan="12" class="text-muted">Sin resultados en este rango</td></tr>`;
          return;
        }

        tbody.innerHTML = ordenes.map(o => `
          <tr>
            <td>${o.expediente}</td>
            <td>${formatFecha(o.fecha_creacion)}</td>
            <td>${o.edad}</td>
            <td>${o.nombre}</td>
            <td>${o.procedimiento}</td>
            <td>$${parseFloat(o.total).toLocaleString("es-MX", {minimumFractionDigits: 2})}</td>
            <td>$${parseFloat(o.pagos).toLocaleString("es-MX", {minimumFractionDigits: 2})}</td>
            <td>$${parseFloat(o.diferencia).toLocaleString("es-MX", {minimumFractionDigits: 2})}</td>
            <td>
              <span class="badge ${o.status.toLowerCase() === 'pagado' ? 'bg-success' : 'bg-warning'}">
                ${o.status}
              </span>
            </td>
            <td>
              <span class="lente-btn text-primary fw-bold"
                    style="cursor:pointer;"
                    data-id="${o.id}"
                    data-valor="${o.tipo_lente || ""}">
                ${o.tipo_lente || '<span class="text-muted">Asignar</span>'}
              </span>
            </td>
            <td>
              ${formatFecha(o.fecha_agendada)}
              ${o.hora_cirugia ? `<br><small>${convertirHora12(o.hora_cirugia)}</small>` : ""}
            </td>
            <td>
              ${o.fecha_agendada ? 
                '<span class="text-muted">Asignado</span>' : 
                `<button class="btn btn-sm btn-primary" onclick="abrirCalendario(${o.id})">
                  <i class="fas fa-calendar-plus"></i> Agendar
                </button>`}
              ${o.fecha_agendada ? `
                <button class="btn btn-sm btn-warning mt-1" onclick="editarCirugia(${o.id})">
                  <i class="fas fa-edit"></i> Reprogramar
                </button>` : ''}
            </td>
          </tr>
        `).join('');

      } catch (err) {
        console.error("Error filtrando órdenes:", err);
      }
    }

    function getColorClass(proc) {
      const texto = proc.toLowerCase();
      if (texto.includes("catarata")) return "proc-catarata";
      if (texto.includes("consulta")) return "proc-consulta";
      if (texto.includes("lente")) return "proc-lente";
      return "";
    }

    function abreviarNombre(nombre) {
      if (!nombre) return "";
      const partes = nombre.trim().split(" ");
      if (partes.length <= 2) return nombre;
      const abreviado = partes.slice(0, -1).join(" ") + " " + partes[partes.length - 1][0] + ".";
      return abreviado;
    }

    async function renderCalendarCirugias() {
      const calendario = document.getElementById("calendarioCirugias");
      const mesActual = document.getElementById("mesCirugia");

      const year = fechaCirugia.getFullYear();
      const month = fechaCirugia.getMonth();

      mesActual.textContent = fechaCirugia.toLocaleString("es-ES", { month: "long", year: "numeric" });

      const primerDia = new Date(year, month, 1).getDay() || 7;
      const diasEnMes = new Date(year, month + 1, 0).getDate();

      let cirugias = [];
      try {
        const res = await fetch("/api/cirugias");
        cirugias = await res.json();
      } catch (err) {
        console.error("Error al cargar cirugías:", err);
      }

      const filtradas = cirugias.filter(c => {
        if (!c.fecha_cirugia) return false;
        const f = new Date(c.fecha_cirugia);
        return f.getFullYear() === year && f.getMonth() === month;
      });

      calendario.innerHTML = "";

      ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"].forEach(d => {
        calendario.innerHTML += `<div class="day-header">${d}</div>`;
      });

      let totalDias = 0;

      for (let i = 1; i < primerDia; i++) {
        calendario.innerHTML += `<div class="empty-day"></div>`;
        totalDias++;
      }

      for (let d = 1; d <= diasEnMes; d++) {
        totalDias++;
        const fechaDia = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;

        const programadas = filtradas.filter(c => {
          let f;
          if (typeof c.fecha_cirugia === "string") {
            f = c.fecha_cirugia.split("T")[0];
          } else {
            const d2 = new Date(c.fecha_cirugia);
            f = `${d2.getFullYear()}-${String(d2.getMonth() + 1).padStart(2, "0")}-${String(d2.getDate()).padStart(2, "0")}`;
          }
          return f === fechaDia;
        });

        let contenido = `<div class="calendar-day" onclick="asignarFecha('${fechaDia}')">
                          <div class="day-number">${d}</div>`;

        if (programadas.length > 0) {
          programadas.forEach(c => {
            contenido += `
              <div class="insumo-item ${getColorClass(c.procedimiento)}">
                <span>${abreviarNombre(c.nombre)} - ${c.procedimiento}</span>
                <button class="btn btn-sm btn-danger"
                        onclick="event.stopPropagation(); eliminarCirugia(${c.id})">
                  <i class="fas fa-trash"></i>
                </button>
              </div>`;
          });
        }

        contenido += "</div>";
        calendario.innerHTML += contenido;
      }

      while (totalDias < 42) {
        calendario.innerHTML += `<div class="empty-day"></div>`;
        totalDias++;
      }
    }

    function cambiarMesCirugia(offset) {
      fechaCirugia.setMonth(fechaCirugia.getMonth() + offset);
      renderCalendarCirugias();
    }

    function agendarCirugia(idOrden) {
      Swal.fire({
        title: 'Asignar fecha de cirugía',
        input: 'date',
        showCancelButton: true,
        confirmButtonText: 'Asignar',
        cancelButtonText: 'Cancelar'
      }).then(async (result) => {
        if (result.isConfirmed) {
          const fecha = result.value;
          try {
            await fetch(`/api/ordenes/${idOrden}/agendar`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ fecha_agendada: fecha })
            });
            mostrarExito("Cirugía agendada", "La cirugía ha sido agendada correctamente");
            renderCalendarCirugias();
          } catch (err) {
            console.error("Error al agendar:", err);
            mostrarError("Error", "No se pudo agendar la cirugía");
          }
        }
      });
    }

    function editarCirugia(idOrden) {
      ordenSeleccionada = idOrden;
      
      // BUSCAR LA ORDEN EN EL ARRAY GUARDADO
      const orden = todasLasOrdenes.find(o => o.id === idOrden);
      
      if (orden && orden.fecha_agendada) {
        fechaAgendadaActual = orden.fecha_agendada.split("T")[0];
      } else {
        fechaAgendadaActual = null;
      }
      
      console.log("Editando cirugía:", idOrden, "Fecha agendada:", fechaAgendadaActual);
      
      const modal = new bootstrap.Modal(document.getElementById("modalCalendario"));
      modal.show();
      
      // Si está en vista semanal, renderizar con la fecha agendada
      if (vistaActual === 'semanal') {
        renderCalendarHoras();
      }
    }

    function editarLente(idOrden, tipoActual) {
      Swal.fire({
        title: tipoActual ? 'Editar Tipo de Lente' : 'Añadir Tipo de Lente',
        input: 'text',
        inputValue: tipoActual || '',
        inputPlaceholder: 'Ejemplo: Lente Intraocular',
        showCancelButton: true,
        confirmButtonText: 'Guardar',
        cancelButtonText: 'Cancelar',
        preConfirm: (valor) => {
          if (!valor.trim()) {
            Swal.showValidationMessage('Debes ingresar un tipo de lente');
          }
          return valor;
        }
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await fetch(`/api/ordenes/${idOrden}/lente`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ tipo_lente: result.value })
            });
            mostrarExito("Tipo de lente actualizado", "El tipo de lente fue actualizado correctamente");
          } catch (err) {
            console.error("Error al actualizar tipo de lente:", err);
            mostrarError("Error", "No se pudo actualizar el tipo de lente");
          }
        }
      });
    }

    function abrirCalendario(idOrden) {
      ordenSeleccionada = idOrden;
      
      // BUSCAR LA ORDEN EN EL ARRAY GUARDADO
      const orden = todasLasOrdenes.find(o => o.id === idOrden);
      
      if (orden && orden.fecha_agendada) {
        fechaAgendadaActual = orden.fecha_agendada.split("T")[0];
      } else {
        fechaAgendadaActual = null;
      }
      
      console.log("Abriendo calendario:", idOrden, "Fecha agendada:", fechaAgendadaActual);
      
      const modal = new bootstrap.Modal(document.getElementById("modalCalendario"));
      modal.show();
    }

    async function asignarFecha(fecha) {
      if (!ordenSeleccionada) return;

      try {
        await fetch(`/api/ordenes/${ordenSeleccionada}/agendar`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fecha_cirugia: fecha })
        });

        // Guardar la fecha agendada y mantener la orden seleccionada
        fechaAgendadaActual = fecha;

        // Cambiar automáticamente a vista semanal para asignar hora
        const monthlyView = document.getElementById('monthlyView');
        const weeklyView = document.getElementById('weeklyView');
        const toggleBtn = document.getElementById('toggleViewBtn');

        monthlyView.style.display = 'none';
        weeklyView.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-calendar-alt"></i> Cambiar a Vista Mensual';
        vistaActual = 'semanal';

        renderCalendarHoras();
        renderCalendarCirugias();

        // Recargar órdenes para actualizar todasLasOrdenes
        const hoyStr = moment().format("YYYY-MM-DD");
        await cargarOrdenesPorRango(hoyStr, hoyStr);

        Swal.fire({
          icon: 'success',
          title: 'Fecha asignada',
          text: `Ahora selecciona la hora para el ${fecha}`,
          timer: 2000,
          showConfirmButton: false
        });
      } catch (err) {
        console.error("Error al asignar cirugía:", err);
        mostrarError("Error", "No se pudo asignar la cirugía");
      }
    }

    function eliminarCirugia(idOrden) {
      Swal.fire({
        title: '¿Eliminar cirugía?',
        text: "Esta acción no se puede deshacer.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await fetch(`/api/ordenes/${idOrden}/agendar`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ fecha_cirugia: null })
            });
            mostrarExito("Cirugía eliminada", "La cirugía ha sido eliminada del calendario");
            renderCalendarCirugias(); 
            
            // Recargar órdenes
            const hoyStr = moment().format("YYYY-MM-DD");
            await cargarOrdenesPorRango(hoyStr, hoyStr);
          } catch (err) {
            console.error("Error al eliminar cirugía:", err);
            mostrarError("Error", "No se pudo eliminar la cirugía");
          }
        }
      });
    }

    function mostrarExito(titulo, mensaje) {
      document.getElementById('successMessage').textContent = mensaje;
      document.getElementById('successAlert').style.display = 'block';
      
      setTimeout(() => {
        document.getElementById('successAlert').style.display = 'none';
      }, 5000);
      
      Swal.fire({
        icon: 'success',
        title: titulo,
        text: mensaje,
        timer: 3000,
        showConfirmButton: false
      });
    }

    function mostrarError(titulo, mensaje) {
      Swal.fire({
        icon: 'error',
        title: titulo,
        text: mensaje
      });
    }

    $(document).ready(function () {
      $('#filtroRangoOrdenes').daterangepicker({
        autoUpdateInput: false,
        locale: {
          format: 'DD/MM/YYYY',
          separator: " - ",
          applyLabel: "Aplicar",
          cancelLabel: "Cancelar",
          fromLabel: "Desde",
          toLabel: "Hasta",
          customRangeLabel: "Rango personalizado",
          weekLabel: "S",
          daysOfWeek: ["Do","Lu","Ma","Mi","Ju","Vi","Sa"],
          monthNames: [
            "Enero","Febrero","Marzo","Abril","Mayo","Junio",
            "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
          ],
          firstDay: 1
        },
        ranges: {
          'Hoy': [moment(), moment()],
          'Ayer': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
          'Últimos 7 Días': [moment().subtract(6, 'days'), moment()],
          'Últimos 30 Días': [moment().subtract(29, 'days'), moment()],
          'Este Mes': [moment().startOf('month'), moment().endOf('month')],
          'Mes Pasado': [
            moment().subtract(1, 'month').startOf('month'),
            moment().subtract(1, 'month').endOf('month')
          ]
        }
      });

      $('#filtroRangoOrdenes').on('apply.daterangepicker', function(ev, picker) {
        $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
        cargarOrdenesPorRango(picker.startDate.format("YYYY-MM-DD"), picker.endDate.format("YYYY-MM-DD"));
      });

      $('#filtroRangoOrdenes').on('cancel.daterangepicker', function(ev, picker) {
        $(this).val('');
        cargarOrdenes();
      });

      const hoy = moment();
      $('#filtroRangoOrdenes').val(hoy.format('DD/MM/YYYY') + ' - ' + hoy.format('DD/MM/YYYY'));
      cargarOrdenesPorRango(hoy.format("YYYY-MM-DD"), hoy.format("YYYY-MM-DD"));
    });

    function cambiarVista() {
      const monthlyView = document.getElementById('monthlyView');
      const weeklyView = document.getElementById('weeklyView');
      const toggleBtn = document.getElementById('toggleViewBtn');
      
      if (vistaActual === 'mensual') {
        monthlyView.style.display = 'none';
        weeklyView.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-calendar-alt"></i> Cambiar a Vista Mensual';
        vistaActual = 'semanal';
        renderCalendarHoras();
      } else {
        monthlyView.style.display = 'block';
        weeklyView.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-calendar-week"></i> Cambiar a Vista Semanal';
        vistaActual = 'mensual';
      }
    }

    function cambiarSemana(offset) {
      fechaSemana.setDate(fechaSemana.getDate() + (offset * 7));
      renderCalendarHoras();
    }

    async function renderCalendarHoras() {
      const calendarioHoras = document.getElementById("calendarioHoras");
      const semanaActual = document.getElementById("semanaActual");
      
      console.log("Renderizando calendario de horas. Fecha agendada:", fechaAgendadaActual);
      
      // SI NO HAY FECHA AGENDADA, MOSTRAR ADVERTENCIA
      if (!fechaAgendadaActual) {
        calendarioHoras.innerHTML = `
          <div class="no-fecha-warning" style="grid-column: 1 / -1;">
            <i class="fas fa-exclamation-triangle"></i>
            <div>Esta orden no tiene una fecha agendada.</div>
            <div style="margin-top: 10px; font-size: 0.9rem;">
              Por favor, asigna primero una fecha en la vista mensual antes de programar la hora.
            </div>
          </div>
        `;
        return;
      }
      
      // Calcular la semana que contiene la fecha agendada
      const fechaAgendada = new Date(fechaAgendadaActual + "T00:00:00");
      const lunes = new Date(fechaAgendada);
      lunes.setDate(lunes.getDate() - (lunes.getDay() === 0 ? 6 : lunes.getDay() - 1));
      
      const domingo = new Date(lunes);
      domingo.setDate(domingo.getDate() + 6);

      semanaActual.textContent = `${lunes.toLocaleDateString("es-ES", { day: "2-digit", month: "2-digit" })} - ${domingo.toLocaleDateString("es-ES", { day: "2-digit", month: "2-digit", year: "numeric" })}`;

      let cirugias = [];
      try {
        const res = await fetch("/api/cirugias");
        cirugias = await res.json();
      } catch (err) {
        console.error("Error al cargar cirugías:", err);
      }

      // Generar intervalos cada 30 minutos desde 8:00 hasta 18:00
      const horas = [];
      for (let h = 8; h <= 18; h++) {
        horas.push(`${String(h).padStart(2, "0")}:00`);
        if (h < 18) {
          horas.push(`${String(h).padStart(2, "0")}:30`);
        }
      }

      const dias = [];
      const fechaActual = new Date(lunes);
      for (let i = 0; i < 7; i++) {
        dias.push(new Date(fechaActual));
        fechaActual.setDate(fechaActual.getDate() + 1);
      }

      let html = '';
      html += '<div class="hour-label">Hora</div>';
      
      // ENCABEZADOS DE DÍA CON RESALTADO
      dias.forEach(dia => {
        const fechaDia = `${dia.getFullYear()}-${String(dia.getMonth() + 1).padStart(2, "0")}-${String(dia.getDate()).padStart(2, "0")}`;
        const esDiaAgendado = fechaDia === fechaAgendadaActual;
        
        console.log("Comparando:", fechaDia, "con", fechaAgendadaActual, "=", esDiaAgendado);
        
        html += `<div class="day-header-hourly ${esDiaAgendado ? 'dia-agendado' : ''}">${dia.toLocaleDateString("es-ES", { weekday: "short", day: "2-digit" })}</div>`;
      });

      horas.forEach(hora => {
        html += `<div class="hour-label">${hora}</div>`;

        dias.forEach(dia => {
          const fechaDia = `${dia.getFullYear()}-${String(dia.getMonth() + 1).padStart(2, "0")}-${String(dia.getDate()).padStart(2, "0")}`;
          const esDiaAgendado = fechaDia === fechaAgendadaActual;
          
          // Buscar coincidencias normalizando formato HH:MM
          const cirugiasDia = cirugias.filter(c => {
            if (!c.fecha_cirugia || !c.hora_cirugia) return false;
            const fechaCirugia = c.fecha_cirugia.split("T")[0];
            const horaSQL = c.hora_cirugia.slice(0,5); // Toma solo HH:MM
            return fechaCirugia === fechaDia && horaSQL === hora;
          });

          let clase = "hour-slot";
          let contenido = '';
          let onclick = '';

          if (esDiaAgendado) {
            // SLOTS DEL DÍA AGENDADO - HABILITADOS
            clase += " dia-agendado-slot";
            onclick = `onclick="asignarFechaHora('${fechaDia}', '${hora}')"`;
          } else {
            // SLOTS DE OTROS DÍAS - DESHABILITADOS
            clase += " disabled-slot";
            onclick = `onclick="event.preventDefault(); Swal.fire({icon: 'warning', title: 'Día no disponible', text: 'Solo puedes asignar hora en el día agendado: ${fechaAgendadaActual}'})"`;
          }

          if (cirugiasDia.length > 0) {
            clase += " booked";
            cirugiasDia.forEach(c => {
              contenido += `
                <div class="surgery-event ${getColorClass(c.procedimiento)}" 
                     title="${c.nombre} - ${c.procedimiento}">
                  <strong>${abreviarNombre(c.nombre)}</strong><br>
                  <small>${c.procedimiento}</small>
                </div>`;
            });
          }

          html += `<div class="${clase}" ${onclick}>${contenido}</div>`;
        });
      });

      calendarioHoras.innerHTML = html;
    }

    async function asignarFechaHora(fecha, hora) {
      if (!ordenSeleccionada) return;

      // VALIDAR QUE LA FECHA COINCIDA CON LA AGENDADA
      if (fecha !== fechaAgendadaActual) {
        Swal.fire({
          icon: 'warning',
          title: 'Fecha incorrecta',
          text: `Solo puedes asignar hora en la fecha agendada: ${fechaAgendadaActual}`
        });
        return;
      }

      try {
        await fetch(`/api/ordenes/${ordenSeleccionada}/agendar`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            fecha_cirugia: fecha,
            hora_cirugia: hora
          })
        });
        mostrarExito("Cirugía asignada", `Fecha: ${fecha} a las ${hora}`);

        ordenSeleccionada = null;
        fechaAgendadaActual = null;
        renderCalendarHoras();   
        
        // Recargar órdenes
        const hoyStr = moment().format("YYYY-MM-DD");
        await cargarOrdenesPorRango(hoyStr, hoyStr);

        const modal = bootstrap.Modal.getInstance(document.getElementById("modalCalendario"));
        modal.hide();
      } catch (err) {
        console.error("Error al asignar cirugía:", err);
        mostrarError("Error", "No se pudo asignar la cirugía");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderCalendarCirugias();
      document.getElementById('toggleViewBtn').addEventListener('click', cambiarVista);
    });

    document.addEventListener("click", async (e) => {
      if (e.target.classList.contains("lente-btn")) {
        const ordenId = e.target.dataset.id;
        const valorActual = e.target.dataset.valor;

        const { value: nuevoValor } = await Swal.fire({
          title: valorActual ? 'Editar Tipo de Lente' : 'Asignar Tipo de Lente',
          input: 'text',
          inputValue: valorActual || '',
          inputPlaceholder: 'Ejemplo: Lente Intraocular',
          showCancelButton: true,
          confirmButtonText: 'Guardar',
          cancelButtonText: 'Cancelar',
          preConfirm: (valor) => {
            if (!valor.trim()) {
              Swal.showValidationMessage('Debes ingresar un tipo de lente');
            }
            return valor;
          }
        });

        if (!nuevoValor) return;

        try {
          const res = await fetch(`/api/ordenes/${ordenId}/lente`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tipo_lente: nuevoValor })
          });

          if (res.ok) {
            Swal.fire('✅ Guardado', 'Tipo de lente actualizado', 'success');
            const hoyStr = moment().format("YYYY-MM-DD");
            cargarOrdenesPorRango(hoyStr, hoyStr);
          } else {
            Swal.fire('❌ Error', 'No se pudo actualizar el tipo de lente', 'error');
          }
        } catch (err) {
          console.error(err);
          Swal.fire('❌ Error', 'Ocurrió un error en el servidor', 'error');
        }
      }
    });
  </script>
</body>
</html>