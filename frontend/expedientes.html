<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Expedientes</title>
    <link rel="icon" type="image/png" href="/uploads/logo-oftavision2.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root {
  --primary-color: #2c3e50;
  --secondary-color: #3498db;
  --accent-color: #e74c3c;
  --success-color: #27ae60;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #f0f5ff 0%, #e3f2fd 100%);
  padding: 20px;
  color: #333;
  min-height: 100vh;
}

.container { max-width: 1400px; margin: 0 auto; }

header {
  text-align: center;
  margin-bottom: 30px;
  padding: 20px;
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  border-radius: 10px;
  box-shadow: 0 6px 15px rgba(0,0,0,0.1);
}

h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 700; }

.card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  margin-bottom: 30px;
  overflow: hidden;
  border: none;
}

.card-header {
  background: linear-gradient(135deg, var(--primary-color) 0%, #3d5061 100%);
  color: white;
  padding: 18px 25px;
  font-size: 1.3rem;
  font-weight: 600;
  display: flex;
  align-items: center;
}

.card-header i { margin-right: 12px; font-size: 1.5rem; }
.card-body { padding: 25px; }
.form-group { margin-bottom: 25px; }

label {
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--primary-color);
}

input, select {
  padding: 12px 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 1rem;
  width: 100%;
  transition: all 0.3s;
}

input:focus, select:focus {
  border-color: var(--secondary-color);
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
  outline: none;
}

.btn {
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  border: none;
  border-radius: 8px;
  padding: 12px 20px;
  font-size: 1rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn-primary {
  background: linear-gradient(135deg, var(--secondary-color) 0%, #2c80b9 100%);
  color: white;
  box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
}
.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
}

.btn-success {
  background: linear-gradient(135deg, var(--success-color) 0%, #219653 100%);
  color: white;
  box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);
}
.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(39, 174, 96, 0.4);
}

.btn-danger {
  background: linear-gradient(135deg, var(--accent-color) 0%, #c0392b 100%);
  color: white;
  box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
}
.btn-danger:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(231, 76, 60, 0.4);
}

.table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
}

.table th {
  background: linear-gradient(135deg, var(--primary-color) 0%, #3d5061 100%);
  color: white;
  padding: 15px;
  text-align: center;
  font-weight: 600;
}

.table td {
  padding: 12px;
  border-bottom: 1px solid #eee;
  text-align: center;
  font-size: 0.9rem;
  vertical-align: middle;
}

.table tr:nth-child(odd) { background: #f9f9f9; }
.table tr:hover { background-color: #eef6ff; }

.table .btn {
  width: 32px !important;
  height: 32px !important;
  padding: 0 !important;
  border-radius: 6px !important;
}

.table .btn i {
  margin: 0 !important;
  font-size: 15px !important;
}

.badge {
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 600;
}

.badge.bg-info {
  background: linear-gradient(135deg, var(--secondary-color) 0%, #2c80b9 100%) !important;
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  padding: 15px 20px;
  background: white;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.search-section {
  display: flex;
  gap: 10px;
  align-items: center;
}

.search-section input {
  padding: 12px 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 1rem;
  width: 300px;
}

#expedienteForm {
  background: white;
  padding: 25px;
  border-radius: 10px;
  margin-bottom: 25px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
}

.footer {
  text-align: center;
  margin-top: 40px;
  color: #6c757d;
  font-size: 0.9rem;
}
</style>

</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-folder"></i> Gestión de Expedientes</h1>
        </header>

        <div class="top-bar">
            <div class="search-section">
                <input type="text" id="buscarInput" placeholder="Buscar por número de expediente o nombre...">
                <button class="btn btn-primary" onclick="buscarExpediente()">
                    <i class="fas fa-search"></i> Buscar
                </button>
            </div>
            <button class="btn btn-success" onclick="nuevoExpediente()">
                <i class="fas fa-plus"></i> Nuevo Expediente
            </button>
        </div>

        <div class="card" id="expedienteForm" style="display:none;">
            <div class="card-header">
                <i class="fas fa-file-medical"></i> Formulario de Expediente
            </div>
            <div class="card-body">
                <form onsubmit="guardarExpediente(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Número de Expediente:</label>
                            <input type="text" id="numero_expediente" readonly placeholder="Se generará automáticamente">
                        </div>
                        <div class="form-group">
                            <label>Nombre Completo:</label>
                            <input type="text" id="nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha de Nacimiento:</label>
                            <input type="date" id="fecha_nacimiento" required onchange="calcularEdad()">
                        </div>
                        <div class="form-group">
                            <label>Edad:</label>
                            <input type="number" id="edad" readonly>
                        </div>
                        <div class="form-group">
                            <label>Padecimientos:</label>
                            <select id="padecimientos" required>
                                <option value="">Seleccione...</option>
                                <option value="DIABETES">DIABETES</option>
                                <option value="HIPERTENSO">HIPERTENSO</option>
                                <option value="NINGUNO">NINGUNO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Colonia:</label>
                            <input type="text" id="colonia">
                        </div>
                        <div class="form-group">
                            <label>Ciudad:</label>
                            <input type="text" id="ciudad">
                        </div>
                        <div class="form-group">
                            <label>Teléfono 1:</label>
                            <input type="text" id="telefono1">
                        </div>
                        <div class="form-group">
                            <label>Teléfono 2:</label>
                            <input type="text" id="telefono2">
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                        <button type="button" class="btn btn-danger" onclick="cancelarFormulario()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card" id="tablaExpedientes">
            <div class="card-header">
                <i class="fas fa-list"></i> Lista de Expedientes
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Nombre</th>
                                <th>Edad</th>
                                <th>Padecimiento</th>
                                <th>Colonia</th>
                                <th>Ciudad</th>
                                <th>Tel. 1</th>
                                <th>Tel. 2</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="listaExpedientes"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Sistema de Gestión Oftavisión © 2025</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
window.usuarioRol = sessionStorage.getItem("usuarioRol") || localStorage.getItem("usuarioRol") || "admin";

async function cargarExpedientes() {
    const res = await fetch('/api/expedientes');
    const data = await res.json();
    const tbody = document.getElementById('listaExpedientes');
    tbody.innerHTML = '';

    data.forEach(exp => {
        tbody.innerHTML += `
            <tr>
                <td>${exp.numero_expediente}</td>
                <td>${exp.nombre_completo}</td>
                <td>${exp.edad}</td>
                <td><span class="badge bg-info">${exp.padecimientos}</span></td>
                <td>${exp.colonia}</td>
                <td>${exp.ciudad}</td>
                <td>${exp.telefono1}</td>
                <td>${exp.telefono2 || ''}</td>
                <td>
                    <div class="d-flex justify-content-center gap-1">
                        <button class="btn btn-primary btn-sm" title="Editar" onclick="editarExpediente(${exp.numero_expediente})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-warning btn-sm" title="Médico" onclick="verMedico(${exp.numero_expediente}, '${exp.nombre_completo}')">
                            <i class="fas fa-stethoscope"></i>
                        </button>
                        <button class="btn btn-info btn-sm" title="Optometría" onclick="verOptometria(${exp.numero_expediente}, '${exp.nombre_completo}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${window.usuarioRol === "admin" ? `<button class="btn btn-danger btn-sm" title="Eliminar" onclick="eliminarExpediente(${exp.numero_expediente})"><i class="fas fa-trash"></i></button>` : ""}
                    </div>
                </td>
            </tr>
        `;
    });
}

function nuevoExpediente() {
    const form = document.querySelector('#expedienteForm form');
    if (form) form.reset();
    
    document.getElementById('numero_expediente').value = '';
    document.getElementById('expedienteForm').style.display = 'block';
    document.getElementById('tablaExpedientes').style.display = 'none';
    
    setTimeout(() => {
        document.getElementById('expedienteForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
}

function cancelarFormulario() {
    document.getElementById('expedienteForm').style.display = 'none';
    document.getElementById('tablaExpedientes').style.display = 'block';
}

function calcularEdad() {
    const fecha = document.getElementById('fecha_nacimiento').value;
    if (fecha) {
        const nacimiento = new Date(fecha);
        const hoy = new Date();
        let edad = hoy.getFullYear() - nacimiento.getFullYear();
        const mes = hoy.getMonth() - nacimiento.getMonth();
        if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) edad--;
        document.getElementById('edad').value = edad;
    }
}

async function guardarExpediente(e) {
    e.preventDefault();
    const id = document.getElementById('numero_expediente').value;
    const expediente = {
        nombre_completo: document.getElementById('nombre').value,
        fecha_nacimiento: document.getElementById('fecha_nacimiento').value,
        edad: document.getElementById('edad').value,
        padecimientos: document.getElementById('padecimientos').value,
        colonia: document.getElementById('colonia').value,
        ciudad: document.getElementById('ciudad').value,
        telefono1: document.getElementById('telefono1').value,
        telefono2: document.getElementById('telefono2').value
    };

    const url = id ? `/api/expedientes/${id}` : '/api/expedientes';
    const method = id ? 'PUT' : 'POST';

    const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(expediente)
    });

    const data = await res.json();

    if (res.ok) {
        Swal.fire({
            icon: 'success',
            title: id ? 'Expediente actualizado' : 'Expediente creado',
            text: id ? `Número: ${id}` : `Número: ${data.expediente.numero_expediente}`,
            confirmButtonColor: '#3085d6'
        });
        cargarExpedientes();
        cancelarFormulario();
    } else {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.error || 'No se pudo guardar el expediente',
            confirmButtonColor: '#d33'
        });
    }
}

async function editarExpediente(id) {
    try {
        const res = await fetch(`/api/expedientes/${id}`);
        if (!res.ok) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo cargar el expediente' });
            return;
        }

        const data = await res.json();
        document.getElementById('numero_expediente').value = data.numero_expediente;
        document.getElementById('nombre').value = data.nombre_completo;
        document.getElementById('fecha_nacimiento').value = data.fecha_nacimiento.split('T')[0];
        document.getElementById('edad').value = data.edad;
        document.getElementById('padecimientos').value = data.padecimientos;
        document.getElementById('colonia').value = data.colonia || '';
        document.getElementById('ciudad').value = data.ciudad || '';
        document.getElementById('telefono1').value = data.telefono1 || '';
        document.getElementById('telefono2').value = data.telefono2 || '';

        document.getElementById('expedienteForm').style.display = 'block';
        document.getElementById('tablaExpedientes').style.display = 'none';

        setTimeout(() => {
            document.getElementById('expedienteForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    } catch (err) {
        Swal.fire({ icon: 'error', title: 'Error', text: 'Error al cargar los datos del expediente' });
    }
}

async function buscarExpediente() {
    const busqueda = document.getElementById('buscarInput').value.trim();
    if (!busqueda) return cargarExpedientes();

    try {
        const res = await fetch(`/api/expedientes/buscar?q=${encodeURIComponent(busqueda)}`);
        if (!res.ok) {
            Swal.fire({ icon: 'warning', title: 'No encontrado', text: 'No se encontraron expedientes' });
            document.getElementById('listaExpedientes').innerHTML = `<tr><td colspan="9">No encontrado</td></tr>`;
            return;
        }

        const data = await res.json();
        if (data.length === 0) {
            document.getElementById('listaExpedientes').innerHTML = `<tr><td colspan="9">Sin resultados</td></tr>`;
            return;
        }

        const tbody = document.getElementById('listaExpedientes');
        tbody.innerHTML = '';
        data.forEach(exp => {
            tbody.innerHTML += `
                <tr>
                    <td>${exp.numero_expediente}</td>
                    <td>${exp.nombre_completo}</td>
                    <td>${exp.edad}</td>
                    <td><span class="badge bg-info">${exp.padecimientos}</span></td>
                    <td>${exp.colonia}</td>
                    <td>${exp.ciudad}</td>
                    <td>${exp.telefono1}</td>
                    <td>${exp.telefono2 || ''}</td>
                    <td>
                        <div class="d-flex justify-content-center gap-1">
                            <button class="btn btn-primary btn-sm" title="Editar" onclick="editarExpediente(${exp.numero_expediente})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-warning btn-sm" title="Médico" onclick="verMedico(${exp.numero_expediente}, '${exp.nombre_completo}')"><i class="fas fa-stethoscope"></i></button>
                            <button class="btn btn-info btn-sm" title="Optometría" onclick="verOptometria(${exp.numero_expediente}, '${exp.nombre_completo}')"><i class="fas fa-eye"></i></button>
                            ${window.usuarioRol === "admin" ? `<button class="btn btn-danger btn-sm" title="Eliminar" onclick="eliminarExpediente(${exp.numero_expediente})"><i class="fas fa-trash"></i></button>` : ""}
                        </div>
                    </td>
                </tr>
            `;
        });
    } catch (err) {
        Swal.fire({ icon: 'error', title: 'Error', text: 'Error al realizar la búsqueda' });
    }
}

async function verMedico(expedienteId, nombre) {
    const res = await fetch(`/api/expedientes/${expedienteId}/ordenes`);
    const data = await res.json();
    if (!data.length) {
        Swal.fire({ icon: 'info', title: 'Sin órdenes', text: 'No hay órdenes médicas registradas' });
        return;
    }
    let contenido = "";
    data.forEach((orden, idx) => {
        const fecha = orden.fecha ? new Date(orden.fecha).toLocaleDateString('es-MX') : 'N/A';
        contenido += `<h4>Orden #${orden.numero_orden} ${idx === 0 ? '(Más reciente)' : ''}</h4><table class="table"><tr><th>Médico</th><td>${orden.medico}</td></tr><tr><th>Diagnóstico</th><td>${orden.diagnostico}</td></tr><tr><th>Procedimiento</th><td>${orden.procedimiento}</td></tr><tr><th>Fecha</th><td>${fecha}</td></tr></table><hr/>`;
    });
    Swal.fire({ title: `Órdenes de ${nombre}`, html: contenido, width: '60%' });
}

async function verOptometria(expedienteId, nombre) {
    const res = await fetch(`/api/expedientes/${expedienteId}/optometria`);
    const data = await res.json();
    if (!data.length) {
        Swal.fire({ icon: 'info', title: 'Sin registros', text: 'No hay evaluaciones de optometría' });
        return;
    }
    let contenido = "";
    data.forEach((opto, idx) => {
        const fecha = opto.fecha ? opto.fecha.split('T')[0].split('-').reverse().join('/') : 'N/A';
        contenido += `<h4>Evaluación #${opto.id} ${idx === 0 ? '(Más reciente)' : ''}</h4><p><strong>Fecha:</strong> ${fecha}</p><hr/>`;
    });
    Swal.fire({ title: `Optometría de ${nombre}`, html: contenido, width: '70%' });
}

async function eliminarExpediente(id) {
    const confirmacion = await Swal.fire({
        title: '¿Estás seguro?',
        text: "Esto eliminará el expediente permanentemente",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar'
    });

    if (confirmacion.isConfirmed) {
        const res = await fetch(`/api/expedientes/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (res.ok) {
            Swal.fire('Eliminado', data.mensaje, 'success');
            cargarExpedientes();
        } else {
            Swal.fire('Error', data.error || 'No se pudo eliminar', 'error');
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    cargarExpedientes();
    
    const inputBuscar = document.getElementById('buscarInput');
    if (inputBuscar) {
        inputBuscar.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') buscarExpediente();
        });
        inputBuscar.addEventListener('input', function(e) {
            if (e.target.value.trim() === '') cargarExpedientes();
        });
    }
});
</script>
</body>
</html>