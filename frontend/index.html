<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Optavisi√≥n</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      display: flex;
      min-height: 100vh;
      background: #f0f5ff;
    }
    .sidebar {
      width: 240px;
      background: linear-gradient(180deg, #1e2a32, #2c3e50);
      color: #fff;
      box-shadow: 3px 0 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;   /* üëà ahora el men√∫ desliza */
      padding: 20px;
    }

    .sidebar .logout {
      padding: 15px 20px;
      border-top: 1px solid rgba(255,255,255,0.2);
    }




    .sidebar h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .sidebar a {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      color: #fff;
      text-decoration: none;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 6px;
      transition: all 0.2s;
    }

    .sidebar a:hover {
      background: #3498db;
    }

    .sidebar .material-icons {
      font-size: 20px;
    }

    .text-danger {
      color: #ff6b6b !important;
    }

    /* Main */
    .main {
      flex: 1;
      padding: 25px;
      background: #f4f6f8;
    }

    iframe {
      width: 100%;
      height: 85vh;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* Modal */
    .modal-content {
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .modal-header {
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: white;
    }

    .small-muted {
      font-size: .9rem;
      color: #6c757d;
    }

    /* Estilo para las opciones del selector de sucursal */
    #sucursal-selector .dropdown-menu {
      background-color: #fff;   /* Fondo blanco */
      color: #000;              /* Texto negro */
    }

    #sucursal-selector .dropdown-item {
      color: #000;              /* Texto negro */
    }

    #sucursal-selector .dropdown-item:hover {
      background-color: #3498db; /* Fondo azul al pasar */
      color: #fff;              /* Texto blanco */
    }

    /* Botones personalizados */
    .btn-editar { background: #1976d2; color: white; }
    .btn-editar:hover { background: #0d47a1; }

    .btn-medico { background: #009688; color: white; }
    .btn-medico:hover { background: #00695c; }

    .btn-opto { background: #6a1b9a; color: white; }
    .btn-opto:hover { background: #4a148c; }
  </style>
</head>
<body>
  
<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-content">
    <h2>Men√∫</h2>

    <!-- Selector de sucursal (solo admin) -->
    <div id="sucursal-selector" class="dropdown mb-3" style="display:none;">
      <button class="btn btn-light w-100 dropdown-toggle d-flex align-items-center" 
              type="button" data-bs-toggle="dropdown" aria-expanded="false" 
              id="sucursalBtn">
        <i class="material-icons me-2">business</i> 
        <span id="sucursalTexto">Sucursal</span>
      </button>
      <ul class="dropdown-menu w-100">
        <li><a class="dropdown-item" href="#" onclick="cambiarSucursal('admin')">Admin</a></li>
        <li><a class="dropdown-item" href="#" onclick="cambiarSucursal('Reynosa')">Reynosa</a></li>
        <li><a class="dropdown-item" href="#" onclick="cambiarSucursal('Yucatan')">Yucat√°n</a></li>
        <li><a class="dropdown-item" href="#" onclick="cambiarSucursal('Monterrey')">Monterrey</a></li>
      </ul>
    </div>

    <!-- Enlaces del men√∫ -->
    <div id="menu-dinamico"></div>
  </div>
</div>

<!-- MAIN (fuera del sidebar) -->
<div class="main" id="main-content">
  <h1>Cargando...</h1>
</div>


  <!-- MODAL √ìRDENES Y OPTOMETR√çA -->
  <div class="modal fade" id="modalOrdenes" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">√ìrdenes del Paciente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div id="contenedorOrdenes"></div>
        </div>
        <div class="modal-footer">
          <span class="small-muted me-auto">Se muestra primero el registro m√°s reciente.</span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

   <!-- BOOTSTRAP SCRIPTS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
 

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// üîπ Mapa de equivalencias m√≥dulo ‚Üí id del men√∫
const mapaMenus = {
  expedientes: "menuExpedientes",
  optometria: "menuOptometria",
  recibos: "menuRecibos",   // üëà corregido a plural
  medico: "menuMedico",
  agenda: "menuAgenda",
  ordenes: "menuOrdenes",
  insumos: "menuInsumos",
  cierre: "menuCierre",
  usuarios: "menuUsuarios",
  Asignaci√≥n: "menuAsignacion"
};


// Sesi√≥n (Inicio)
fetch('/api/check-session')
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(async data => {
    if (data.usuario) {
      window.usuarioRol = data.usuario.rol;

     // Mostrar selector solo si es admin
      if (data.usuario.rol === "admin") {
        document.getElementById("sucursal-selector").style.display = "block";
      }

      // Construir men√∫ din√°mico seg√∫n el rol
      cargarMenuDinamico(data.usuario);


      // Mostrar la sucursal actual en el bot√≥n
      let sucursalActual;
      if (data.usuario.rol === "admin") {
        sucursalActual = data.usuario.sucursalSeleccionada || "Admin";
      } else {
        sucursalActual = data.usuario.departamento;
      }
      document.getElementById("sucursalTexto").textContent = sucursalActual;

      // Pantalla de bienvenida
      document.getElementById('main-content').innerHTML = `
        <div style="text-align:center; margin-top:40px;">
          <h1>Bienvenido</h1>
          <p>Selecciona una opci√≥n del men√∫.</p>
          <div style="margin-top:80px; text-align:left;">
            <img src="../uploads/logo-oftavision.png" 
                alt="Instituto Oftavisi√≥n" 
                style="max-width:900px; display:block; margin:0 auto;">
          </div>
        </div>
      `;
    }
  })
  .catch(() => window.location.href = '/login/login.html');


// Router simple
async function mostrarSeccion(seccion){
  const main = document.getElementById('main-content');
  const paginas = {
  recibos: "/frontend/recibos.html",   // üëà corregido a plural
  cierre: "/frontend/cierre-caja.html",
  expedientes: "/frontend/expedientes.html",
  medico: "/frontend/medico.html",
  ordenes: "/frontend/ordenes.html",
  optometria: "/frontend/optometria.html",
  insumos: "/frontend/insumos.html",
  usuarios: "/frontend/admin/usuarios.html",
  agenda: "/frontend/A_Quirurgica.html",
  Asignaci√≥n: "/frontend/A_modulos.html"
};


  if(seccion === 'expedientes'){
    main.innerHTML = `
      <h2>Gesti√≥n de Expedientes</h2>
      <div class="d-flex justify-content-between mb-3">
        <input type="text" id="buscarExp" class="form-control w-50" placeholder="Buscar por nombre o n√∫mero">
        <button class="btn btn-primary" id="btnNuevo">Nuevo Expediente</button>
      </div>
      <div id="formulario-expediente" style="display:none;"></div>
      <div id="lista-expedientes"></div>
    `;
    document.getElementById('btnNuevo').addEventListener('click', () => {
      document.getElementById('lista-expedientes').style.display = 'none';
      mostrarFormulario();
    });
    document.getElementById('buscarExp').addEventListener('input', filtrarLista);
    cargarLista();
  }else if(paginas[seccion]){
    main.innerHTML = `<iframe src="${paginas[seccion]}"></iframe>`;
  }else{
    main.innerHTML = `<h2>${seccion}</h2><p>Contenido de ${seccion} aqu√≠...</p>`;
  }
}

// Expedientes
function mostrarFormulario(expediente=null){
  const cont = document.getElementById('formulario-expediente');
  cont.style.display='block';
  cont.innerHTML = `
    <form id="form-expediente">
      <div class="mb-2">
        <label>N√∫mero de Expediente:</label>
        <input type="text" id="num_expediente" class="form-control" readonly>
      </div>
      <div class="mb-2"><label>Nombre:</label>
        <input type="text" id="nombre" class="form-control" required></div>
      <div class="mb-2"><label>Fecha de Nacimiento:</label>
        <input type="date" id="fecha_nac" class="form-control" required></div>
      <div class="mb-2"><label>Edad:</label>
        <input type="number" id="edad" class="form-control" readonly></div>
      <div class="mb-2"><label>Padecimiento:</label>
        <select id="padecimiento" class="form-select" required>
          <option value="">Seleccione...</option>
          <option value="DIABETES">DIABETES</option>
          <option value="HIPERTENSO">HIPERTENSO</option>
          <option value="NINGUNO">NINGUNO</option>
        </select>
      </div>
      <div class="mb-2"><label>Colonia:</label>
        <input type="text" id="colonia" class="form-control"></div>
      <div class="mb-2"><label>Ciudad:</label>
        <input type="text" id="ciudad" class="form-control"></div>
      <div class="mb-2"><label>Tel√©fono 1:</label>
        <input type="text" id="telefono1" class="form-control"></div>
      <div class="mb-2"><label>Tel√©fono 2:</label>
        <input type="text" id="telefono2" class="form-control"></div>
      <button type="submit" class="btn btn-success">Guardar</button>
      <button type="button" class="btn btn-secondary" onclick="cancelarFormulario()">Cancelar</button>
    </form>
  `;

  fetch('/api/expedientes').then(r=>r.json()).then(arr=>{
    const siguiente = expediente
      ? expediente.numero_expediente
      : (arr.length>0 ? arr[arr.length-1].numero_expediente+1 : 1).toString().padStart(4,'0');
    document.getElementById('num_expediente').value = siguiente;
  });

  if(expediente){
    document.getElementById('form-expediente').dataset.editando = true;
    document.getElementById('nombre').value = expediente.nombre_completo;
    if(expediente.fecha_nacimiento){
      const f = new Date(expediente.fecha_nacimiento);
      const yyyy=f.getFullYear(), mm=String(f.getMonth()+1).padStart(2,'0'), dd=String(f.getDate()).padStart(2,'0');
      document.getElementById('fecha_nac').value = `${yyyy}-${mm}-${dd}`;
    }
    document.getElementById('edad').value = expediente.edad;
    document.getElementById('padecimiento').value = expediente.padecimientos;
    document.getElementById('colonia').value = expediente.colonia;
    document.getElementById('ciudad').value = expediente.ciudad;
    document.getElementById('telefono1').value = expediente.telefono1;
    document.getElementById('telefono2').value = expediente.telefono2;
  }else{
    document.getElementById('form-expediente').dataset.editando = '';
  }

  document.getElementById('fecha_nac').addEventListener('change', ()=>{
    const f = new Date(document.getElementById('fecha_nac').value);
    if(!isNaN(f)){
      const hoy = new Date();
      let edad = hoy.getFullYear()-f.getFullYear();
      const m = hoy.getMonth()-f.getMonth();
      if(m<0 || (m===0 && hoy.getDate()<f.getDate())) edad--;
      document.getElementById('edad').value = edad;
    }
  });

  document.getElementById('form-expediente').addEventListener('submit', guardarExpediente);
}

function cancelarFormulario(){
  document.getElementById('formulario-expediente').style.display='none';
  document.getElementById('lista-expedientes').style.display='block';
}

async function guardarExpediente(e){
  e.preventDefault();
  const id = document.getElementById('num_expediente').value;
  const nombre = document.getElementById('nombre').value;
  const fecha_nacimiento = document.getElementById('fecha_nac').value;

  let metodo='POST', url='/api/expedientes';
  const edicion = !!document.getElementById('form-expediente').dataset.editando;

  if(edicion){
    metodo='PUT'; url=`/api/expedientes/${id}`;
  }else{
    const chk = await fetch(`/api/expedientes/check?nombre=${encodeURIComponent(nombre)}&fecha_nacimiento=${fecha_nacimiento}`);
    const existe = await chk.json();
    if(existe.existe){
      Swal.fire({
        icon: 'warning',
        title: 'Duplicado',
        text: 'El expediente ya existe'
      });
      return;
    }
  }

  const data = {
    nombre_completo:nombre, fecha_nacimiento,
    edad:document.getElementById('edad').value,
    padecimientos:document.getElementById('padecimiento').value,
    colonia:document.getElementById('colonia').value,
    ciudad:document.getElementById('ciudad').value,
    telefono1:document.getElementById('telefono1').value,
    telefono2:document.getElementById('telefono2').value
  };

  const res = await fetch(url,{method:metodo,headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  const json = await res.json();

  if(res.ok){
    Swal.fire({
      icon: 'success',
      title: edicion ? 'Expediente actualizado' : 'Expediente creado',
      text: json.mensaje || `N√∫mero: ${json.expediente?.numero_expediente}`
    });
    cancelarFormulario(); 
    cargarLista();
  }else{
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: json.error || 'No se pudo guardar el expediente'
    });
  }
}

async function cargarMenuDinamico(usuario) {
  const cont = document.getElementById("menu-dinamico");
  cont.innerHTML = "";

  // Si es admin ‚Üí ve todos
  if (usuario.rol === "admin") {
  const modulosAdmin = [
    { id:"expedientes", icon:"folder", texto:"Expedientes" },
    { id:"optometria", icon:"visibility", texto:"Optometr√≠a" },
    { id:"recibos", icon:"receipt", texto:"Recibos" }, // üëà plural
    { id:"medico", icon:"local_hospital", texto:"M√≥dulo M√©dico" },
    { id:"agenda", icon:"event", texto:"Agenda Quir√∫rgica" },
    { id:"ordenes", icon:"assignment", texto:"√ìrdenes" },
    { id:"insumos", icon:"inventory_2", texto:"Insumos" },
    { id:"cierre", icon:"attach_money", texto:"Cierre de Caja" },
    { id:"Asignaci√≥n", icon:"bar_chart", texto:"Asignaci√≥n de M√≥dulos" },
    { id:"usuarios", icon:"person_add", texto:"Usuarios" }
  ];

    modulosAdmin.forEach(m => {
      cont.innerHTML += `
        <a href="#" data-modulo="${m.id}" onclick="mostrarSeccion('${m.id}')">
          <i class="material-icons">${m.icon}</i> ${m.texto}
        </a>`;
    });
  } else {
    // Si no es admin ‚Üí pedir permisos
    const resPerm = await fetch(`/api/permisos/${usuario.nomina}`);
    const permisos = await resPerm.json();
    permisos.forEach(p => {
      if (p.permitido) {
        let mapa = {
          expedientes: { icon:"folder", texto:"Expedientes" },
          optometria: { icon:"visibility", texto:"Optometr√≠a" },
          recibos: { icon:"receipt", texto:"Recibos" }, // üëà plural
          medico: { icon:"local_hospital", texto:"M√≥dulo M√©dico" },
          agenda: { icon:"event", texto:"Agenda Quir√∫rgica" },
          ordenes: { icon:"assignment", texto:"√ìrdenes" },
          insumos: { icon:"inventory_2", texto:"Insumos" },
          cierre: { icon:"attach_money", texto:"Cierre de Caja" }
        };

        if (mapa[p.modulo]) {
          cont.innerHTML += `
            <a href="#" data-modulo="${p.modulo}" onclick="mostrarSeccion('${p.modulo}')">
              <i class="material-icons">${mapa[p.modulo].icon}</i> ${mapa[p.modulo].texto}
            </a>`;
        }
      }
    });
  }

  // Siempre agregar logout al final
  cont.innerHTML += `
    <a href="/api/logout" class="text-danger d-flex align-items-center mt-3 border-top pt-2">
      <i class="material-icons">exit_to_app</i>
      <span class="ms-2">Cerrar Sesi√≥n</span>
    </a>`;
}




function cargarLista(){
  fetch('/api/expedientes').then(r=>r.json()).then(data=>{
    let html = `<table class="table table-bordered align-middle">
      <thead>
        <tr>
          <th>N√∫mero</th><th>Nombre</th><th>Edad</th><th>Padecimiento</th>
          <th>Ciudad</th><th>Tel√©fono 1</th><th>Tel√©fono 2</th><th>Acciones</th>
        </tr>
      </thead><tbody>`;
    data.forEach(exp=>{
      html += `<tr>
        <td>${exp.numero_expediente}</td>
        <td>${exp.nombre_completo}</td>
        <td>${exp.edad}</td>
        <td>${exp.padecimientos}</td>
        <td>${exp.ciudad}</td>
        <td>${exp.telefono1}</td>
        <td>${exp.telefono2 || ''}</td>
        <td>
          <button class="btn-editar" onclick='editarExpediente(${JSON.stringify(exp)})'>Editar</button>
          <button class="btn-medico" onclick="verOrdenes(${exp.numero_expediente}, '${exp.nombre_completo.replace(/'/g,"\\'")}')">M√©dico</button>
          <button class="btn-opto" onclick="verOptometria(${exp.numero_expediente}, '${exp.nombre_completo.replace(/'/g,"\\'")}')">Optometr√≠a</button>
          ${window.usuarioRol === "admin" 
              ? `<button class="btn btn-danger" onclick="eliminarExpediente(${exp.numero_expediente})">Eliminar</button>` 
              : "" }
        </td>

      </tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById('lista-expedientes').innerHTML = html;
  });
}

function editarExpediente(exp){ document.getElementById('lista-expedientes').style.display='none'; mostrarFormulario(exp); }
function filtrarLista(){
  const f = document.getElementById('buscarExp').value.toLowerCase();
  document.querySelectorAll('#lista-expedientes tbody tr').forEach(row=>{
    row.style.display = row.innerText.toLowerCase().includes(f) ? '' : 'none';
  });
}

// ---------- Modal: Ver todas las √≥rdenes ----------
async function verOrdenes(expedienteId, nombrePaciente=''){
  try{
    const res = await fetch(`/api/expedientes/${expedienteId}/ordenes`);
    const ordenes = await res.json();

    const cont = document.getElementById('contenedorOrdenes');
    const titulo = document.querySelector('#modalOrdenes .modal-title');
    titulo.textContent = `√ìrdenes de ${nombrePaciente || 'Paciente'} (Expediente ${expedienteId})`;

    if(!Array.isArray(ordenes) || ordenes.length===0){
      cont.innerHTML = `<div class="alert alert-warning mb-0">Este paciente a√∫n no tiene √≥rdenes m√©dicas.</div>`;
    }else{
      let contenido = "";
      ordenes.forEach((orden, idx) => {
        contenido += `
          <h4 class="mt-3">Orden #${orden.numero_orden} ${idx===0 ? '(M√°s reciente)' : ''}</h4>
          <table class="table table-bordered table-sm">
            <tr><th>N√∫mero de Orden</th><td>${orden.numero_orden}</td></tr>
            <tr><th>M√©dico</th><td>${orden.medico}</td></tr>
            <tr><th>Diagn√≥stico</th><td>${orden.diagnostico}</td></tr>
            <tr><th>Lado</th><td>${orden.lado}</td></tr>
            <tr><th>Procedimiento</th><td>${orden.procedimiento}</td></tr>
            <tr><th>Precio</th><td>$${parseFloat(orden.precio||0).toFixed(2)}</td></tr>
            <tr><th>Estatus</th><td>${orden.estatus || 'Pendiente'}</td></tr>
            <tr><th>Fecha</th><td>${new Date(orden.fecha).toLocaleString()}</td></tr>
          </table>
          <h5 class="mt-3">Exploraci√≥n Cl√≠nica</h5>
          <table class="table table-striped table-sm">
            <tr><th>Anexos</th><td>${orden.anexos || ''}</td></tr>
            <tr><th>Conjuntiva</th><td>${orden.conjuntiva || ''}</td></tr>
            <tr><th>C√≥rnea</th><td>${orden.cornea || ''}</td></tr>
            <tr><th>C√°mara Anterior</th><td>${orden.camara_anterior || ''}</td></tr>
            <tr><th>Cristalino</th><td>${orden.cristalino || ''}</td></tr>
            <tr><th>Retina</th><td>${orden.retina || ''}</td></tr>
            <tr><th>M√°cula</th><td>${orden.macula || ''}</td></tr>
            <tr><th>Nervio √ìptico</th><td>${orden.nervio_optico || ''}</td></tr>
            <tr><th>Ciclopej√≠a</th><td>${orden.ciclopejia || ''}</td></tr>
            <tr><th>Hora T.P.</th><td>${orden.hora_tp || ''}</td></tr>
            <tr><th>Problemas Identificados</th><td>${orden.problemas || ''}</td></tr>
            <tr><th>Plan</th><td>${orden.plan || ''}</td></tr>
          </table>
          <hr/>
        `;
      });

      cont.innerHTML = contenido;
    }

    const modal = new bootstrap.Modal(document.getElementById('modalOrdenes'));
    modal.show();
  }catch(err){
    console.error('Error al cargar √≥rdenes:', err);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudieron cargar las √≥rdenes de este paciente'
    });
  }
}

// ---------- Modal: Ver evaluaciones de optometr√≠a ----------
async function verOptometria(expedienteId, nombrePaciente=''){
  try{
    const res = await fetch(`/api/expedientes/${expedienteId}/optometria`);
    const evaluaciones = await res.json();

    const cont = document.getElementById('contenedorOrdenes');
    const titulo = document.querySelector('#modalOrdenes .modal-title');
    titulo.textContent = `Optometr√≠a de ${nombrePaciente || 'Paciente'} (Expediente ${expedienteId})`;

    if(!Array.isArray(evaluaciones) || evaluaciones.length===0){
      cont.innerHTML = `<div class="alert alert-warning mb-0">Este paciente a√∫n no tiene evaluaciones de optometr√≠a.</div>`;
    }else{
      let contenido = "";
      evaluaciones.forEach((opto, idx) => {
        contenido += `
          <h4 class="mt-3">Evaluaci√≥n #${opto.id} ${idx===0 ? '(M√°s reciente)' : ''}</h4>
          <table class="table table-bordered table-sm">
            <tr><th>OD Esfera</th><td>${opto.esfera_od || ''}</td></tr>
            <tr><th>OD Cilindro</th><td>${opto.cilindro_od || ''}</td></tr>
            <tr><th>OD Eje</th><td>${opto.eje_od || ''}</td></tr>
            <tr><th>OI Esfera</th><td>${opto.esfera_oi || ''}</td></tr>
            <tr><th>OI Cilindro</th><td>${opto.cilindro_oi || ''}</td></tr>
            <tr><th>OI Eje</th><td>${opto.eje_oi || ''}</td></tr>
            <tr><th>BMP</th><td>${opto.bmp || ''}</td></tr>
            <tr><th>F.O</th><td>${opto.fo || ''}</td></tr>
            <tr><th>Fecha</th><td>${new Date(opto.fecha).toLocaleString()}</td></tr>
          </table>
          <hr/>
        `;
      });
      cont.innerHTML = contenido;
    }

    const modal = new bootstrap.Modal(document.getElementById('modalOrdenes'));
    modal.show();
  }catch(err){
    console.error('Error al cargar optometr√≠a:', err);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudieron cargar las evaluaciones de optometr√≠a'
    });
  }
}

// ---------- Funci√≥n para cambiar sucursal (solo admin) ----------
async function cambiarSucursal(nombreSucursal) {
  try {
    const res = await fetch('/api/set-departamento', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ departamento: nombreSucursal })
    });

    const data = await res.json();

    if (res.ok) {
      // üëá Actualizar el texto del bot√≥n en el men√∫ lateral
      const sucursalTexto = document.getElementById("sucursalTexto");
      if (sucursalTexto) {
        sucursalTexto.textContent = (nombreSucursal === "admin") ? "Admin" : nombreSucursal;
      }

      if (nombreSucursal === "admin") {
        // Si es admin, mostrar dashboard sin recargar
        document.getElementById('main-content').innerHTML = `
          <div style="text-align:center; margin-top:40px;">
            <h1>Bienvenido</h1>
            <p>Selecciona una opci√≥n del men√∫.</p>
            <div style="margin-top:80px;">
              <img src="../uploads/logo-oftavision.png" 
                  alt="Instituto Oftavisi√≥n" 
                  style="max-width:900px; display:block; margin:0 auto;">
            </div>
          </div>
        `;
      } else {
        // ‚úÖ Cambiar sucursal al vuelo con logo incluido
        document.getElementById('main-content').innerHTML = `
          <div style="text-align:center; margin-top:40px;">
            <h1>Bienvenido a ${nombreSucursal}</h1>
            <p>Selecciona una opci√≥n del men√∫.</p>
            <div style="margin-top:80px;">
              <img src="../uploads/logo-oftavision.png" 
                  alt="Instituto Oftavisi√≥n" 
                  style="max-width:900px; display:block; margin:0 auto;">
            </div>
          </div>
        `;
      }
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: data.error || "Error al cambiar sucursal"
      });
    }
  } catch (err) {
    console.error("Error cambiando sucursal:", err);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'Error en la conexi√≥n con el servidor'
    });
  }
}

// ---------- Funci√≥n para eliminar expediente ----------
async function eliminarExpediente(id){
  const confirmacion = await Swal.fire({
    title: '¬øEst√°s seguro?',
    text: 'Esto eliminar√° el expediente permanentemente',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'S√≠, eliminar'
  });

  if(confirmacion.isConfirmed){
    const res = await fetch(`/api/expedientes/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if(res.ok){
      Swal.fire('Eliminado', data.mensaje, 'success');
      cargarLista();
    }else{
      Swal.fire('Error', data.error || 'No se pudo eliminar', 'error');
    }
  }
}


</script>